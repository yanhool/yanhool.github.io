<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>golangå­¦ä¹ ç¬”è®° | Yanhoolçš„å°ç«™</title><meta name="keywords" content="golang"><meta name="author" content="YanhoolğŸ¥"><meta name="copyright" content="YanhoolğŸ¥"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ğŸ¥§æœ¬æ–‡è®²è¿°golangåŸºç¡€çŸ¥è¯†ç‚¹">
<meta property="og:type" content="article">
<meta property="og:title" content="golangå­¦ä¹ ç¬”è®°">
<meta property="og:url" content="https://yanhool.github.io/posts/20230411d.html">
<meta property="og:site_name" content="Yanhoolçš„å°ç«™">
<meta property="og:description" content="ğŸ¥§æœ¬æ–‡è®²è¿°golangåŸºç¡€çŸ¥è¯†ç‚¹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.fomal.cc/img/default_cover_14.webp">
<meta property="article:published_time" content="2023-04-11T01:19:03.000Z">
<meta property="article:modified_time" content="2023-04-14T13:08:00.000Z">
<meta property="article:author" content="YanhoolğŸ¥">
<meta property="article:tag" content="golang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.fomal.cc/img/default_cover_14.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://yanhool.github.io/posts/20230411d"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'golangå­¦ä¹ ç¬”è®°',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-14 21:08:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Yanhoolçš„å°ç«™" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/03/15/7fe09314144640688474a5910834ff5f" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> æ—¶å…‰è¿‡å®¢</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/time/set/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆè®¢æœ¬</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Yanhoolçš„å°ç«™</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> æ—¶å…‰è¿‡å®¢</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/time/set/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆè®¢æœ¬</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">golangå­¦ä¹ ç¬”è®°</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2023-04-11T01:19:03.000Z" title="å‘è¡¨äº 2023-04-11 09:19:03">2023-04-11</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-04-14T13:08:00.000Z" title="æ›´æ–°äº 2023-04-14 21:08:00">2023-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/golang/">golang</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2.6w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>95åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="golangå­¦ä¹ ç¬”è®°"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>golangå­¦ä¹ ç¬”è®°</h1>
<h2 id="1-golangå¹¶å‘">1. golangå¹¶å‘</h2>
<h3 id="1-1-æ¦‚è¿°">1.1 æ¦‚è¿°</h3>
<p><strong>è¿›ç¨‹å’Œçº¿ç¨‹</strong></p>
<ul>
<li>è¿›ç¨‹å°±æ˜¯è¿è¡Œç€çš„ç¨‹åºï¼Œå®ƒæ˜¯ç¨‹åºåœ¨æ“ä½œç³»ç»Ÿçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªç¨‹åºçš„åŠ¨æ€æ¦‚å¿µï¼Œè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿ<strong>åˆ†é…</strong>èµ„æºçš„åŸºæœ¬å•ä½</li>
<li>çº¿ç¨‹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œå®ä½“ï¼Œå®ƒæ˜¯æ¯”è¿›ç¨‹åŠ›åº¦æ›´å°çš„æ‰§è¡Œå•å…ƒï¼Œä¹Ÿæ˜¯çœŸæ­£è¿è¡Œåœ¨cpuä¸Šçš„æ‰§è¡Œå•å…ƒï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿ<strong>è°ƒåº¦</strong>èµ„æºçš„åŸºæœ¬å•ä½</li>
</ul>
<p>è¿›ç¨‹ä¸­å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œéœ€è¦è®°ä½è¿›ç¨‹å’Œçº¿ç¨‹ä¸€ä¸ªæ˜¯æ“ä½œç³»ç»Ÿ<strong>åˆ†é…</strong>èµ„æºçš„åŸºæœ¬å•ä½(è¿›ç¨‹)ï¼Œä¸€ä¸ªæ˜¯æ“ä½œç³»ç»Ÿ<strong>è°ƒåº¦</strong>èµ„æºçš„åŸºæœ¬å•ä½(çº¿ç¨‹)</p>
<p><strong>åç¨‹</strong></p>
<p>åç¨‹å¯ä»¥ç†è§£ä¸ºç”¨æˆ·æ€çº¿ç¨‹ï¼Œæ˜¯æ›´å¾®é‡çº§çš„çº¿ç¨‹ã€‚åŒºåˆ«äºçº¿ç¨‹ï¼ˆåœ¨å†…æ ¸æ€è°ƒåº¦ï¼‰ï¼Œåç¨‹çš„è°ƒåº¦åœ¨ç”¨æˆ·æ€è¿›è¡Œï¼Œä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œæ‰€ä»¥ä¸ç”±æ“ä½œç³»ç»Ÿå‚ä¸ï¼Œç”±ç”¨æˆ·è‡ªå·±æ§åˆ¶ã€‚</p>
<ul>
<li>åç¨‹æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œä½†æ˜¯å…±äº«å †ç©ºé—´ã€‚</li>
<li>ä¸€ä¸ªè¿›ç¨‹ä¸Šå¯ä»¥è·‘å¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸Šå¯ä»¥è·‘å¤šä¸ªåç¨‹</li>
</ul>
<p><strong>å¹¶å‘ä¸å¹¶è¡Œ</strong></p>
<p>åŒæ—¶è¿è¡Œå°±æ˜¯å¹¶è¡Œ</p>
<p>ä¸èƒ½åŒæ—¶è¿è¡Œäº¤å‰æ‰§è¡Œæ˜¯å¹¶å‘</p>
<h3 id="1-2-Goroutine">1.2 Goroutine</h3>
<p>ä¸€ä¸ªgoroutineæ ˆåœ¨å…¶ç”Ÿå‘½å‘¨æœŸå¼€å§‹æ—¶å ç”¨ç©ºé—´å¾ˆå°ï¼ˆä¸€èˆ¬2KBï¼‰ï¼Œå¹¶ä¸”æ ˆå¤§å°å¯ä»¥æŒ‰éœ€å¢å¤§å’Œç¼©å°ï¼Œgoroutineçš„æ ˆå¤§å°é™åˆ¶å¯ä»¥è¾¾åˆ°1GBã€‚Goç¨‹åºä¼šä¸ºmain()å‡½æ•°åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„goroutineï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸»åç¨‹ï¼Œæˆ‘ä»¬åæ¥äººä¸ºçš„åˆ›å»ºçš„ä¸€äº›goroutineï¼Œéƒ½æ˜¯åœ¨è¿™ä¸ªä¸»goroutineçš„åŸºç¡€ä¸Šè¿›è¡Œçš„ã€‚</p>
<p>ç”¨recoveræ•è·å¼‚å¸¸æ—¶ï¼Œåªèƒ½æ•è·å½“å‰goroutineçš„panicï¼Œä¸èƒ½æ•è·å…¶ä»–goroutineå‘ç”Ÿçš„panicã€‚</p>
<h3 id="1-3-Channel">1.3 Channel</h3>
<p>channelä¿è¯ä¸åŒçš„goroutineä¹‹é—´èƒ½å¤Ÿé€šä¿¡</p>
<p>channelçš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> channel_name <span class="keyword">chan</span> channel_type</span><br><span class="line"><span class="keyword">var</span> channel_name [size]<span class="keyword">chan</span> channel_type  <span class="comment">// å£°æ˜ä¸€ä¸ªchannelï¼Œå…¶å®¹é‡å¤§å°ä¸ºsize</span></span><br></pre></td></tr></table></figure>
<p>å£°æ˜ä¹‹åçš„ç®¡é“ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ä¸ºå…¶åˆ†é…ç©ºé—´ï¼Œå…¶å€¼æ˜¯nilï¼Œæˆ‘ä»¬è¦ä½¿ç”¨è¿˜è¦é…åˆmakeå‡½æ•°æ¥å¯¹å…¶åˆå§‹åŒ–ï¼Œä¹‹åæ‰å¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨è¯¥ç®¡é“ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">channel_name = <span class="built_in">make</span>(<span class="keyword">chan</span> channel_type)</span><br><span class="line">channel_name = <span class="built_in">make</span>(<span class="keyword">chan</span> channel_type, size)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥ä¸€æ­¥å®Œæˆ</span></span><br><span class="line">channel_name := <span class="built_in">make</span>(<span class="keyword">chan</span> channel_type)</span><br><span class="line">channel_name := <span class="built_in">make</span>(<span class="keyword">chan</span> channel_type, size)  <span class="comment">//åˆ›å»ºå¸¦æœ‰ç¼“å­˜çš„ç®¡é“ï¼Œsizeä¸ºç¼“å­˜å¤§å°</span></span><br></pre></td></tr></table></figure>
<p>ä¼ é€’æ•°æ®ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)         <span class="comment">// åˆ›å»ºä¸€ä¸ªç®¡é“ch</span></span><br><span class="line">ch &lt;- v                      <span class="comment">// å‘ç®¡é“chä¸­å‘é€æ•°æ®v.</span></span><br><span class="line">v := &lt;-ch                    <span class="comment">// ä»ç®¡é“ä¸­è¯»å–æ•°æ®å­˜å‚¨åˆ°å˜é‡v</span></span><br><span class="line"><span class="built_in">close</span>(ch)                    <span class="comment">// å…³é—­ç®¡é“ch ç®¡é“ç”¨å®Œäº†ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå…³é—­ï¼Œé¿å…ç¨‹åºä¸€ç›´åœ¨ç­‰å¾…ä»¥åŠèµ„æºçš„æµªè´¹ã€‚ä½†æ˜¯å…³é—­çš„ç®¡é“ï¼Œä»ç„¶å¯ä»¥ä»ä¸­æ¥æ”¶æ•°æ®ï¼Œåªæ˜¯æ¥æ”¶åˆ°çš„çš„æ•°æ®æ°¸è¿œæ˜¯é›¶å€¼ã€‚</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦å¾€é‡Œé¢å†™å…¥é›¶å€¼ï¼Œç”¨å¦ä¸€ä¸ªgoroutineè¯»å–ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±æ— æ³•åŒºåˆ†è¯»å–åˆ°çš„æ˜¯æ­£ç¡®çš„é›¶å€¼è¿˜æ˜¯æ•°æ®å·²ç»è¯»å»å®Œäº†è€Œè¯»å–åˆ°çš„é›¶å€¼ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ç”¨ä»¥ä¸‹ä¸¤ç§å¸¸ç”¨çš„è¯»å–æ–¹å¼ï¼š</p>
<p>åˆ¤å®šè¯»å–</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v,ok := &lt;-ch     <span class="comment">// åˆ¤æ–­å¥å¼è¯»å–</span></span><br></pre></td></tr></table></figure>
<p>For rangeè¯»å–</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;v=%d\n&quot;</span>, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>channelæ ¹æ®å…¶åŠŸèƒ½åˆå¯ä»¥åˆ†ä¸ºåŒå‘channelå’Œå•å‘channelï¼ŒåŒå‘channelå³å¯å‘é€æ•°æ®åˆå¯æ¥æ”¶æ•°æ®ï¼Œå•å‘channelè¦ä¹ˆåªèƒ½å‘é€æ•°æ®ï¼Œè¦ä¹ˆåªèƒ½æ¥æ”¶æ•°æ®ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å•å‘è¯»channel</span></span><br><span class="line"><span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">type</span> RChannel= &lt;-<span class="keyword">chan</span> <span class="type">int</span>    <span class="comment">// å®šä¹‰ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> rec RChannel = ch</span><br><span class="line"><span class="comment">// å®šä¹‰å•å‘å†™channel</span></span><br><span class="line"><span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">type</span> SChannel = <span class="keyword">chan</span>&lt;- <span class="type">int</span>  <span class="comment">// å®šä¹‰ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> send SChannel = ch</span><br></pre></td></tr></table></figure>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SChannel = <span class="keyword">chan</span>&lt;- <span class="type">int</span></span><br><span class="line"><span class="keyword">type</span> RChannel = &lt;-<span class="keyword">chan</span> <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)  <span class="comment">//  åˆ›å»ºchannel</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> send SChannel = ch</span><br><span class="line">        fmt.Println(<span class="string">&quot;send: 100&quot;</span>)</span><br><span class="line">        send &lt;- <span class="number">100</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> rec RChannel = ch</span><br><span class="line">        num := &lt;- rec </span><br><span class="line">        fmt.Printf(<span class="string">&quot;receive: %d&quot;</span>, num)</span><br><span class="line">    &#125;()</span><br><span class="line">    time.Sleep(<span class="number">2</span>*time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªchannel chï¼Œåˆ†åˆ«å®šä¹‰ä¸¤ä¸ªå•å‘channelç±»å‹SChannel å’ŒRChannel ï¼Œæ ¹æ®åˆ«åç±»å‹ç»™chå®šä¹‰ä¸¤ä¸ªåˆ«åsendå’Œrecï¼Œä¸€ä¸ªåªç”¨äºå‘é€ï¼Œä¸€ä¸ªåªç”¨äºè¯»å–</p>
<p>Golangä¸­æœ‰ä¸ªé‡è¦æ€æƒ³ï¼š<strong>ä¸ä»¥å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œä»¥é€šä¿¡æ¥å…±äº«å†…å­˜</strong>ã€‚è¯´å¾—æ›´ç›´æ¥ç‚¹ï¼Œåç¨‹ä¹‹é—´å¯ä»¥åˆ©ç”¨Channelæ¥ä¼ é€’æ•°æ®</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(s []<span class="type">int</span>, c <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	sum := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">		sum += v</span><br><span class="line">	&#125;</span><br><span class="line">	c &lt;- sum <span class="comment">// send sum to c</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := []<span class="type">int</span>&#123;<span class="number">7</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">-9</span>, <span class="number">4</span>, <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">go</span> sum(s[:<span class="built_in">len</span>(s)/<span class="number">2</span>], c)</span><br><span class="line">	<span class="comment">//time.Sleep(1 * time.Second)</span></span><br><span class="line">	<span class="keyword">go</span> sum(s[<span class="built_in">len</span>(s)/<span class="number">2</span>:], c)</span><br><span class="line">	x, y := &lt;-c, &lt;-c <span class="comment">// receive from c</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(x, y, x+y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>channel åˆåˆ†ä¸ºä¸¤ç±»ï¼šæœ‰ç¼“å†² channel å’Œæ— ç¼“å†² channel</p>
<p>æ— ç¼“å†² channel å¯ä»¥ç†è§£ä¸ºåŒæ­¥æ¨¡å¼ï¼Œå³å†™å…¥ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹ï¼Œå†™å…¥å°±ä¼šé˜»å¡ã€‚</p>
<p>æœ‰ç¼“å†² channel å¯ä»¥ç†è§£ä¸ºå¼‚æ­¥æ¨¡å¼ã€‚å³å†™å…¥æ¶ˆæ¯ä¹‹åï¼Œå³ä½¿è¿˜æ²¡è¢«æ¶ˆè´¹ï¼Œåªè¦é˜Ÿåˆ—æ²¡æ»¡ï¼Œå°±å¯ç»§ç»­å†™å…¥ã€‚</p>
<p>å½“ç¼“å†²é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œç»§ç»­å¾€channelé‡Œé¢å†™æ•°æ®ï¼Œå°±ä¼šé˜»å¡ï¼Œé‚£ä¹ˆåˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªgoroutineä¹‹é—´çš„é”</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(ch <span class="keyword">chan</span> <span class="type">bool</span>, num *<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">   ch &lt;- <span class="literal">true</span></span><br><span class="line">   *num = *num + <span class="number">1</span></span><br><span class="line">   &lt;-ch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// åˆ›å»ºä¸€ä¸ªsizeä¸º1çš„channel</span></span><br><span class="line">   ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> num <span class="type">int</span></span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">      <span class="keyword">go</span> add(ch, &amp;num)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   time.Sleep(<span class="number">2</span>)</span><br><span class="line">   fmt.Println(<span class="string">&quot;num çš„å€¼ï¼š&quot;</span>, num)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³äºchannelçš„å‡ ç‚¹æ€»ç»“</strong></p>
<ul>
<li>å…³é—­ä¸€ä¸ªæœªåˆå§‹åŒ–çš„ channel ä¼šäº§ç”Ÿ panic</li>
<li>channelåªèƒ½è¢«å…³é—­ä¸€æ¬¡ï¼Œå¯¹åŒä¸€ä¸ªchannelé‡å¤å…³é—­ä¼šäº§ç”Ÿ panic</li>
<li>å‘ä¸€ä¸ªå·²å…³é—­çš„ channel å‘é€æ¶ˆæ¯ä¼šäº§ç”Ÿ panic</li>
<li>ä»ä¸€ä¸ªå·²å…³é—­çš„channelè¯»å–æ¶ˆæ¯ä¸ä¼šå‘ç”Ÿpanicï¼Œä¼šä¸€ç›´è¯»å–åˆ°é›¶å€¼</li>
<li>channelå¯ä»¥è¯»ç«¯å’Œå†™ç«¯éƒ½å¯æœ‰å¤šä¸ªgoroutineæ“ä½œï¼Œåœ¨ä¸€ç«¯å…³é—­channelçš„æ—¶å€™ï¼Œè¯¥channelè¯»ç«¯çš„æ‰€æœ‰goroutine éƒ½ä¼šæ”¶åˆ°channelå·²å…³é—­çš„æ¶ˆæ¯</li>
<li>channelæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œå¤šä¸ªgoroutineåŒæ—¶è¯»å–channelä¸­çš„æ•°æ®ï¼Œä¸ä¼šäº§ç”Ÿå¹¶å‘å®‰å…¨é—®é¢˜</li>
</ul>
<h3 id="1-4-Sync">1.4 Sync</h3>
<p><strong>sync.WaitGroup</strong>æ¥å®ç°å¹¶å‘ä»»åŠ¡çš„åŒæ­¥ä»¥åŠåç¨‹ä»»åŠ¡ç­‰å¾…ã€‚</p>
<p>sync.WaitGroupæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢ç»´æŠ¤è€…ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¹¶ä¸”é€šè¿‡ä¸‰ä¸ªæ–¹æ³•æ¥é…åˆä½¿ç”¨</p>
<ul>
<li>(wg * WaitGroup) Add(delta int)       è®¡æ•°å™¨åŠ delta</li>
<li>(wg *WaitGroup) Done()                    è®¡æ•°å™¨å‡1</li>
<li>(wg *WaitGroup) Wait()                     ä¼šé˜»å¡ä»£ç çš„è¿è¡Œï¼Œç›´è‡³è®¡æ•°å™¨å‡ä¸º0ã€‚</li>
</ul>
<div class="note warning simple"><p>sync.WaitGroupå¯¹è±¡çš„è®¡æ•°å™¨ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œå¦åˆ™ä¼španicï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯add()çš„å‚æ•°å€¼ï¼Œä»¥åŠæ‰§è¡Œå®ŒDone()ä¹‹åè®¡æ•°å™¨å¤§äºç­‰äºé›¶ã€‚</p>
</div>
<p><strong>sync.Once</strong><br>
sync.Onceæœ€å¤§çš„ä½œç”¨å°±æ˜¯å»¶è¿Ÿåˆå§‹åŒ–ï¼Œå¯¹äºä¸€ä¸ªä½¿ç”¨sync.Onceå˜é‡æˆ‘ä»¬å¹¶ä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨çš„å®ƒçš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œå¹¶ä¸”åªåˆå§‹åŒ–è¿™ä¸€æ¬¡ï¼Œåˆå§‹åŒ–ä¹‹åé©»ç•™åœ¨å†…å­˜é‡Œ</p>
<p>ä¸init()çš„åŒºåˆ«</p>
<blockquote>
<p>æœ‰æ—¶å€™æˆ‘ä»¬ä½¿ç”¨init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œinit()æ–¹æ³•æ˜¯åœ¨å…¶æ‰€åœ¨çš„packageé¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œçš„ï¼Œè€Œsync.Oneceå¯ä»¥åœ¨ä»£ç çš„ä»»æ„ä½ç½®åˆå§‹åŒ–å’Œè°ƒç”¨ï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨çš„å®ƒçš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ã€‚</p>
</blockquote>
<p><strong>sync.Lock</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lock sync.Mutex <span class="comment">//äº’æ–¥é”</span></span><br><span class="line"><span class="keyword">var</span> mr sync.RWMutex <span class="comment">//è¯»å†™é”</span></span><br></pre></td></tr></table></figure>
<ol>
<li>åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª goroutine èƒ½å¤Ÿè·å¾—å†™é”å®šã€‚</li>
<li>åŒæ—¶å¯ä»¥æœ‰ä»»æ„å¤šä¸ª gorouinte è·å¾—è¯»é”å®šã€‚</li>
<li>åŒæ—¶åªèƒ½å­˜åœ¨å†™é”å®šæˆ–è¯»é”å®šï¼ˆè¯»å’Œå†™äº’æ–¥ï¼‰ã€‚</li>
</ol>
<p>å¦‚æœå°†å¸¦æœ‰é”ç»“æ„çš„å˜é‡èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œé”çš„çŠ¶æ€ä¼šå¤åˆ¶ã€‚æ‰€ä»¥ç›´æ¥æ‹·è´é”å®¹æ˜“å‘ç”Ÿæ­»é”é—®é¢˜ã€‚</p>
<p><strong>sync.Map</strong></p>
<p>goè¯­è¨€å†…ç½®çš„Mapå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨å¤šä¸ªgoroutineåŒæ—¶æ“ä½œmapçš„æ—¶å€™ï¼Œä¼šæœ‰å¹¶å‘é—®é¢˜</p>
<p>æ‰€ä»¥ç”¨mapå¯ä»¥åŠ é”æˆ–è€…ä½¿ç”¨sync.Map</p>
<p>sync.Map ä¸ç”¨åˆå§‹åŒ–å°±å¯ä»¥ä½¿ç”¨ï¼ŒåŒæ—¶sync.Mapå†…ç½®äº†è¯¸å¦‚Storeã€Loadã€LoadOrStoreã€Deleteã€Rangeç­‰æ“ä½œæ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> m sync.Map</span><br><span class="line">   <span class="comment">// 1. å†™å…¥</span></span><br><span class="line">   m.Store(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">   m.Store(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>)</span><br><span class="line">   <span class="comment">// 2. è¯»å–</span></span><br><span class="line">   age, _ := m.Load(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">   fmt.Println(age.(<span class="type">int</span>))</span><br><span class="line">   <span class="comment">// 3. éå†</span></span><br><span class="line">   m.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;key is:%v, val is:%v\n&quot;</span>, key, value)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="comment">// 4. åˆ é™¤</span></span><br><span class="line">   m.Delete(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">   age, ok := m.Load(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">   fmt.Println(age, ok)</span><br><span class="line">   <span class="comment">// 5. è¯»å–æˆ–å†™å…¥</span></span><br><span class="line">   m.LoadOrStore(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">   name, _ := m.Load(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">   fmt.Println(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>sync.Atomic</strong></p>
<p>åŸå­æ“ä½œå°±æ˜¯è¿™ä¸€ç³»åˆ—çš„æ“ä½œåœ¨cpuä¸Šæ‰§è¡Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œæ˜¾ç„¶è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå—åˆ°å…¶ä»–æ“ä½œçš„å½±å“ï¼Œä¹Ÿå°±ä¸ä¼šå­˜åœ¨å¹¶å‘é—®é¢˜ã€‚</p>
<p>ä½¿ç”¨æ–¹å¼ï¼šé€šå¸¸mutexç”¨äºä¿æŠ¤ä¸€æ®µæ‰§è¡Œé€»è¾‘ï¼Œè€Œatomicä¸»è¦æ˜¯å¯¹å˜é‡è¿›è¡Œæ“ä½œ</p>
<p>åº•å±‚å®ç°ï¼šmutexç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨å®ç°ï¼Œè€Œatomicæ“ä½œæœ‰åº•å±‚ç¡¬ä»¶æŒ‡ä»¤æ”¯æŒï¼Œä¿è¯åœ¨cpuä¸Šæ‰§è¡Œä¸ä¸­æ–­ã€‚æ‰€ä»¥atomicçš„æ€§èƒ½ä¹Ÿèƒ½éšcpuçš„ä¸ªæ•°å¢åŠ çº¿æ€§æå‡</p>
<h3 id="1-5-Select">1.5 Select</h3>
<p>selectæ˜¯goè¯­è¨€å±‚é¢æä¾›çš„ä¸€ç§å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç”¨äºæ£€æµ‹å½“å‰goroutineè¿æ¥çš„å¤šä¸ªchannelæ˜¯å¦æœ‰æ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œå¯ç”¨äºè¯»æˆ–å†™</p>
<h4 id="1-5-1-IOå¤šè·¯å¤ç”¨">1.5.1 IOå¤šè·¯å¤ç”¨</h4>
<p>çœ‹åˆ°selectï¼Œå¾ˆè‡ªç„¶çš„ä¼šè”æƒ³åˆ°linuxæä¾›çš„ioå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œselectã€pollã€epollï¼ŒIOå¤ç”¨ä¸»è¦ç”¨äºæå‡ç¨‹åºå¤„ç†ioäº‹ä»¶çš„æ€§èƒ½ã€‚goè¯­è¨€ä¸­çš„selectä¸linuxä¸­çš„selectæœ‰ä¸€å®šå¾—åŒºåˆ«ã€‚</p>
<p>æ“ä½œç³»ç»Ÿä¸­çš„IOå¤šè·¯å¤ç”¨ç®€å•ç†è§£å°±å°±æ˜¯ç”¨ä¸€ä¸ªæˆ–è€…æ˜¯å°‘é‡çº¿ç¨‹å¤„ç†å¤šä¸ªIOäº‹ä»¶ã€‚</p>
<p>ä¼ ç»Ÿé˜»å¡IOï¼šå¯¹äºæ¯ä¸€ä¸ªç½‘ç»œIOäº‹ä»¶ï¼Œæ“ä½œç³»ç»Ÿéƒ½ä¼šèµ·ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œåœ¨IOäº‹ä»¶æ²¡å‡†å¤‡å¥½çš„æ—¶å€™ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šé€»è¾‘ç®€å•ï¼Œåœ¨é˜»å¡ç­‰å¾…æœŸé—´çº¿ç¨‹ä¼šæŒ‚èµ·ï¼Œä¸ä¼šå ç”¨ CPU èµ„æºã€‚</li>
<li>ç¼ºç‚¹ï¼šæ¯ä¸ªè¿æ¥éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å•ç‹¬å¤„ç†ï¼Œå½“å¹¶å‘è¯·æ±‚é‡å¤§æ—¶ä¸ºäº†ç»´æŠ¤ç¨‹åºï¼Œå†…å­˜ã€çº¿ç¨‹åˆ‡æ¢å¼€é”€è¾ƒå¤§</li>
</ul>
<p>IOå¤šè·¯å¤ç”¨ï¼šä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªIOäº‹ä»¶</p>
<ul>
<li>ä¼˜ç‚¹ï¼šé€šè¿‡å¤ç”¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†äº†å¤šä¸ªIOäº‹ä»¶ï¼Œæ— éœ€å¯¹é¢å¤–è¿‡å¤šçš„çº¿ç¨‹ç»´æŠ¤ç®¡ç†ï¼Œèµ„æºå’Œæ•ˆç‡ä¸Šéƒ½è·å¾—äº†æå‡</li>
<li>ç¼ºç‚¹ï¼šå½“è¿æ¥æ•°è¾ƒå°‘æ—¶æ•ˆç‡ç›¸æ¯”å¤šçº¿ç¨‹+é˜»å¡ I/O æ¨¡å‹æ•ˆç‡è¾ƒä½</li>
</ul>
<h4 id="1-5-2-selectç”¨æ³•">1.5.2 selectç”¨æ³•</h4>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;- channel1:     <span class="comment">// å¦‚æœä»channel1è¯»å–æ•°æ®æˆåŠŸï¼Œæ‰§è¡Œcaseè¯­å¥ </span></span><br><span class="line">          do ...   </span><br><span class="line">        <span class="keyword">case</span> channel2 &lt;- <span class="number">1</span>:   <span class="comment">// å¦‚æœå‘channel2å†™å…¥æ•°æ®æˆåŠŸï¼Œæ‰§è¡Œcaseè¯­å¥ </span></span><br><span class="line">          do ...          </span><br><span class="line">        <span class="keyword">default</span>:              <span class="comment">// å¦‚æœä¸Šé¢éƒ½æ²¡æœ‰æˆåŠŸï¼Œè¿›å…¥defaultå¤„ç†æµç¨‹</span></span><br><span class="line">          do ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// goè¯­è¨€è‡ªå¸¦æ­»é”æ£€æµ‹æœºåˆ¶ï¼Œå‘ç°å½“å‰goroutineæ°¸è¿œä¸ä¼šè¢«å”¤é†’ï¼Œä¼šæŠ¥æ­»é”é”™è¯¯</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">        &#125; <span class="comment">// å½“ä¸€ä¸ªselectä¸­ä»€ä¹ˆè¯­å¥éƒ½æ²¡æœ‰ï¼Œæ²¡æœ‰ä»»ä½•caseï¼Œå°†ä¼šæ°¸ä¹…é˜»å¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æœ‰defaultä¸”caseæ— æ³•æ‰§è¡Œçš„selectæ°¸ä¹…é˜»å¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line">   ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> &lt;-ch1:</span><br><span class="line">      fmt.Printf(<span class="string">&quot;received from ch1&quot;</span>)</span><br><span class="line">   <span class="keyword">case</span> num := &lt;-ch2:</span><br><span class="line">      fmt.Printf(<span class="string">&quot;num is: %d&quot;</span>, num)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note warning simple"><p>å½“å¤šä¸ªcaseéƒ½å‡†å¤‡å¥½äº†çš„æ—¶å€™ï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œ</p>
</div>
<h3 id="1-6-Context">1.6 Context</h3>
<p>contexï¼šä¸Šä¸‹æ–‡ï¼Œä»»ä½•ä¸å®ƒå½“å‰åœºæ™¯æœ‰å…³çš„ä¿¡æ¯éƒ½å¯ä»¥è®¤ä¸ºæ˜¯å®ƒçš„ä¸Šä¸‹æ–‡ç›¸ï¼Œå¯ä»¥ç†è§£ä¸ºç›¸å½“äºä¸€ä¸ªmapç»“æ„ï¼Œé‡Œé¢æ”¾çš„å„ç§æ•°æ®ï¼Œåœ¨è¿™é‡Œæ”¾è¿›å»ï¼Œåœ¨åˆ«çš„åœ°æ–¹æ‹¿å‡ºæ¥ã€‚è¿™å°±æ˜¯contextåŒ…ã€‚</p>
<p>ä½œç”¨ï¼š</p>
<ul>
<li>ç”¨äºå¹¶å‘æ§åˆ¶ï¼Œæ§åˆ¶åç¨‹çš„ä¼˜é›…é€€å‡º</li>
<li>ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ä¼ é€’</li>
</ul>
<p>ç®€å•æ¥è¯´ï¼Œ contextæ˜¯Go è¯­è¨€åœ¨ 1.7 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ä¸€ä¸ªæ ‡å‡†åº“çš„æ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">   Deadline() (deadline time.Time, ok <span class="type">bool</span>) <span class="comment">// è®¾ç½® context.Context è¢«å–æ¶ˆçš„æ—¶é—´ï¼Œå³æˆªæ­¢æ—¶é—´ï¼›</span></span><br><span class="line">   Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// è¿”å›ä¸€ä¸ª Channelï¼Œå½“Contextè¢«å–æ¶ˆæˆ–è€…åˆ°è¾¾æˆªæ­¢æ—¶é—´ï¼Œè¿™ä¸ª Channel å°±ä¼šè¢«å…³é—­ï¼Œè¡¨ç¤ºcontextç»“æŸï¼Œå¤šæ¬¡è°ƒç”¨ Done æ–¹æ³•ä¼šè¿”å›åŒä¸€ä¸ª Channel</span></span><br><span class="line">   Err() <span class="type">error</span> <span class="comment">// è¿”å›ä¸€ä¸ª Channelï¼Œå½“Contextè¢«å–æ¶ˆæˆ–è€…åˆ°è¾¾æˆªæ­¢æ—¶é—´ï¼Œè¿™ä¸ª Channel å°±ä¼šè¢«å…³é—­ï¼Œè¡¨ç¤ºcontextç»“æŸï¼Œå¤šæ¬¡è°ƒç”¨ Done æ–¹æ³•ä¼šè¿”å›åŒä¸€ä¸ª Channel è¢«å–æ¶ˆï¼Œè¿”å› Canceled  è¢«å–æ¶ˆï¼Œè¿”å› Canceled </span></span><br><span class="line">   Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125; <span class="comment">// ä» context.Context ä¸­è·å–é”®å¯¹åº”çš„å€¼ï¼Œç±»ä¼¼äºmapçš„getæ–¹æ³•ï¼Œå¯¹äºåŒä¸€ä¸ªcontextï¼Œå¤šæ¬¡è°ƒç”¨ Value å¹¶ä¼ å…¥ç›¸åŒçš„ Key ä¼šè¿”å›ç›¸åŒçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„key,åˆ™è¿”å›nilï¼Œé”®å€¼å¯¹æ˜¯é€šè¿‡WithValueæ–¹æ³•å†™å…¥çš„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>contextåˆ†ä¸º1ä¸ªæ¥å£ã€4ä¸ªå…·ä½“å®ç°ã€6ä¸ªå‡½æ•°</p>
<p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼åˆ›å»ºæ ¹context</p>
<ul>
<li><code>context.Backgroud()</code></li>
<li><code>context.TODO()</code></li>
</ul>
<p><code>ä»æºä»£ç åˆ†æcontext.Background</code> å’Œ <code>context.TODO</code>å¹¶æ²¡æœ‰å¤ªå¤šçš„åŒºåˆ«ï¼Œéƒ½æ˜¯ç”¨äºåˆ›å»ºæ ¹contextï¼Œæ ¹contextæ˜¯ä¸€ä¸ªç©ºçš„contextï¼Œä¸å…·å¤‡ä»»ä½•åŠŸèƒ½ã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœå½“å‰å‡½æ•°æ²¡æœ‰ä¸Šä¸‹æ–‡ä½œä¸ºå…¥å‚ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ context.Backgroundåˆ›å»ºä¸€ä¸ªæ ¹context ä½œä¸ºèµ·å§‹çš„ä¸Šä¸‹æ–‡å‘ä¸‹ä¼ é€’ã€‚</p>
<p>æ ¹contextåœ¨åˆ›å»ºä¹‹åï¼Œä¸å…·å¤‡ä»»ä½•çš„åŠŸèƒ½ï¼Œä¸ºäº†è®©contextåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­å‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬è¦ä¾é <code>context</code>åŒ…æä¾›çš„<code>With</code>ç³»åˆ—å‡½æ•°æ¥è¿›è¡Œæ´¾ç”Ÿ</p>
<p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ´¾ç”Ÿå‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, deadline time.Time)</span></span> (Context, CancelFunc)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span></span> Context</span><br></pre></td></tr></table></figure>
<p>åŸºäºå½“å‰contextï¼Œæ¯ä¸ªwithå‡½æ•°éƒ½ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„contextï¼Œè¿™æ ·ç±»ä¼¼äºæˆ‘ä»¬ç†Ÿæ‚‰çš„æ ‘ç»“æ„ï¼Œå½“å‰contextç§°ä¸ºçˆ¶contextï¼Œæ´¾ç”Ÿå‡ºçš„æ–°contextç§°ä¸ºå­contextã€‚å°±åƒä¸‹é¢çš„contextæ ‘ç»“æ„ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/11/3cee243c6d3b48edb40df8f9cbe5e00b" alt=""></p>
<p><strong>å¹¶å‘æ§åˆ¶</strong></p>
<p>å¯¹äºä¸€èˆ¬çš„æœåŠ¡å™¨è€Œè¨€ï¼Œéƒ½æ˜¯ä¸€è‡´è¿è¡Œç€çš„ï¼Œç­‰å¾…æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯æˆ–è€…æµè§ˆå™¨çš„è¯·æ±‚åšå‡ºå“åº”ï¼Œæ€è€ƒè¿™æ ·ä¸€ç§åœºæ™¯ï¼Œåå°å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€èˆ¬æœåŠ¡å™¨åœ¨æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ä¹‹åï¼Œå¦‚æœé€»è¾‘å¤æ‚ï¼Œä¸ä¼šåœ¨ä¸€ä¸ªgoroutineä¸­å®Œæˆï¼Œè€Œæ˜¯ä¼šåˆ›å»ºå‡ºå¾ˆå¤šçš„goroutineå…±åŒå®Œæˆè¿™ä¸ªè¯·æ±‚ï¼Œå°±åƒä¸‹é¢è¿™ç§æƒ…å†µ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/11/0de19f096db64c18ab46bf4f58aeb5c8" alt=""></p>
<p>æœ‰ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ä¹‹åï¼Œå…ˆç»è¿‡ç¬¬ä¸€æ¬¡rpcè°ƒç”¨ï¼Œç„¶åå†åˆ°rpc2ï¼Œåé¢åˆ›å»ºæ‰§è¡Œä¸¤ä¸ªrpcï¼Œrpc4é‡Œåˆæœ‰ä¸€æ¬¡rpcè°ƒç”¨rpc5ï¼Œç­‰æ‰€æœ‰ rpc è°ƒç”¨æˆåŠŸåï¼Œè¿”å›ç»“æœã€‚å‡å¦‚åœ¨æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œrpc1å‘ç”Ÿäº†é”™è¯¯ï¼Œå¦‚æœæ²¡æœ‰contextå­˜åœ¨çš„è¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—ç­‰æ‰€æœ‰çš„rpcéƒ½æ‰§è¡Œå®Œæ‰èƒ½è¿”å›ç»“æœï¼Œè¿™æ ·å…¶å®æµªè´¹äº†ä¸å°‘æ—¶é—´ï¼Œå› ä¸ºä¸€æ—¦å‡ºé”™ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥å†rpc1è¿™é‡Œå°±è¿”å›ç»“æœäº†ï¼Œä¸ç”¨ç­‰åˆ°åç»­çš„rpcéƒ½æ‰§è¡Œå®Œã€‚å‡è®¾æˆ‘ä»¬åœ¨rpc1ç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸ç­‰åç»­çš„rpcç»§ç»­æ‰§è¡Œï¼Œé‚£ä¹ˆå…¶å®åç»­çš„rpcæ‰§è¡Œå°±æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæµªè´¹è®¡ç®—å’ŒIOèµ„æºè€Œå·²ã€‚å†å¼•å…¥contextä¹‹åï¼Œå°±å¯ä»¥å¾ˆå¥½çš„å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¸éœ€è¦å­goroutineæ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡contexté€šçŸ¥å­goroutineä¼˜é›…çš„å…³é—­ã€‚</p>
<p><strong>context.WithCancel</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)</span><br></pre></td></tr></table></figure>
<p>context.WithCancel å‡½æ•°æ˜¯ä¸€ä¸ªå–æ¶ˆæ§åˆ¶å‡½æ•°ï¼Œåªéœ€è¦ä¸€ä¸ªcontextä½œä¸ºå‚æ•°ï¼Œèƒ½å¤Ÿä» context.Context ä¸­è¡ç”Ÿå‡ºä¸€ä¸ªæ–°çš„å­contextå’Œå–æ¶ˆå‡½æ•°CancelFuncï¼Œé€šè¿‡å°†è¿™ä¸ªå­contextä¼ é€’åˆ°æ–°çš„goroutineä¸­æ¥æ§åˆ¶è¿™äº›goroutineçš„å…³é—­ï¼Œä¸€æ—¦æˆ‘ä»¬æ‰§è¡Œè¿”å›çš„å–æ¶ˆå‡½æ•°CancelFuncï¼Œå½“å‰ä¸Šä¸‹æ–‡ä»¥åŠå®ƒçš„å­ä¸Šä¸‹æ–‡éƒ½ä¼šè¢«å–æ¶ˆï¼Œæ‰€æœ‰çš„ Goroutine éƒ½ä¼šåŒæ­¥æ”¶åˆ°å–æ¶ˆä¿¡å·ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">   <span class="keyword">go</span> Watch(ctx, <span class="string">&quot;goroutine1&quot;</span>)</span><br><span class="line">   <span class="keyword">go</span> Watch(ctx, <span class="string">&quot;goroutine2&quot;</span>)</span><br><span class="line"></span><br><span class="line">   time.Sleep(<span class="number">6</span> * time.Second)   <span class="comment">// è®©goroutine1å’Œgoroutine2æ‰§è¡Œ6s</span></span><br><span class="line">   fmt.Println(<span class="string">&quot;end watching!!!&quot;</span>)</span><br><span class="line">   cancel()  <span class="comment">// é€šçŸ¥goroutine1å’Œgoroutine2å…³é—­</span></span><br><span class="line">   time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Watch</span><span class="params">(ctx context.Context, name <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">         fmt.Printf(<span class="string">&quot;%s exit!\n&quot;</span>, name) <span class="comment">// ä¸»goroutineè°ƒç”¨cancelåï¼Œä¼šå‘é€ä¸€ä¸ªä¿¡å·åˆ°ctx.Done()è¿™ä¸ªchannelï¼Œè¿™é‡Œå°±ä¼šæ”¶åˆ°ä¿¡æ¯</span></span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">         fmt.Printf(<span class="string">&quot;%s watching...\n&quot;</span>, name)</span><br><span class="line">         time.Sleep(time.Second)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>context.WithDeadline</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, d time.Time)</span></span> (Context, CancelFunc)</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªcontextï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆªæ­¢æ—¶é—´ï¼ŒåŒæ ·ä¼šè¿”å›ä¸€ä¸ªå­contextå’Œä¸€ä¸ªå–æ¶ˆå‡½æ•°CancelFuncã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ²¡æœ‰åˆ°æˆªæ­¢æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨è°ƒç”¨CancelFuncæ¥å–æ¶ˆå­contextï¼Œæ§åˆ¶å­goroutineçš„é€€å‡ºï¼Œå¦‚æœåˆ°äº†æˆªæ­¢æ—¶é—´ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰è°ƒç”¨CancelFuncï¼Œå­contextçš„Done()ç®¡é“ä¹Ÿä¼šæ”¶åˆ°ä¸€ä¸ªå–æ¶ˆä¿¡å·ï¼Œç”¨æ¥æ§åˆ¶å­goroutineé€€å‡ºã€‚</p>
<p><strong>context.WithTimeout</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc)</span><br></pre></td></tr></table></figure>
<p>context.WithTimeoutå’Œcontext.WithDeadlineçš„ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨äºè¶…æ—¶å–æ¶ˆå­contextï¼Œåªæ˜¯ä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°æœ‰æ‰€ä¸åŒï¼Œcontext.WithTimeoutä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°ä¸æ˜¯å…·ä½“æ—¶é—´ï¼Œè€Œæ˜¯æ—¶é—´é•¿åº¦ã€‚</p>
<p><strong>context.WithValue</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span></span> Context</span><br></pre></td></tr></table></figure>
<p>context.WithValue å‡½æ•°ä»çˆ¶contextä¸­åˆ›å»ºä¸€ä¸ªå­contextç”¨äºä¼ å€¼ï¼Œå‡½æ•°å‚æ•°æ˜¯çˆ¶contextï¼Œkeyï¼Œvalé”®å€¼å¯¹ã€‚è¿”å›ä¸€ä¸ªcontextã€‚</p>
<p>é¡¹ç›®ä¸­è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ç”¨äºä¸Šä¸‹æ–‡ä¿¡æ¯çš„ä¼ é€’ï¼Œæ¯”å¦‚è¯·æ±‚å”¯ä¸€idï¼Œä»¥åŠtrace_idç­‰ï¼Œç”¨äºé“¾è·¯è¿½è¸ªä»¥åŠé…ç½®é€ä¼ ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">func1</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">   fmt.Printf(<span class="string">&quot;name is: %s&quot;</span>, ctx.Value(<span class="string">&quot;name&quot;</span>).(<span class="type">string</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ctx := context.WithValue(context.Background(), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">   <span class="keyword">go</span> func1(ctx)</span><br><span class="line">   time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-7-å®šæ—¶å™¨">1.7 å®šæ—¶å™¨</h3>
<p>åœºæ™¯ï¼šæ¯”å¦‚åˆ°äº†æœªæ¥æŸä¸€æ—¶åˆ»ï¼Œéœ€è¦æŸä¸ªé€»è¾‘æˆ–è€…æŸä¸ªä»»åŠ¡æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ–è€…æ˜¯å‘¨æœŸæ€§çš„çš„æ‰§è¡Œå¤šæ¬¡ï¼Œæœ‰ç‚¹ç±»ä¼¼å®šæ—¶ä»»åŠ¡ã€‚è¿™ç§åœºæ™¯å°±éœ€è¦ç”¨åˆ°å®šæ—¶å™¨ï¼Œgolangä¸­ä¹Ÿå†…ç½®äº†å®šæ—¶å™¨çš„å®ç°ï¼Œtimerå’Œtickerã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Timer <span class="keyword">struct</span> &#123;</span><br><span class="line">    C &lt;-<span class="keyword">chan</span> Time</span><br><span class="line">    r runtimeTimer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   timer := time.NewTimer(<span class="number">2</span> * time.Second) <span class="comment">//è®¾ç½®è¶…æ—¶æ—¶é—´2s</span></span><br><span class="line">   &lt;-timer.C <span class="comment">// æ‰§è¡Œ&lt;-timer.Cä¼šä¸€ç›´é˜»å¡ï¼ŒçŸ¥é“2såï¼Œç¨‹åºç»§ç»­æ‰§è¡Œã€‚</span></span><br><span class="line">   fmt.Println(<span class="string">&quot;after 2s Time out!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Ticker <span class="keyword">struct</span> &#123;</span><br><span class="line">   C &lt;-<span class="keyword">chan</span> Time <span class="comment">// The channel on which the ticks are delivered.</span></span><br><span class="line">   r runtimeTimer <span class="comment">// ä¼šæ¯éš”æ—¶é—´æ®µ d å°±å‘è¯¥é€šé“å‘é€å½“æ—¶çš„æ—¶é—´ï¼Œæ ¹æ®è¿™ä¸ªç®¡é“æ¶ˆæ¯æ¥è§¦å‘äº‹ä»¶ï¼Œä½†æ˜¯tickeråªè¦å®šä¹‰å®Œæˆï¼Œå°±ä»å½“å‰æ—¶é—´å¼€å§‹è®¡æ—¶ï¼Œæ¯éš”å›ºå®šæ—¶é—´éƒ½ä¼šè§¦å‘ï¼Œåªæœ‰å…³é—­Tickerå¯¹è±¡æ‰ä¸ä¼šç»§ç»­å‘é€æ—¶é—´æ¶ˆæ¯</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Watch</span><span class="params">()</span></span> <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; &#123;</span><br><span class="line">   ticker := time.NewTicker(<span class="number">1</span> * time.Second)</span><br><span class="line"></span><br><span class="line">   ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ticker *time.Ticker)</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">         <span class="keyword">select</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            fmt.Println(<span class="string">&quot;watch!!!&quot;</span>)</span><br><span class="line">         <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">            fmt.Println(<span class="string">&quot;Ticker Stop!!!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;(ticker)</span><br><span class="line">   <span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ch := Watch()</span><br><span class="line">   time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">   ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">   <span class="built_in">close</span>(ch)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note warning simple"><p>è°ƒç”¨ticker.Stop()åªä¼šåœæ­¢tickerï¼Œä½†å¹¶ä¸ä¼šå…³é—­ticker.Cè¿™ä¸ªç®¡é“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨è¿™ä¸ªchannelæ¥æ§åˆ¶watchå‡½æ•°ä¸­çš„goroutineèƒ½å¤Ÿé€€å‡ºã€‚</p>
</div>
<h3 id="1-8-åç¨‹æ± ">1.8 åç¨‹æ± </h3>
<p>goè¯­è¨€è™½ç„¶æœ‰ç€é«˜æ•ˆçš„GMPè°ƒåº¦æ¨¡å‹ï¼Œç†è®ºä¸Šæ”¯æŒæˆåƒä¸Šä¸‡çš„goroutineï¼Œä½†æ˜¯goroutineè¿‡å¤šï¼Œå¯¹è°ƒåº¦ï¼Œgcä»¥åŠç³»ç»Ÿå†…å­˜éƒ½ä¼šé€ æˆå‹åŠ›ï¼Œè¿™æ ·ä¼šä½¿æˆ‘ä»¬çš„æœåŠ¡æ€§èƒ½ä¸å‡åé™ã€‚å¸¸ç”¨åšæ³•å¯ä»¥ç”¨æ± åŒ–æŠ€æœ¯ï¼Œæ„é€ ä¸€ä¸ªåç¨‹æ± ï¼ŒæŠŠè¿›ç¨‹ä¸­çš„åç¨‹æ§åˆ¶åœ¨ä¸€å®šçš„æ•°é‡ï¼Œé˜²æ­¢ç³»ç»Ÿä¸­goroutineè¿‡å¤šï¼Œå½±å“æœåŠ¡æ€§èƒ½ã€‚</p>
<p>åç¨‹æ± æœ‰ä¸‰ä¸ªè§’è‰²Workerï¼ŒTaskï¼ŒPoolã€‚</p>
<p>Workerï¼šç”¨äºæ‰§è¡Œä»»åŠ¡çš„goroutine</p>
<p>Task: å…·ä½“çš„ä»»åŠ¡</p>
<p>Pool: æ± å­</p>
<p><strong>Task</strong>ï¼šæœ‰ä¸€ä¸ªå‡½æ•°æˆå‘˜ï¼Œè¡¨ç¤ºè¿™ä¸ªtaskå…·ä½“çš„æ‰§è¡Œé€»è¾‘</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Task <span class="keyword">struct</span> &#123;</span><br><span class="line">    f <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span>  <span class="comment">// å…·ä½“çš„æ‰§è¡Œé€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Pool</strong>ï¼šæœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œnumè¡¨ç¤ºæ± å­é‡Œçš„workerçš„æ•°é‡ï¼Œå³å·¥ä½œçš„goroutineçš„æ•°é‡ï¼ŒJobCh è¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—ç”¨äºå­˜æ”¾ä»»åŠ¡ï¼Œgoroutineä»è¿™ä¸ªJobCh è·å–ä»»åŠ¡æ‰§è¡Œä»»åŠ¡åˆ—é€»è¾‘</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">   WorkerNum <span class="type">int</span>        <span class="comment">// goroutineæ•°é‡</span></span><br><span class="line">   JobCh     <span class="keyword">chan</span> *Task <span class="comment">// ç”¨äºworkerå–ä»»åŠ¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>worker</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pä¸ºPoolå¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">for</span> task := <span class="keyword">range</span> p.JobCh&#123;</span><br><span class="line">    do ...      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä»»åŠ¡å•å…ƒï¼Œç®€å•ç†è§£å°±æ˜¯å¹²æ´»çš„goroutineï¼Œè¿™ä¸ªworkerå…¶å®åªåšä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯ä¸æ–­çš„ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢å–ä»»åŠ¡æ‰§è¡Œï¼Œè€Œworkerçš„æ•°é‡å°±æ˜¯åç¨‹æ± é‡Œåç¨‹çš„æ•°é‡ï¼Œç”±Poolçš„å‚æ•°WorkerNum æŒ‡å®š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">package main</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">import</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="string">&quot;fmt&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="string">&quot;time&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">type Task <span class="keyword">struct</span> </span>&#123;</span><br><span class="line">	<span class="function">f <span class="title">func</span><span class="params">()</span> error</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">func <span class="title">newTask</span><span class="params">(funcArg func() error)</span> *Task </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Task&#123;f: funcArg&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">	workerNum <span class="type">int</span></span><br><span class="line">	jobCh     chan *Task</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func <span class="built_in">newPool</span>(workerNum <span class="type">int</span>, taskNum <span class="type">int</span>) *Pool &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Pool&#123;workerNum: workerNum,</span><br><span class="line">		jobCh: <span class="built_in">make</span>(chan *Task, taskNum),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">func</span> (p *Pool) <span class="built_in">size</span>() <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> p.workerNum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">func</span> (p *Pool) <span class="built_in">worker</span>(i <span class="type">int</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> task := range p.jobCh &#123;</span><br><span class="line">		<span class="keyword">if</span> err := task.<span class="built_in">f</span>(); err != nil &#123;</span><br><span class="line">			fmt.<span class="built_in">Printf</span>(<span class="string">&quot;worker %d handle fail: %v\n&quot;</span>, i, err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.<span class="built_in">Printf</span>(<span class="string">&quot;worker %d handle success\n&quot;</span>, i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddTask å¾€åç¨‹æ± é‡Œé¢æ·»åŠ ä»»åŠ¡</span></span><br><span class="line"><span class="built_in">func</span> (p *Pool) <span class="built_in">AddTask</span>(task *Task) &#123;</span><br><span class="line">	p.jobCh &lt;- task</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run åç¨‹æ± è·‘èµ·æ¥ï¼Œéœ€è¦æŒ‡å®šæ•°é‡çš„workerå¹²æ´»</span></span><br><span class="line"><span class="built_in">func</span> (p *Pool) <span class="built_in">Run</span>() &#123;</span><br><span class="line">	<span class="comment">// è¿™é‡Œåªåˆ›å»ºæŒ‡å®šæ•°é‡çš„workeræ¥å¹²æ´»</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; p.<span class="built_in">size</span>(); i++ &#123;</span><br><span class="line">		go p.<span class="built_in">worker</span>(i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">func <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	p := <span class="built_in">newPool</span>(<span class="number">3</span>, <span class="number">10</span>)</span><br><span class="line">	p.<span class="built_in">Run</span>()</span><br><span class="line">	task := <span class="built_in">newTask</span>(<span class="built_in">func</span>() error &#123;</span><br><span class="line">		fmt.<span class="built_in">Printf</span>(<span class="string">&quot;I am Task\n&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> nil</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">		p.<span class="built_in">AddTask</span>(task)</span><br><span class="line">	&#125;</span><br><span class="line">	time.<span class="built_in">Sleep</span>(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-åŸç†åˆ†æ">2. åŸç†åˆ†æ</h2>
<h3 id="2-1-ç¨‹åºåˆå§‹åŒ–">2.1 ç¨‹åºåˆå§‹åŒ–</h3>
<p><code>Go</code>åº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–æ˜¯åœ¨å•ä¸€çš„<code>goroutine</code>ä¸­æ‰§è¡Œçš„ã€‚å¯¹äºåŒ…è¿™ä¸€çº§åˆ«çš„åˆå§‹åŒ–æ¥è¯´ï¼Œ**åœ¨ä¸€ä¸ªåŒ…é‡Œä¼šå…ˆè¿›è¡ŒåŒ…çº§åˆ«å˜é‡çš„åˆå§‹åŒ–ã€‚ä¸€ä¸ªåŒ…ä¸‹å¯ä»¥æœ‰å¤šä¸ª<code>init</code>å‡½æ•°ï¼Œæ¯ä¸ªæ–‡ä»¶ä¹Ÿå¯ä»¥æœ‰å¤šä¸ª<code>init</code>å‡½æ•°ï¼Œå¤šä¸ª<code>init</code>å‡½æ•°æŒ‰ç…§å®ƒä»¬çš„æ–‡ä»¶åé¡ºåºé€ä¸ªåˆå§‹åŒ–ã€‚**ä½†æ˜¯ç¨‹åºä¸å¯èƒ½æŠŠæ‰€æœ‰ä»£ç éƒ½æ”¾åœ¨ä¸€ä¸ªåŒ…é‡Œï¼Œé€šå¸¸éƒ½æ˜¯ä¼šå¼•å…¥å¾ˆå¤šåŒ…ã€‚å¦‚æœ<code>main</code>åŒ…å¼•å…¥äº†<code>pkg1</code>åŒ…ï¼Œ<code>pkg1</code>åŒ…æœ¬èº«åˆå¯¼å…¥äº†åŒ…<code>pkg2</code>ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–ä¼šæŒ‰ç…§ä»€ä¹ˆé¡ºåºæ¥æ‰§è¡Œå‘¢ï¼Ÿ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/11/615930ad312d4f5ead00d1f1d62e72d6" alt=""></p>
<p>å›¾çš„ä¸ŠåŠéƒ¨åˆ†è¡¨ç¤ºäº†<code>main</code>åŒ…å¯¼å…¥äº†<code>pkg1</code>åŒ…ï¼Œ<code>pkg1</code>åŒ…åˆå¯¼å…¥äº†<code>pkg2</code>åŒ…è¿™æ ·ä¸€ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å›¾çš„ä¸‹åŠéƒ¨åˆ†è¡¨ç¤ºäº†ï¼Œè¿™ä¸ªåº”ç”¨åˆå§‹åŒ–å·¥ä½œçš„æ‰§è¡Œæ—¶é—´é¡ºåºæ˜¯ä»è¢«å¯¼å…¥çš„æœ€æ·±å±‚åŒ…å¼€å§‹è¿›è¡Œåˆå§‹åŒ–ï¼Œå±‚å±‚é€’å‡ºæœ€ååˆ°<code>main</code>åŒ…ï¼Œæ¯ä¸ªåŒ…å†…éƒ¨çš„åˆå§‹åŒ–ç¨‹åºä¾ç„¶æ˜¯å…ˆæ‰§è¡ŒåŒ…å˜é‡åˆå§‹åŒ–å†è¿›è¡Œ<code>init</code>å‡½æ•°çš„æ‰§è¡Œã€‚</p>
<p>æœ€å…ˆè¢«ä¾èµ–çš„åŒ…æœ€å…ˆè¢«åˆå§‹åŒ–ï¼Œä¸”åˆå§‹åŒ–çš„é¡ºåºæ˜¯å…ˆåˆå§‹åŒ–åŒ…å˜é‡ï¼Œå†è¯´åˆå§‹åŒ–initå‡½æ•°ã€‚åˆå§‹åŒ–è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>åŒ…çº§åˆ«å˜é‡çš„åˆå§‹åŒ–å…ˆäºåŒ…å†…initå‡½æ•°çš„æ‰§è¡Œã€‚</li>
<li>ä¸€ä¸ªåŒ…ä¸‹å¯ä»¥æœ‰å¤šä¸ªinitå‡½æ•°ï¼Œæ¯ä¸ªæ–‡ä»¶ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªinit å‡½æ•°ã€‚</li>
<li>å¤šä¸ª init å‡½æ•°æŒ‰ç…§å®ƒä»¬çš„æ–‡ä»¶åé¡ºåºé€ä¸ªåˆå§‹åŒ–ã€‚</li>
<li>åº”ç”¨åˆå§‹åŒ–æ—¶åˆå§‹åŒ–å·¥ä½œçš„é¡ºåºæ˜¯ï¼Œä»è¢«å¯¼å…¥çš„æœ€æ·±å±‚åŒ…å¼€å§‹è¿›è¡Œåˆå§‹åŒ–ï¼Œå±‚å±‚é€’å‡ºæœ€ååˆ°mainåŒ…ã€‚</li>
<li>ä¸ç®¡åŒ…è¢«å¯¼å…¥å¤šå°‘æ¬¡ï¼ŒåŒ…å†…çš„initå‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</li>
<li>åº”ç”¨åœ¨æ‰€æœ‰åˆå§‹åŒ–å·¥ä½œå®Œæˆåæ‰ä¼šæ‰§è¡Œmainå‡½æ•°ã€‚</li>
</ul>
<h3 id="2-2-é€ƒé€¸åˆ†æ">2.2 é€ƒé€¸åˆ†æ</h3>
<p><strong>ä»€ä¹ˆæ˜¯é€ƒé€¸</strong></p>
<blockquote>
<p><strong><code>é€ƒé€¸åˆ†ææ˜¯ç¼–è¯‘å™¨ç”¨äºå†³å®šå˜é‡åˆ†é…åˆ°å †ä¸Šè¿˜æ˜¯æ ˆä¸Šçš„ä¸€ç§è¡Œä¸ºã€‚</code></strong></p>
</blockquote>
<p>å‡½æ•°çš„è¿è¡Œéƒ½æ˜¯åœ¨æ ˆä¸Šé¢è¿è¡Œçš„ï¼Œåœ¨æ ˆä¸Šé¢å£°æ˜ä¸´æ—¶å˜é‡ï¼Œåˆ†é…å†…å­˜ï¼Œå‡½æ•°è¿è¡Œå®Œæ¯•ä¹‹åï¼Œå›æ”¶å†…å­˜ï¼Œæ¯ä¸ªå‡½æ•°çš„æ ˆç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå…¶ä»–å‡½æ•°æ˜¯æ— æ³•è¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹æ ˆä¸Šé¢çš„æ•°æ®éœ€è¦åœ¨å‡½æ•°ç»“æŸä¹‹åè¿˜èƒ½è¢«è®¿é—®ï¼Œè¿™æ—¶å€™å°±ä¼šè®¾è®¡åˆ°å†…å­˜é€ƒé€¸äº†ï¼Œä»€ä¹ˆæ˜¯é€ƒé€¸ï¼Œå°±æ˜¯æŠ“ä¸ä½</p>
<p>å¦‚æœæ•°æ®ä»æ ˆä¸Šé¢é€ƒé€¸ï¼Œä¼šè·‘åˆ°å †ä¸Šé¢ï¼Œæ ˆä¸Šé¢çš„æ•°æ®åœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™å›è‡ªåŠ¨å›æ”¶ï¼Œå›æ”¶ä»£ä»·æ¯”è¾ƒå°ï¼Œæ ˆçš„å†…å­˜åˆ†é…å’Œä½¿ç”¨ä¸€èˆ¬åªéœ€è¦ä¸¤ä¸ªCPUæŒ‡ä»¤â€œPUSHâ€å’Œâ€œRELEASEâ€ï¼Œåˆ†é…å’Œé‡Šæ”¾ï¼Œè€Œå †åˆ†é…å†…å­˜ï¼Œåˆ™æ˜¯é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€å—å¤§å°åˆé€‚çš„å†…å­˜ï¼Œä¹‹åé€šè¿‡GCå›æ”¶æ‰èƒ½é‡Šæ”¾ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œé¢‘ç¹çš„ä½¿ç”¨åƒåœ¾å›æ”¶ï¼Œåˆ™ä¼šå ç”¨æ¯”è¾ƒå¤§çš„ç³»ç»Ÿå¼€é”€ï¼Œæ‰€ä»¥å°½é‡åˆ†é…å†…å­˜åˆ°æ ˆä¸Šé¢ï¼Œå‡å°‘gcçš„å‹åŠ›ï¼Œæé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦</p>
<p><strong>é€ƒé€¸åˆ†æè¿‡ç¨‹</strong><br>
Goè¯­è¨€æœ€åŸºæœ¬çš„é€ƒé€¸åˆ†æåŸåˆ™ï¼šå¦‚æœä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå¯¹å˜é‡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‘ç”Ÿé€ƒé€¸ã€‚</p>
<p>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªå€¼è¢«åˆ†é…åˆ°äº†æ ˆä¹‹å¤–çš„åœ°æ–¹ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯åˆ°äº†å †ä¸Šé¢ã€‚ç®€è€Œæ¦‚ä¹‹ï¼šç¼–è¯‘å™¨ä¼šåˆ†æä»£ç çš„ç‰¹å¾å’Œä»£ç ç”Ÿå‘½å‘¨æœŸï¼ŒGoä¸­çš„å˜é‡åªæœ‰åœ¨ç¼–è¯‘å™¨å¯ä»¥è¯æ˜åœ¨å‡½æ•°è¿”å›åä¸ä¼šå†è¢«å¼•ç”¨çš„ï¼Œæ‰åˆ†é…åˆ°æ ˆä¸Šï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½æ˜¯åˆ†é…åˆ°å †ä¸Š<br>
Goè¯­è¨€é‡Œé¢æ²¡æœ‰ä¸€ä¸ªå…³é”®å­—æˆ–è€…å‡½æ•°å¯ä»¥ç›´æ¥è®©å˜é‡è¢«ç¼–è¯‘å™¨åˆ†é…åˆ°å †ä¸Šï¼Œç›¸åï¼Œç¼–è¯‘å™¨æ˜¯é€šè¿‡åˆ†æä»£ç æ¥å†³å®šå°†å˜é‡åˆ†é…åˆ°ä½•å¤„ã€‚<br>
ç®€å•æ¥è¯´ï¼Œ<strong>ç¼–è¯‘å™¨ä¼šæ ¹æ®å˜é‡æ˜¯å¦è¢«å¤–éƒ¨å¼•ç”¨æ¥å†³å®šæ˜¯å¦é€ƒé€¸</strong>ï¼š<br>
å¦‚æœå‡½æ•°å¤–éƒ¨æ²¡æœ‰å¼•ç”¨ï¼Œåˆ™ä¼˜å…ˆæ”¾åˆ°æ ˆä¸­ï¼›<br>
å¦‚æœå‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ï¼Œåˆ™å¿…å®šæ”¾åˆ°å †ä¸­ï¼›</p>
<p><strong>æŒ‡é’ˆé€ƒé€¸</strong><br>
æˆ‘ä»¬çŸ¥é“ä¼ é€’æŒ‡é’ˆå¯ä»¥å‡å°‘åº•å±‚å€¼çš„æ‹·è´ï¼Œå¯ä»¥æé«˜æ•ˆç‡ï¼Œä½†æ˜¯å¦‚æœæ‹·è´çš„æ•°æ®é‡å°ï¼Œç”±äºæŒ‡é’ˆä¼ é€’ä¼šäº§ç”Ÿé€ƒé€¸ï¼Œå¯èƒ½ä¼šä½¿ç”¨å †ï¼Œä¹Ÿå¯èƒ½ä¼šå¢åŠ GCçš„è´Ÿæ‹…ï¼Œæ‰€ä»¥ä¼ é€’æŒ‡é’ˆä¸ä¸€å®šæ˜¯é«˜æ•ˆçš„ã€‚</p>
<p><strong>åŠ¨æ€ç±»å‹é€ƒé€¸</strong><br>
å¾ˆå¤šå‡½æ•°å‚æ•°ä¸ºinterfaceç±»å‹ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="type">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sprintf</span><span class="params">(format <span class="type">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">string</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fprint</span><span class="params">(w io.Writer, a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span><span class="params">(a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> (n <span class="type">int</span>, err <span class="type">error</span>)</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æœŸé—´å¾ˆéš¾ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œä¹Ÿèƒ½äº§ç”Ÿé€ƒé€¸ã€‚</p>
<p><strong>é€ƒé€¸å¸¸è§æƒ…å†µ</strong></p>
<ol>
<li>å‘é€æŒ‡é’ˆçš„æŒ‡é’ˆæˆ–åŒ…å«æŒ‡é’ˆçš„å€¼å‘é€åˆ° channel ä¸­ï¼Œç”±äºåœ¨ç¼–è¯‘é˜¶æ®µæ— æ³•ç¡®å®šå…¶ä½œç”¨åŸŸä¸ä¼ é€’çš„è·¯å¾„ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¼šé€ƒé€¸åˆ°å †ä¸Šåˆ†é…ã€‚</li>
<li>slices ä¸­çš„å€¼æ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆæˆ–åŒ…å«æŒ‡é’ˆå­—æ®µã€‚ä¸€ä¸ªä¾‹å­æ˜¯ç±»ä¼¼[] *string çš„ç±»å‹ã€‚è¿™æ€»æ˜¯å¯¼è‡´ slice çš„é€ƒé€¸ã€‚å³ä½¿åˆ‡ç‰‡çš„åº•å±‚å­˜å‚¨æ•°ç»„ä»å¯èƒ½ä½äºå †æ ˆä¸Šï¼Œæ•°æ®çš„å¼•ç”¨ä¹Ÿä¼šè½¬ç§»åˆ°å †ä¸­ã€‚</li>
<li>slice ç”±äº append æ“ä½œè¶…å‡ºå…¶å®¹é‡ï¼Œå› æ­¤ä¼šå¯¼è‡´ slice é‡æ–°åˆ†é…ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºåœ¨ç¼–è¯‘æ—¶ slice çš„åˆå§‹å¤§å°çš„å·²çŸ¥æƒ…å†µä¸‹ï¼Œå°†ä¼šåœ¨æ ˆä¸Šåˆ†é…ã€‚å¦‚æœ slice çš„åº•å±‚å­˜å‚¨å¿…é¡»åŸºäºä»…åœ¨è¿è¡Œæ—¶æ•°æ®è¿›è¡Œæ‰©å±•ï¼Œåˆ™å®ƒå°†åˆ†é…åœ¨å †ä¸Šã€‚</li>
<li>è°ƒç”¨æ¥å£ç±»å‹çš„æ–¹æ³•ã€‚æ¥å£ç±»å‹çš„æ–¹æ³•è°ƒç”¨æ˜¯åŠ¨æ€è°ƒåº¦ - å®é™…ä½¿ç”¨çš„å…·ä½“å®ç°åªèƒ½åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚è€ƒè™‘ä¸€ä¸ªæ¥å£ç±»å‹ä¸º io.Reader çš„å˜é‡ rã€‚å¯¹ r.Read(b) çš„è°ƒç”¨å°†å¯¼è‡´ r çš„å€¼å’Œå­—èŠ‚ç‰‡bçš„åç»­è½¬ä¹‰å¹¶å› æ­¤åˆ†é…åˆ°å †ä¸Šã€‚</li>
<li>å°½ç®¡èƒ½å¤Ÿç¬¦åˆåˆ†é…åˆ°æ ˆçš„åœºæ™¯ï¼Œä½†æ˜¯å…¶å¤§å°ä¸èƒ½å¤Ÿåœ¨åœ¨ç¼–è¯‘æ—¶å€™ç¡®å®šçš„æƒ…å†µï¼Œä¹Ÿä¼šåˆ†é…åˆ°å †ä¸Š</li>
</ol>
<p><strong>å¦‚ä½•é¿å…</strong></p>
<ol>
<li>go ä¸­çš„æ¥å£ç±»å‹çš„æ–¹æ³•è°ƒç”¨æ˜¯åŠ¨æ€è°ƒåº¦ï¼Œå› æ­¤ä¸èƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µç¡®å®šï¼Œæ‰€æœ‰ç±»å‹ç»“æ„è½¬æ¢æˆæ¥å£çš„è¿‡ç¨‹ä¼šæ¶‰åŠåˆ°å†…å­˜é€ƒé€¸çš„æƒ…å†µå‘ç”Ÿã€‚å¦‚æœå¯¹äºæ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ä¸”è®¿é—®é¢‘æ¬¡æ¯”è¾ƒé«˜çš„å‡½æ•°è°ƒç”¨ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨æ¥å£ç±»å‹</li>
<li>ç”±äºåˆ‡ç‰‡ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨åœ¨å‡½æ•°ä¼ é€’çš„åœºæ™¯ä¸‹ï¼Œè€Œä¸”åˆ‡ç‰‡åœ¨ append çš„æ—¶å€™å¯èƒ½ä¼šæ¶‰åŠåˆ°é‡æ–°åˆ†é…å†…å­˜ï¼Œå¦‚æœåˆ‡ç‰‡åœ¨ç¼–è¯‘æœŸé—´çš„å¤§å°ä¸èƒ½å¤Ÿç¡®è®¤æˆ–è€…å¤§å°è¶…å‡ºæ ˆçš„é™åˆ¶ï¼Œå¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šåˆ†é…åˆ°å †ä¸Š</li>
</ol>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>å †ä¸ŠåŠ¨æ€åˆ†é…å†…å­˜æ¯”æ ˆä¸Šé™æ€åˆ†é…å†…å­˜ï¼Œå¼€é”€å¤§å¾ˆå¤šã€‚</li>
<li>å˜é‡åˆ†é…åœ¨æ ˆä¸Šéœ€è¦èƒ½åœ¨ç¼–è¯‘æœŸç¡®å®šå®ƒçš„ä½œç”¨åŸŸï¼Œå¦åˆ™ä¼šåˆ†é…åˆ°å †ä¸Šã€‚</li>
<li>Goç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸå¯¹è€ƒå¯Ÿå˜é‡çš„ä½œç”¨åŸŸï¼Œå¹¶ä½œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œå¦‚æœå®ƒçš„ä½œç”¨åŸŸåœ¨è¿è¡ŒæœŸé—´å¯¹ç¼–è¯‘å™¨ä¸€ç›´æ˜¯å¯çŸ¥çš„ï¼Œé‚£ä¹ˆå°±ä¼šåˆ†é…åˆ°æ ˆä¸Šã€‚ç®€å•æ¥è¯´ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å˜é‡æ˜¯å¦è¢«å¤–éƒ¨å¼•ç”¨æ¥å†³å®šæ˜¯å¦é€ƒé€¸ã€‚</li>
<li>å¯¹äºGoç¨‹åºå‘˜æ¥è¯´ï¼Œç¼–è¯‘å™¨çš„è¿™äº›é€ƒé€¸åˆ†æè§„åˆ™ä¸éœ€è¦æŒæ¡ï¼Œæˆ‘ä»¬åªéœ€é€šè¿‡go build -gcflags '-mâ€™å‘½ä»¤æ¥è§‚å¯Ÿå˜é‡é€ƒé€¸æƒ…å†µå°±è¡Œäº†</li>
<li>ä¸è¦ç›²ç›®ä½¿ç”¨å˜é‡çš„æŒ‡é’ˆä½œä¸ºå‡½æ•°å‚æ•°ï¼Œè™½ç„¶å®ƒä¼šå‡å°‘å¤åˆ¶æ“ä½œã€‚ä½†å…¶å®å½“å‚æ•°ä¸ºå˜é‡è‡ªèº«çš„æ—¶å€™ï¼Œå¤åˆ¶æ˜¯åœ¨æ ˆä¸Šå®Œæˆçš„æ“ä½œï¼Œå¼€é”€è¿œæ¯”å˜é‡é€ƒé€¸ååŠ¨æ€åœ°åœ¨å †ä¸Šåˆ†é…å†…å­˜å°‘çš„å¤šã€‚</li>
</ol>
<h2 id="3-golangæ•°æ®ç»“æ„å®ç°åŸç†">3. golangæ•°æ®ç»“æ„å®ç°åŸç†</h2>
<h3 id="3-1-string">3.1 string</h3>
<ul>
<li>å­—ç¬¦ä¸²æ˜¯æ‰€æœ‰8 æ¯”ç‰¹å­—èŠ‚çš„é›†åˆï¼Œä½†ä¸ä¸€å®šæ˜¯ UTF-8 ç¼–ç çš„æ–‡æœ¬</li>
<li>å­—ç¬¦ä¸²å¯ä»¥ä¸ºemptyï¼Œä½†ä¸èƒ½ä¸º <code>nil</code> ï¼Œemptyå­—ç¬¦ä¸²å°±æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å­—ç¬¦çš„ç©ºä¸²&quot;&quot;</li>
<li>å­—ç¬¦ä¸²ä¸å¯ä»¥è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²ç±»å‹çš„å€¼æ˜¯ä¸å¯å˜çš„</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> stringStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">   str unsafe.Pointer    <span class="comment">//  æŒ‡å‘ä¸€ä¸ªbyteç±»å‹çš„åˆ‡ç‰‡æŒ‡é’ˆ</span></span><br><span class="line">   <span class="built_in">len</span> <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>stræŒ‡å‘å­—ç¬¦ä¸²çš„é¦–åœ°å€</strong></li>
<li><strong>lenè¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦</strong></li>
</ul>
<p>lenå­—æ®µå­˜å‚¨çš„æ˜¯å®é™…çš„å­—èŠ‚æ•°ï¼Œè€Œä¸æ˜¯å­—ç¬¦æ•°ï¼Œæ‰€ä»¥å¯¹äºéå•å­—èŠ‚ç¼–ç çš„å­—ç¬¦ï¼Œå…¶ç»“æœå¯èƒ½å¤šäºå­—ç¬¦ä¸ªæ•°ï¼Œæ¯”å¦‚å­˜å‚¨&quot;ä½ å¥½ä¸–ç•Œ&quot;ï¼Œlençš„é•¿åº¦æ˜¯12å­—èŠ‚è€Œä¸æ˜¯4ä¸ªå­—ç¬¦ï¼Œä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ã€‚</p>
<p>ç»“æ„å®šä¹‰æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå…¶å®šä¹‰ä¸­å¹¶æ²¡æœ‰ä¸€ä¸ªè¡¨ç¤ºå®¹é‡(Cap)çš„å­—æ®µï¼Œæ‰€ä»¥æ„å‘³ç€å­—ç¬¦ä¸²ç±»å‹å¹¶ä¸èƒ½è¢«æ‰©å®¹ï¼Œå­—ç¬¦æ¢ä¸Šçš„å†™æ“ä½œåŒ…æ‹¬æ‹¼æ¥ï¼Œè¿½åŠ ç­‰ç­‰éƒ½æ˜¯é€šè¿‡æ‹·è´æ¥å®ç°çš„ã€‚</p>
<p>å­—ç¬¦ä¸²ç»“æ„æ˜¯ç”±ä¸€ä¸ªæŒ‡å‘byteç±»å‹çš„åˆ‡ç‰‡æŒ‡é’ˆå’Œä¸€ä¸ªè¡¨ç¤ºå­—èŠ‚æ•°ç»„é•¿åº¦çš„æ•´å½¢å˜é‡æ„æˆï¼Œé’ˆæŒ‡å‘çš„ä¸€ä¸ªåˆ‡ç‰‡æ‰æ˜¯çœŸæ­£çš„å­—ç¬¦ä¸²å€¼ã€‚è¿™å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œæ—¢ç„¶å­—ç¬¦ä¸²çš„å€¼æ˜¯ä¸€ä¸ª[] byte ç±»å‹çš„åˆ‡ç‰‡ï¼Œé‚£æˆ‘ä»¬ä½¿ç”¨ä¸‹æ ‡çš„æ–¹å¼å»ä¿®æ”¹å€¼çš„æ—¶å€™ï¼Œæ˜¯å°†ä¸€ä¸ªå­—ç¬¦å†…å®¹èµ‹å€¼ç»™ byte ç±»å‹ï¼Œè¿™æ˜¯ä¸å…è®¸çš„ã€‚</p>
<p>è¿™æ ·ä¸€åˆ†æï¼Œé‚£ä¹ˆå¯ä¸å¯ä»¥å°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç„¶åé€šè¿‡ä¸‹æ ‡ä¿®æ”¹å­—èŠ‚æ•°ç»„ï¼Œå†è½¬åŒ–å›å­—ç¬¦ä¸²å‘¢ï¼Œç­”æ¡ˆæ˜¯å¯è¡Œçš„ã€‚</p>
<p>byte åˆ‡ç‰‡è½¬åŒ–ä¸ºstringï¼Œå¤§è‡´è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li>
<p>æ–°ç”³è¯·åˆ‡ç‰‡å†…å­˜ç©ºé—´ï¼Œæ„å»ºå†…å­˜åœ°å€ä¸ºaddrï¼Œé•¿åº¦ä¸ºlen</p>
</li>
<li>
<p>æ„å»º stringå¯¹è±¡ï¼ŒæŒ‡é’ˆåœ°å€ä¸ºaddrï¼Œlenå­—æ®µèµ‹å€¼ä¸ºlenï¼ˆstring.str = addrï¼›string.len = lenï¼›ï¼‰</p>
</li>
<li>
<p>å°†åŸåˆ‡ç‰‡ä¸­æ•°æ®æ‹·è´åˆ°æ–°ç”³è¯·çš„stringä¸­æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/14a9834fec804038b6d662bb98284b2e" alt=""></p>
</li>
</ol>
<p>stringè½¬åŒ–ä¸ºbyteæ•°ç»„åŒæ ·ç®€å•ï¼Œå¤§è‡´åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li>æ–°ç”³è¯·åˆ‡ç‰‡å†…å­˜ç©ºé—´</li>
<li>å°†stringä¸­æŒ‡é’ˆæ‰§è¡Œå†…å­˜åŒºåŸŸçš„å†…å®¹æ‹·è´åˆ°æ–°åˆ‡ç‰‡</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/8bc2d0a93b8243b2a9b46b61d6246dc0" alt=""></p>
<p>å¾ˆå¤šåœºæ™¯ä¸­ä¼šç”¨åˆ°[]byteè½¬åŒ–ä¸ºstringï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸€æ¬¡è½¬åŒ–ï¼Œéƒ½ä¼šæƒ³ä¸Šè¿°è¿‡ç¨‹ä¸€æ ·ï¼Œå‘ç”Ÿä¸€æ¬¡å†…å­˜æ‹·è´ã€‚åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿæ‹·è´å‘¢ï¼Ÿ</p>
<p>è½¬åŒ–ä¸ºçš„å­—ç¬¦ä¸²è¢«ç”¨äºä¸´æ—¶åœºæ™¯</p>
<p>ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p>
<ol>
<li>å­—ç¬¦ä¸²æ¯”è¾ƒï¼šstring(ss) == â€œHelloâ€</li>
<li>å­—ç¬¦ä¸²æ‹¼æ¥ï¼šâ€œHelloâ€ + sting(ss) + â€œworldâ€</li>
<li>ç”¨ä½œæŸ¥æ‰¾ï¼Œæ¯”å¦‚mapçš„keyï¼Œval := map[string(ss)]</li>
</ol>
<p>è¿™å‡ ç§æƒ…å†µä¸‹ï¼Œ[]byteè½¬åŒ–æˆçš„å­—ç¬¦ä¸²å¹¶ä¸ä¼šè¢«åé¢ç¨‹åºç”¨åˆ°ï¼Œåªæ˜¯åœ¨å½“å‰åœºæ™¯ä¸‹è¢«ä¸´æ—¶ç”¨åˆ°ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šæ‹·è´å†…å­˜ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ä¸€ä¸ª stringï¼Œè¿™ä¸ª string çš„æŒ‡é’ˆ (string.str) æŒ‡å‘åˆ‡ç‰‡çš„å†…å­˜ã€‚</p>
<p><strong>å­—ç¬¦ä¸²æ‹¼æ¥</strong></p>
<p>é‡‡ç”¨testingåŒ…ä¸‹benchmarkæµ‹è¯•å…¶æ€§èƒ½</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;bytes&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;strings&quot;</span></span><br><span class="line">   <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">   str = <span class="string">&quot;efwaefnurgnrehgepbnrebewnbgblasjfnowbgwooihfunw&quot;</span></span><br><span class="line">   cnt = <span class="number">10000</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkPlusConcat + æ‹¼æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkPlusConcat</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">      ss := <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">         ss += str</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkSprintfConcat sprintfæ‹¼æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSprintfConcat</span><span class="params">(b *testing.B)</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">      ss := <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">         ss = fmt.Sprintf(<span class="string">&quot;%s%s&quot;</span>, ss, str)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkBuilderConcat stringbuilder æ‹¼æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBuilderConcat</span><span class="params">(b *testing.B)</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">      <span class="keyword">var</span> builder strings.Builder</span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">         builder.WriteString(str)</span><br><span class="line">      &#125;</span><br><span class="line">      builder.String()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkBufferConcat stringbuilder æ‹¼æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBufferConcat</span><span class="params">(b *testing.B)</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">      buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">         buf.WriteString(str)</span><br><span class="line">      &#125;</span><br><span class="line">      buf.String()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkAppendConcat append æ‹¼æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkAppendConcat</span><span class="params">(b *testing.B)</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">      buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">         buf = <span class="built_in">append</span>(buf, str...)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td><code>+</code> æ‹¼æ¥ 2 ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œå¼€è¾Ÿä¸€æ®µæ–°çš„å†…å­˜ç©ºé—´ï¼Œæ–°ç©ºé—´çš„å¤§å°æ˜¯åŸæ¥ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å¤§å°ä¹‹å’Œï¼Œæ‰€ä»¥æ²¡æ‹¼æ¥ä¸€æ¬¡ä¹°å°±è¦å¼€è¾Ÿä¸€æ®µç©ºé—´ï¼Œæ€§èƒ½å¾ˆå·®</td>
</tr>
<tr>
<td>Sprintf</td>
<td>Sprintf ä¼šä»ä¸´æ—¶å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ª å¯¹è±¡ï¼Œç„¶åæ ¼å¼åŒ–æ“ä½œï¼Œæœ€åè½¬åŒ–ä¸ºstringï¼Œé‡Šæ”¾å¯¹è±¡ï¼Œå®ç°å¾ˆå¤æ‚ï¼Œæ€§èƒ½ä¹Ÿå¾ˆå·®</td>
</tr>
<tr>
<td>strings.Builder</td>
<td>åº•å±‚å­˜å‚¨ä½¿ç”¨[] byteï¼Œè½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ—¶å¯å¤ç”¨ï¼Œæ¯æ¬¡åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œæ”¯æŒé¢„åˆ†é…å†…å­˜å¹¶ä¸”è‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥æ€»ä½“æ¥è¯´ï¼Œå¼€è¾Ÿå†…å­˜çš„æ¬¡æ•°å°±å°‘ï¼Œæ€§èƒ½ç›¸å¯¹å°±é«˜</td>
</tr>
<tr>
<td>bytes.Buffer</td>
<td>åº•å±‚å­˜å‚¨ä½¿ç”¨[] byteï¼Œè½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ—¶ä¸å¯å¤ç”¨ï¼Œåº•å±‚å®ç°å’Œstrings.Builderå·®ä¸å¤šï¼Œæ€§èƒ½æ¯”strings.Builderç•¥å·®ä¸€ç‚¹ï¼ŒåŒºåˆ«æ˜¯<code>bytes.Buffer </code>è½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ—¶é‡æ–°ç”³è¯·äº†ä¸€å—ç©ºé—´ï¼Œå­˜æ”¾ç”Ÿæˆçš„å­—ç¬¦ä¸²å˜é‡ï¼Œè€Œ <code>strings.Builder</code> ç›´æ¥å°†åº•å±‚çš„ <code>[]byte</code> è½¬æ¢æˆäº†å­—ç¬¦ä¸²ç±»å‹è¿”å›äº†å›æ¥ï¼Œ</td>
</tr>
<tr>
<td>append</td>
<td>ç›´æ¥ä½¿ç”¨[]byteæ‰©å®¹æœºåˆ¶ï¼Œå¯å¤ç”¨ï¼Œæ”¯æŒé¢„åˆ†é…å†…å­˜å’Œè‡ªåŠ¨æ‰©å®¹ï¼Œæ€§èƒ½æœ€å¥½</td>
</tr>
</tbody>
</table>
<h3 id="3-2-slice">3.2 slice</h3>
<p>goè¯­è¨€ä¸­sliceå¯ä»¥ç†è§£ä¸ºåŠ¨æ€æ•°ç»„ï¼ŒåŒºåˆ«äºæ•°ç»„ï¼Œå…¶é•¿åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒå…¶å®¹é‡å¤§å°ä¸å¤Ÿã€‚å½“éœ€è¦å¾€åˆ‡ç‰‡è¿½åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœåˆ‡ç‰‡å®¹é‡å¤§å°ä¸è¶³ï¼Œä¼šè‡ªåŠ¨æ‰©å®¹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">   array unsafe.Pointer</span><br><span class="line">   <span class="built_in">len</span>   <span class="type">int</span></span><br><span class="line">   <span class="built_in">cap</span>   <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>arrayï¼šæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå³åº•å±‚æ•°ç»„ç»“æ„</strong></li>
<li><strong>lenï¼šå½“å‰åˆ‡ç‰‡ä¸­æ•°æ®é•¿åº¦</strong></li>
<li><strong>capï¼šåˆ‡ç‰‡çš„å®¹é‡</strong></li>
</ul>
<div class="note warning simple"><p>capæ˜¯å¤§äºç­‰äºlençš„ï¼Œå½“capå¤§äºlençš„æ—¶å€™ï¼Œè¯´æ˜åˆ‡ç‰‡æœªæ»¡ï¼Œå®ƒä»¬ä¹‹é—´çš„å…ƒç´ å¹¶ä¸å±äºå½“å‰åˆ‡ç‰‡ã€‚</p>
</div>
<p>åˆ‡ç‰‡çš„åˆå§‹åŒ–æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<ol>
<li>é€šè¿‡å·²æœ‰åˆ‡ç‰‡åˆå§‹åŒ–</li>
<li>é€šè¿‡å­—é¢é‡åˆå§‹åŒ–</li>
<li>é€šè¿‡makeå…³é”®å­—åˆå§‹åŒ–</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slice := slice1[<span class="number">1</span>:<span class="number">5</span>]          <span class="comment">// ä»åˆ‡ç‰‡slice1åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„åˆ‡ç‰‡sliceï¼Œsliceçš„å…ƒç´ ä¸ºslice1ä¸­çš„ä¸‹æ ‡ä¸º1åˆ°ä¸‹æ ‡ä¸º4çš„å…ƒç´ </span></span><br><span class="line">slice := []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">slice := <span class="built_in">make</span>([]<span class="type">int</span>&#123;&#125;, <span class="number">3</span>)     <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºlen</span></span><br><span class="line">slice := <span class="built_in">make</span>([]<span class="type">int</span>&#123;&#125;, <span class="number">3</span>, <span class="number">4</span>)  <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºlenï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºcap</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œä¸¤ç§makeåˆ›å»ºçš„æ–¹å¼ï¼Œå½“ä¼ é€’äº†å®¹é‡å‚æ•°æ—¶ï¼Œè‹¥ä¼ é€’çš„å‚æ•°æ¯”å‰é¢lençš„å‚æ•°å€¼å¤§ï¼Œé‚£ä¹ˆå®é™…åˆ›å»ºçš„åˆ‡ç‰‡å¤§å°æ˜¯å¤šä½™å…ƒç´ ä¸ªæ•°çš„ï¼Œè¯´æ˜é¢„ç•™äº†ç©ºé—´ã€‚å¦‚æœä¸æŒ‡å®šcapï¼Œåˆ™é»˜è®¤åˆ›å»ºcapå’Œlenå¤§å°ç›¸åŒçš„åˆ‡ç‰‡ã€‚</p>
<div class="note warning simple"><p>è¢«æˆªå–å‡ºæ¥çš„æ–°åˆ‡ç‰‡åº•å±‚ä»ç„¶æŒ‡å‘åŸåˆ‡ç‰‡çš„åº•å±‚æ•°æ®ï¼Œå¤åˆ¶åçš„åˆ‡ç‰‡ä¹Ÿå’ŒåŸåˆ‡ç‰‡æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸï¼Œä¼šäº’ç›¸å½±å“ï¼ˆå¯ä»¥é€šè¿‡copyå‡½æ•°è§£å†³ï¼‰ã€‚ä½†æ˜¯æ•°ç»„çš„å¤åˆ¶å´ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œè¯´æ˜æ•°ç»„çš„å¤åˆ¶ä¼šåœ¨åº•å±‚ä¼šè¿åŒå¤åˆ¶ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¸åŸæ•°ç»„äº’ä¸å½±å“</p>
</div>
<p>sliceæ˜¯åŠ¨æ€æ•°ç»„ï¼Œå¤§å°ä¸å›ºå®šï¼Œå¯ä»¥å¾€åè¿½åŠ å…ƒç´ ï¼Œè¿½åŠ çš„æ–¹æ³•æ˜¯é€šè¿‡appendå‡½æ•°æ¥å®ç°ï¼Œçœ‹ä¸€ä¸ªæœ‰æ„æ€çš„ä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   arr1 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">   arr1 = <span class="built_in">append</span>(arr1, <span class="number">1</span>)</span><br><span class="line">   arr2 := <span class="built_in">append</span>(arr1, <span class="number">2</span>)</span><br><span class="line">   arr3 := <span class="built_in">append</span>(arr1, <span class="number">3</span>)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;arr1=%v, addr1=%p\n&quot;</span>, arr1, &amp;arr1)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;arr2=%v, addr2=%p\n&quot;</span>, arr2, &amp;arr2)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;arr3=%v, addr3=%p\n&quot;</span>, arr3, &amp;arr3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arr1=[<span class="number">1</span>], addr1=<span class="number">0xc000098060</span></span><br><span class="line">arr2=[<span class="number">1</span> <span class="number">3</span>], addr2=<span class="number">0xc000098078</span></span><br><span class="line">arr3=[<span class="number">1</span> <span class="number">3</span>], addr3=<span class="number">0xc000098090</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸ºä»€ä¹ˆarr2å’Œarr3çš„ç»“æœæ˜¯ä¸€æ ·éƒ½æ˜¯<code>[1,3]</code>å‘¢ï¼Œä¸ºä»€ä¹ˆarr2ä¸æ˜¯<code>[1,2]</code>ï¼Ÿ</p>
<p>åŸç†æ˜¯è¿™æ ·çš„ï¼Œåœ¨å‰é¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“äº†åˆ‡ç‰‡çš„ç»“æ„å®šä¹‰ï¼Œ<code>type slice struct &#123;...&#125;</code>, Go è¯­è¨€å†…ç½®å‡½æ•° append å‚æ•°æ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥ append å‡½æ•°åœ¨è¿½åŠ æ–°å…ƒç´ åˆ°åˆ‡ç‰‡æ—¶ï¼Œappend ä¼šç”Ÿæˆä¸€ä¸ªæ–°åˆ‡ç‰‡ï¼Œå¹¶ä¸”å°†åŸåˆ‡ç‰‡çš„å€¼æ‹·è´åˆ°æ–°åˆ‡ç‰‡ã€‚æ³¨æ„è¿™é‡Œçš„æ–°åˆ‡ç‰‡å¹¶ä¸æ˜¯æŒ‡åº•å±‚çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯æŒ‡<code>slice </code>è¿™ä¸ªç»“æ„ä½“ã€‚æ‰€ä»¥æˆ‘ä»¬<strong>æ¯è°ƒç”¨ä¸€æ¬¡appendå‡½æ•°ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„sliceç»“æ„ä½“ï¼Œä½†æ˜¯ä»–ä»¬åº•å±‚éƒ½æŒ‡å‘åŒä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸ</strong>ï¼Œå³å…±äº«åº•å±‚æ•°ç»„ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>arr3 := append(arr1, 3)</code>å°†<code>arr2</code>åº•å±‚çš„æ•°æ®<code>1ï¼Œ2</code>ç»™è¦†ç›–äº†ã€‚</p>
<p>sliceæ‰©å®¹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/c7a9f7a6586b47d5b2506e46f2908108" alt=""></p>
<p>æ‰©å®¹å…¬ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newcap = oldcap+(oldcap+<span class="number">3</span>*<span class="number">256</span>)/<span class="number">4</span></span><br></pre></td></tr></table></figure>
<h3 id="3-3-map">3.3 map</h3>
<p>mapå°±æ˜¯ä¸€ä¸ªkey/valueé”®å€¼å¯¹é›†åˆï¼Œå¯ä»¥æ ¹æ®keyåœ¨o(1)æ—¶é—´å†…å–åˆ°valueã€‚</p>
<p>åœ¨goè¯­è¨€ä¸­ï¼Œmapçš„åº•å±‚é‡‡ç”¨hashè¡¨ï¼Œç”¨å˜ç§æ‹‰é“¾æ³•æ¥è§£å†³hashå†²çªé—®é¢˜ã€‚</p>
<p>goè¯­è¨€ä¸­çš„mapå…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡å‘<code>hmap</code>çš„æŒ‡é’ˆï¼Œå ç”¨8ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥mapåº•å±‚ç»“æ„å°±æ˜¯<code>hmap</code>ï¼Œ<code>hmap</code>åŒ…å«å¤šä¸ªç»“æ„ä¸º<code>bmap</code>çš„<code>bucket</code>æ•°ç»„ï¼Œ<code>bucket</code>åº•å±‚é‡‡ç”¨é“¾è¡¨ç»“æ„è®²è¿™äº›<code>bmap</code>è¿æ¥èµ·æ¥ï¼Œå¤„ç†å†²çªå…¶å®æ˜¯é‡‡ç”¨äº†ä¼˜åŒ–çš„æ‹‰é“¾æ³•ï¼Œé“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„ä¸æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè€Œæ˜¯8ä¸ªé”®å€¼å¯¹ã€‚å…¶æ•´ä½“çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:%5CUsers%5Chyz%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230412104120305.png" alt="image-20230412104120305"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A header for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go.</span></span><br><span class="line">   <span class="comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class="line">   count     <span class="type">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">   flags     <span class="type">uint8</span></span><br><span class="line">   B         <span class="type">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">   noverflow <span class="type">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">   hash0     <span class="type">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">   buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">   oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">   nevacuate  <span class="type">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line"></span><br><span class="line">   extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>é‡Šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>count</td>
<td>mapä¸­å…ƒç´ ä¸ªæ•°ï¼Œå¯¹åº”äºlen(map)çš„å€¼</td>
</tr>
<tr>
<td>flags</td>
<td>çŠ¶æ€æ ‡å¿—ä½ï¼Œæ ‡è®°mapçš„ä¸€äº›çŠ¶æ€</td>
</tr>
<tr>
<td>B</td>
<td>æ¡¶æ•°ä»¥2ä¸ºåº•çš„å¯¹æ•°ï¼Œå³B=log_2(len(buckets))ï¼Œæ¯”å¦‚B=3ï¼Œé‚£ä¹ˆæ¡¶æ•°ä¸º2^3=8</td>
</tr>
<tr>
<td>noverflow</td>
<td>æº¢å‡ºæ¡¶æ•°é‡è¿‘ä¼¼å€¼</td>
</tr>
<tr>
<td>hash0</td>
<td>å“ˆå¸Œç§å­</td>
</tr>
<tr>
<td>buckets</td>
<td>æŒ‡å‘bucketsæ•°ç»„çš„æŒ‡é’ˆï¼Œbucketsæ•°ç»„çš„å…ƒç´ ä¸ºbmapï¼Œå¦‚æœæ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º0ï¼Œå…¶å€¼ä¸ºnil</td>
</tr>
<tr>
<td>oldbuckets</td>
<td>æ˜¯ä¸€ä¸ªæŒ‡å‘bucketsæ•°ç»„çš„æŒ‡é’ˆï¼Œåœ¨æ‰©å®¹æ—¶ï¼Œoldbuckets æŒ‡å‘è€çš„bucketsæ•°ç»„(å¤§å°ä¸ºæ–°bucketsæ•°ç»„çš„ä¸€åŠ)ï¼Œéæ‰©å®¹æ—¶ï¼Œoldbuckets ä¸ºç©º</td>
</tr>
<tr>
<td>nevacuate</td>
<td>è¡¨ç¤ºæ‰©å®¹è¿›åº¦çš„ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå°äºè¯¥å€¼çš„æ¡¶å·²ç»å®Œæˆè¿ç§»</td>
</tr>
<tr>
<td>extra</td>
<td>æŒ‡å‘mapextra ç»“æ„çš„æŒ‡é’ˆï¼Œmapextra å­˜å‚¨mapä¸­çš„æº¢å‡ºæ¡¶</td>
</tr>
</tbody>
</table>
<p>mapextra ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapextra holds fields that are not present on all maps.</span></span><br><span class="line"><span class="keyword">type</span> mapextra <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// If both key and elem do not contain pointers and are inline, then we mark bucket</span></span><br><span class="line">   <span class="comment">// type as containing no pointers. This avoids scanning such maps.</span></span><br><span class="line">   <span class="comment">// However, bmap.overflow is a pointer. In order to keep overflow buckets</span></span><br><span class="line">   <span class="comment">// alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow.</span></span><br><span class="line">   <span class="comment">// overflow and oldoverflow are only used if key and elem do not contain pointers.</span></span><br><span class="line">   <span class="comment">// overflow contains overflow buckets for hmap.buckets.</span></span><br><span class="line">   <span class="comment">// oldoverflow contains overflow buckets for hmap.oldbuckets.</span></span><br><span class="line">   <span class="comment">// The indirection allows to store a pointer to the slice in hiter.</span></span><br><span class="line">   overflow    *[]*bmap</span><br><span class="line">   oldoverflow *[]*bmap</span><br><span class="line"></span><br><span class="line">   <span class="comment">// nextOverflow holds a pointer to a free overflow bucket.</span></span><br><span class="line">   nextOverflow *bmap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>é‡Šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>overflow</td>
<td>æº¢å‡ºæ¡¶é“¾è¡¨åœ°å€</td>
</tr>
<tr>
<td>oldoverflow</td>
<td>è€çš„æº¢å‡ºæ¡¶é“¾è¡¨åœ°å€</td>
</tr>
<tr>
<td>nextOverflow</td>
<td>ä¸‹ä¸€ä¸ªç©ºé—²æº¢å‡ºæ¡¶åœ°å€</td>
</tr>
</tbody>
</table>
<p><code>hmap</code>ä¸­çœŸæ­£ç”¨äºå­˜å‚¨æ•°æ®çš„æ˜¯<code>buckets</code>æŒ‡å‘çš„è¿™ä¸ª<code>bmap</code>(æ¡¶)æ•°ç»„ï¼Œæ¯ä¸€ä¸ª <code>bmap</code> éƒ½èƒ½å­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹ï¼Œå½“mapä¸­çš„æ•°æ®è¿‡å¤šï¼Œ<code>bmap</code>æ•°ç»„å­˜ä¸ä¸‹çš„æ—¶å€™å°±ä¼šå­˜å‚¨åˆ°extraæŒ‡å‘çš„æº¢å‡ºbucket(æ¡¶)é‡Œé¢ï¼Œå¹¶ä¸”è¿™ä¸¤ç§æ¡¶åœ¨å†…å­˜é‡Œé¢æ˜¯è¿ç»­çš„ã€‚</p>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹bmapçš„ç»“æ„å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    topbits  [<span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    keys     [<span class="number">8</span>]keytype</span><br><span class="line">    values   [<span class="number">8</span>]valuetype</span><br><span class="line">    pad      <span class="type">uintptr</span></span><br><span class="line">    overflow <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>é‡Šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>topbits</td>
<td>å­˜å‚¨äº†bmapé‡Œ8ä¸ªkey/valueé”®å€¼å¯¹çš„æ¯ä¸ªkeyæ ¹æ®å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºçš„hashå€¼çš„é«˜ 8 ä½</td>
</tr>
<tr>
<td>keys</td>
<td>å­˜å‚¨äº†bmapé‡Œ8ä¸ªkey/valueé”®å€¼å¯¹çš„key</td>
</tr>
<tr>
<td>values</td>
<td>å­˜å‚¨äº†bmapé‡Œ8ä¸ªkey/valueé”®å€¼å¯¹çš„value</td>
</tr>
<tr>
<td>overflow</td>
<td>æŒ‡å‘æº¢å‡ºæ¡¶çš„æŒ‡é’ˆ</td>
</tr>
</tbody>
</table>
<p>å†è§£é‡Šä¸€ä¸‹è¿™ä¸ª<code>tophash  </code>ï¼Œgoè¯­è¨€çš„<code>map</code>ä¼šæ ¹æ®æ¯ä¸€ä¸ªkeyè®¡ç®—å‡ºä¸€ä¸ª<code>hash</code>å€¼ï¼Œæœ‰æ„æ€çš„æ˜¯ï¼Œå¯¹è¿™ä¸ª<code>hash</code>å€¼çš„ä½¿ç”¨ï¼Œgoè¯­è¨€å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ä½¿ç”¨çš„ï¼Œè€Œæ˜¯åˆ†å¼€ä½¿ç”¨çš„ï¼Œåœ¨ä½¿ç”¨ä¸­ï¼ŒæŠŠæ±‚å¾—çš„è¿™ä¸ª<code>hash</code>å€¼æŒ‰ç…§ç”¨é€”ä¸€åˆ†ä¸ºäºŒï¼šé«˜ä½å’Œä½ä½</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:%5CUsers%5Chyz%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230412104343061.png" alt="image-20230412104343061"></p>
<p>å‡è®¾æˆ‘ä»¬å¯¹ä¸€ä¸ª<code>key</code>åš<code>hash</code>è®¡ç®—å¾—åˆ°äº†ä¸€ä¸ªhashå€¼å¦‚å›¾æ‰€ç¤ºï¼Œè“è‰²å°±æ˜¯è¿™ä¸ªhashå€¼çš„é«˜8ä½ï¼Œçº¢è‰²å°±æ˜¯è¿™ä¸ªhashå€¼çš„ä½8ä½ã€‚è€Œæ¯ä¸ªbmapä¸­å…¶å®å­˜å‚¨çš„å°±æ˜¯8ä¸ªè¿™ä¸ªè“è‰²çš„æ•°å­—ã€‚bmapæ˜¾ç¤ºå­˜å‚¨äº†8ä¸ª<code>tohash</code>å€¼ï¼Œç„¶åå­˜å‚¨äº†8ä¸ªé”®å€¼å¯¹ï¼Œæ³¨æ„ï¼Œè¿™8ä¸ªé”®å€¼å¯¹å¹¶ä¸æ˜¯æŒ‰ç…§<code>key/value</code>è¿™æ ·<code>key</code>å’Œ<code>value</code>æ”¾åœ¨ä¸€èµ·å­˜å‚¨çš„ï¼Œè€Œæ˜¯å…ˆè¿ç»­å­˜å®Œ8ä¸ª<code>key</code>ï¼Œä¹‹åå†è¿ç»­å­˜å‚¨8ä¸ª<code>value</code>è¿™æ ·ï¼Œå½“é”®å€¼å¯¹ä¸å¤Ÿ8ä¸ªæ—¶ï¼Œå¯¹åº”ä½ç½®å°±ç•™ç©ºã€‚è¿™æ ·å­˜å‚¨çš„å¥½å¤„æ˜¯å¯ä»¥æ¶ˆé™¤å­—èŠ‚å¯¹é½å¸¦æ¥çš„ç©ºé—´æµªè´¹ã€‚</p>
<p><strong>mapçš„è®¿é—®åŸç†</strong></p>
<p>å¯¹mapçš„è®¿é—®æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v     := <span class="keyword">map</span>[key]    <span class="comment">// å½“mapä¸­æ²¡æœ‰å¯¹åº”çš„keyæ—¶ï¼Œä¼šè¿”å›valueå¯¹åº”ç±»å‹çš„é›¶å€¼</span></span><br><span class="line">v, ok := <span class="keyword">map</span>[key]    <span class="comment">// å½“mapä¸­æ²¡æœ‰å¯¹åº”çš„keyæ—¶ï¼Œé™¤äº†ä¼šè¿”å›valueå¯¹åº”ç±»å‹çš„é›¶å€¼,è¿˜ä¼šè¿”å›ä¸€ä¸ªå€¼å­˜ä¸å­˜åœ¨çš„å¸ƒå°”å€¼</span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶è¿™ä¸¤ç§æ–¹æ³•åœ¨è¿”å›å€¼ä¸Šå¾ˆæ¥è¿‘ï¼Œåè€…åªæ˜¯å¤šå‡ºäº†ä¸€ä¸ªkeyå­˜ä¸å­˜åœ¨çš„å¸ƒå°”å€¼ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶è°ƒç”¨çš„æ–¹æ³•å´ä¸ä¸€æ ·ã€‚</p>
<p>å¯¹äº<code>v:=map[key]</code>è¿™ç§è®¿é—®æ–¹å¼ï¼Œåœ¨è¿è¡Œæ—¶å…¶å®æ—¶è°ƒç”¨çš„<code>runtime.mapaccess1</code>æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapaccess1 returns a pointer to h[key].  Never returns nil, instead</span></span><br><span class="line"><span class="comment">// it will return a reference to the zero object for the elem type if</span></span><br><span class="line"><span class="comment">// the key is not in the map.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The returned pointer may keep the whole map live, so don&#x27;t</span></span><br><span class="line"><span class="comment">// hold onto it for very long.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapaccess1</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line">   <span class="keyword">if</span> raceenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line">      callerpc := getcallerpc()</span><br><span class="line">      pc := abi.FuncPCABIInternal(mapaccess1)</span><br><span class="line">      racereadpc(unsafe.Pointer(h), callerpc, pc)</span><br><span class="line">      raceReadObjectPC(t.key, key, callerpc, pc)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> msanenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line">      msanread(key, t.key.size)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> asanenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line">      asanread(key, t.key.size)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> h == <span class="literal">nil</span> || h.count == <span class="number">0</span> &#123;  <span class="comment">// hmapä¸ºç©ºæˆ–è€…æ²¡æœ‰æ•°æ®</span></span><br><span class="line">      <span class="keyword">if</span> t.hashMightPanic() &#123;</span><br><span class="line">         t.hasher(key, <span class="number">0</span>) <span class="comment">// see issue 23734</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])   <span class="comment">// è¿”å›é›¶å€¼</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// mapæ­£åœ¨è¢«å†™æ“ä½œï¼Œä¸å…è®¸è¯»å–ï¼Œä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œå‘ç”Ÿpanic</span></span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">      throw(<span class="string">&quot;concurrent map read and map write&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   hash := t.hasher(key, <span class="type">uintptr</span>(h.hash0))   <span class="comment">// æ ¹æ®keyå’Œhashç§å­è®¡ç®—å‡ºhashå€¼</span></span><br><span class="line">   m := bucketMask(h.B)    <span class="comment">// æ ¹æ®Bè®¡ç®—é™¤mask</span></span><br><span class="line">   b := (*bmap)(add(h.buckets, (hash&amp;m)*<span class="type">uintptr</span>(t.bucketsize)))  <span class="comment">// æ ¹æ®hashçš„ä½Bä½è®¡ç®—å‡ºkeyåœ¨å“ªä¸ªbucketä¸­ï¼Œæ‰¾åˆ°å¯¹åº”çš„bucket</span></span><br><span class="line">   <span class="keyword">if</span> c := h.oldbuckets; c != <span class="literal">nil</span> &#123;    <span class="comment">//  åœ¨æ‰©å®¹</span></span><br><span class="line">      <span class="keyword">if</span> !h.sameSizeGrow() &#123;  <span class="comment">// ä¸æ˜¯ç­‰é‡æ‰©å®¹ï¼Œè¯´æ˜æ˜¯åŒå€æ‰©å®¹ï¼Œä½¿ç”¨æ—§æ¡¶çš„æ©ç æŸ¥æ‰¾</span></span><br><span class="line">         <span class="comment">// There used to be half as many buckets; mask down one more power of two.</span></span><br><span class="line">         m &gt;&gt;= <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">      oldb := (*bmap)(add(c, (hash&amp;m)*<span class="type">uintptr</span>(t.bucketsize))) <span class="comment">// æ ¹æ®æ©ç å’Œhashå€¼æ‰¾åˆ°è¿™ä¸ªkeyå¯¹åº”çš„æ¡¶</span></span><br><span class="line">      <span class="keyword">if</span> !evacuated(oldb) &#123;  <span class="comment">// æ ¹æ®tophash[0]çš„çŠ¶æ€ä¸ºæ¥åˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦è¿˜æ²¡æœ‰è¢«è¿ç§»ï¼Œè¿˜åœ¨æ—§æ¡¶ä¸­</span></span><br><span class="line">         b = oldb</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   top := tophash(hash)  <span class="comment">// æ ¹æ®hashå€¼è®¡ç®—å‡ºtophash</span></span><br><span class="line">bucketloop:    <span class="comment">// éå†å½“å‰æ¡¶å’Œå…¶æŒ‡å‘çš„æº¢å‡ºæ¡¶</span></span><br><span class="line">   <span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line">      <span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; bucketCnt; i++ &#123;  <span class="comment">// éå†æ¡¶å†…çš„8ä¸ªæ§½ä½</span></span><br><span class="line">         <span class="comment">// è¯¥æ§½ä½çš„tophashå’Œå½“å‰keyçš„tophashä¸ç›¸ç­‰ï¼Œåˆ¤æ–­è¯¥æ§½ä½çš„tophashçŠ¶æ€ä½</span></span><br><span class="line">         <span class="comment">// è‹¥çŠ¶æ€ä½æ˜¯&quot;åç»§ç©ºçŠ¶æ€&quot;ï¼Œåˆ™è¯´æ˜åç»§æ²¡æœ‰æ•°æ®äº†ï¼Œå¯ä»¥æå‰é€€å‡ºå‘ï¼Œè¿”å›é›¶å€¼ï¼Œå¦åˆ™å°±ç»§ç»­éå†ä¸‹ä¸€ä¸ªæ§½ä½</span></span><br><span class="line">         <span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line">            <span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line">               <span class="keyword">break</span> bucketloop</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// è¯¥æ§½ä½çš„tophashå’Œå½“å‰keyçš„tophashç›¸ç­‰</span></span><br><span class="line">         k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">         <span class="keyword">if</span> t.indirectkey() &#123;</span><br><span class="line">            k = *((*unsafe.Pointer)(k))</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// ç»§ç»­åˆ¤æ–­å½“å‰æ§½ä½çš„å¯¹åº”çš„keyäºå½“å‰keyæ˜¯å¦ç›¸åŒäº†ç›¸åŒå°±æ ¹æ®æŒ‡é’ˆåç§»æŸ¥æ‰¾åˆ°å¯¹åº”çš„valueè¿”å›ï¼Œä¸ç›¸åŒå°±ç»§ç»­ä¾¿åˆ©ä¸‹ä¸€ä¸ªæ§½ä½</span></span><br><span class="line">         <span class="keyword">if</span> t.key.equal(key, k) &#123;</span><br><span class="line">            e := add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+i*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">            <span class="keyword">if</span> t.indirectelem() &#123;</span><br><span class="line">               e = *((*unsafe.Pointer)(e))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> e</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:%5CUsers%5Chyz%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230412110401761.png" alt="image-20230412110401761"></p>
<ol>
<li>åˆ¤æ–­mapæ˜¯å¦ä¸ºç©ºæˆ–è€…æ— æ•°æ®ï¼Œè‹¥ä¸ºç©ºæˆ–è€…æ— æ•°æ®è¿”å›å¯¹åº”çš„ç©ºå€¼</li>
<li>mapå†™æ£€æµ‹ï¼Œå¦‚æœæ­£å¤„äºå†™çŠ¶æ€ï¼Œè¡¨ç¤ºæ­¤æ—¶ä¸èƒ½è¿›è¡Œè¯»å–ï¼ŒæŠ¥panic</li>
<li>è®¡ç®—å‡ºhashå€¼å’Œæ©ç </li>
<li>åˆ¤æ–­å½“å‰mapæ˜¯å¦å¤„äºæ‰©å®¹çŠ¶æ€ï¼Œå¦‚æœåœ¨æ‰©å®¹æ‰§è¡Œä¸‹é¢æ­¥éª¤ï¼š
<ol>
<li>æ ¹æ®çŠ¶æ€ä½ç®—åˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦è¢«è¿ç§»</li>
<li>è¢«è¿ç§»ï¼Œåœ¨æ–°æ¡¶ä¸­æŸ¥æ‰¾</li>
<li>æœªè¢«è¿ç§»ï¼Œåœ¨æ—§æ¡¶ä¸­æŸ¥æ‰¾</li>
<li>æ ¹æ®æ©ç æ‰¾åˆ°çš„ä½ç½®</li>
</ol>
</li>
<li>ä¾æ¬¡éå†æ¡¶ä»¥åŠæº¢å‡ºæ¡¶æ¥æŸ¥æ‰¾key
<ol>
<li>éå†æ¡¶å†…çš„8ä¸ªæ§½ä½</li>
<li>æ¯”è¾ƒè¯¥æ§½ä½çš„tophashå’Œå½“å‰keyçš„tophashæ˜¯å¦ç›¸ç­‰
<ul>
<li>ç›¸åŒï¼Œç»§ç»­æ¯”è¾ƒkeyæ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™ç›´æ¥è¿”å›å¯¹åº”value</li>
<li>ä¸ç›¸åŒï¼ŒæŸ¥çœ‹è¿™ä¸ªæ§½ä½çš„çŠ¶æ€ä½æ˜¯å¦ä¸º&quot;åç»§ç©ºçŠ¶æ€&quot;
<ul>
<li>æ˜¯ï¼Œkeyåœ¨ä»¥åçš„æ§½ä¸­ä¹Ÿæ²¡æœ‰ï¼Œè¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›é›¶å€¼</li>
<li>å¦ï¼Œéå†ä¸‹ä¸€ä¸ªæ§½ä½</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>å½“å‰æ¡¶æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™éå†æº¢å‡ºæ¡¶ï¼Œç”¨åŒæ ·çš„æ–¹å¼æŸ¥æ‰¾</li>
</ol>
<p>mapçš„èµ‹å€¼æ“ä½œåœ¨è¿è¡Œæ—¶ï¼Œå…¶å®æ˜¯è°ƒç”¨äº†runtime.mapassignå‡½æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapassign</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line">   <span class="keyword">if</span> h == <span class="literal">nil</span> &#123;    <span class="comment">// mapä¸ºç©ºï¼Œä¸å¯å†™ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="built_in">panic</span>(plainError(<span class="string">&quot;assignment to entry in nil map&quot;</span>))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> raceenabled &#123;  </span><br><span class="line">      callerpc := getcallerpc()</span><br><span class="line">      pc := abi.FuncPCABIInternal(mapassign)</span><br><span class="line">      racewritepc(unsafe.Pointer(h), callerpc, pc)</span><br><span class="line">      raceReadObjectPC(t.key, key, callerpc, pc)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">      msanread(key, t.key.size)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> asanenabled &#123;</span><br><span class="line">      asanread(key, t.key.size)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;   <span class="comment">// å¹¶å‘é—®é¢˜ï¼Œmapæ­£åœ¨è¢«å†™ï¼Œpanic</span></span><br><span class="line">      throw(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   hash := t.hasher(key, <span class="type">uintptr</span>(h.hash0))  <span class="comment">// æ ¹æ®keyå’Œhashç§å­è®¡ç®—hashå€¼</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set hashWriting after calling t.hasher, since t.hasher may panic,</span></span><br><span class="line">   <span class="comment">// in which case we have not actually done a write.</span></span><br><span class="line">   h.flags ^= hashWriting   <span class="comment">// å°†mapçš„çŠ¶æ€ç½®ä¸ºå†™</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> h.buckets == <span class="literal">nil</span> &#123;  <span class="comment">// å¦‚æœæ­£å¸¸çš„æ¡¶æ•°ç»„ä¸ºç©ºï¼Œåˆå§‹åŒ–æ¡¶æ•°ç»„</span></span><br><span class="line">      h.buckets = newobject(t.bucket) <span class="comment">// newarray(t.bucket, 1)</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">   bucket := hash &amp; bucketMask(h.B)  <span class="comment">// æ ¹æ®hashå€¼æ‰¾åˆ°æ¡¶çš„ä½ç½®</span></span><br><span class="line">   <span class="keyword">if</span> h.growing() &#123;  <span class="comment">// mapæ­£åœ¨æ‰©å®¹ï¼Œå°†è‡ªå·±è¦ä½¿ç”¨çš„é€šçš„æ•°é‡è¿ç§»åˆ°æ–°æ¡¶</span></span><br><span class="line">      growWork(t, h, bucket)</span><br><span class="line">   &#125;</span><br><span class="line">   b := (*bmap)(add(h.buckets, bucket*<span class="type">uintptr</span>(t.bucketsize))) <span class="comment">// è·Ÿè®¿é—®æ—¶ä¸€æ ·ï¼Œè¿™ä¸€æ­¥æ˜¯è·å¾—ç›®æ ‡æ¡¶æŒ‡é’ˆï¼Œå¦‚æœå‘ç”Ÿäº†æ‰©å®¹ï¼Œåˆ™è¿™ä¸ªæ¡¶æŒ‡é’ˆæ˜¯æ–°æ¡¶æŒ‡é’ˆ</span></span><br><span class="line">   top := tophash(hash)  <span class="comment">// è®¡ç®—tophash</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> inserti *<span class="type">uint8</span>                 <span class="comment">// å¾…èµ‹å€¼çš„tophashæŒ‡é’ˆ</span></span><br><span class="line">   <span class="keyword">var</span> insertk unsafe.Pointer         <span class="comment">// å¾…èµ‹å€¼çš„keyæŒ‡é’ˆ</span></span><br><span class="line">   <span class="keyword">var</span> elem unsafe.Pointer            <span class="comment">// å¾…èµ‹å€¼çš„valueæŒ‡é’ˆ</span></span><br><span class="line">bucketloop:    <span class="comment">// å¾ªç¯éå†mapä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªkey</span></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; bucketCnt; i++ &#123;   <span class="comment">// éå†ä¸€ä¸ªæ¡¶ä¸­çš„8ä¸ªæ§½ä½</span></span><br><span class="line">         <span class="keyword">if</span> b.tophash[i] != top &#123;   <span class="comment">// æ§½ä½tophashä¸ç›®æ ‡tophashä¸ç›¸ç­‰</span></span><br><span class="line">            <span class="comment">// åˆ¤æ–­è¯¥æ§½ä½çš„tophashæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœè¯¥æ§½ä½çš„tophashä¸ºç©ºè¯´æ˜è¯¥æ§½ä½å¯èƒ½å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æ’å…¥ç›®æ ‡é”®å€¼å¯¹çš„ä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> isEmpty(b.tophash[i]) &amp;&amp; inserti == <span class="literal">nil</span> &#123;</span><br><span class="line">               inserti = &amp;b.tophash[i]</span><br><span class="line">               insertk = add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">               elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+i*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥æ§½ä½çš„æ€ä½ä¸ºâ€œåç»§ç©ºçŠ¶æ€â€ï¼Œè¯´æ˜keyä¹‹å‰æ²¡æœ‰è¢«æ’å…¥è¿‡ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯çœŸå®çš„æ’å…¥ä½ç½®ï¼Œæ‰¾åˆ°äº†ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line">               <span class="keyword">break</span> bucketloop</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ‰¾çš„æ§½ä½ä¸æ»¡è¶³ï¼Œéå†ä¸‹ä¸€ä¸ªæ§½ä½</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// æ§½ä½çš„tophashä¸ç›®æ ‡tophashç›¸åŒï¼Œæ¥ç€è·å–è¯¥æ§½ä½çš„keyè¿›è¡Œå¯¹æ¯”</span></span><br><span class="line">         k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">         <span class="keyword">if</span> t.indirectkey() &#123;</span><br><span class="line">            k = *((*unsafe.Pointer)(k))</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tophashç›¸åŒï¼Œä½†æ˜¯keyä¸åŒï¼Œç»§ç»­éå†ä¸‹ä¸€ä¸ªæ§½</span></span><br><span class="line">         <span class="keyword">if</span> !t.key.equal(key, k) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// already have a mapping for key. Update it.</span></span><br><span class="line">         <span class="comment">// æ‰¾åˆ°Keyäº†,æ›´æ–°è¿™ä¸ªæ§½ä½ä¸­çš„valueä¸ºæ–°çš„value</span></span><br><span class="line">         <span class="keyword">if</span> t.needkeyupdate() &#123;</span><br><span class="line">            typedmemmove(t.key, k, key)</span><br><span class="line">         &#125;</span><br><span class="line">         elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+i*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">         <span class="keyword">goto</span> done   <span class="comment">// è·³åˆ°ç»“å°¾</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// éå†ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶</span></span><br><span class="line">      ovf := b.overflow(t)</span><br><span class="line">      <span class="keyword">if</span> ovf == <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      b = ovf</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜mapä¸­æ²¡æœ‰å¾…èµ‹å€¼çš„keyï¼Œéœ€è¦æ–°å¢é”®å€¼å¯¹key/value</span></span><br><span class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ‰©å®¹æ¡ä»¶</span></span><br><span class="line">   <span class="comment">// å¦‚æœæ»¡è¶³ï¼Œå…ˆåšå¥½æ‰©å®¹å‡†å¤‡ï¼Œè¿”å›againå†æ£€æŸ¥ä¸€æ¬¡</span></span><br><span class="line">   <span class="keyword">if</span> !h.growing() &amp;&amp; (overLoadFactor(h.count+<span class="number">1</span>, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) &#123;</span><br><span class="line">      hashGrow(t, h)</span><br><span class="line">      <span class="keyword">goto</span> again <span class="comment">// Growing the table invalidates everything, so try again</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// åˆ°è¿™ä¸€æ­¥ï¼Œmapä¸­æ—¢æ²¡æœ‰æ‰¾åˆ°keyï¼Œæ ¹æ®è¿™ä¸ªkeyæ‰¾åˆ°çš„æ¡¶åŠå…¶è¿™ä¸ªæ¡¶çš„æº¢å‡ºæ¡¶ä¸­æ²¡æœ‰ç©ºçš„æ§½ä½äº†ï¼Œè¦ç”³è¯·ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶</span></span><br><span class="line">   <span class="keyword">if</span> inserti == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// The current bucket and all the overflow buckets connected to it are full, allocate a new one.</span></span><br><span class="line">      newb := h.newoverflow(t, b) <span class="comment">// ç”³è¯·ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶,ä¸‹é¢ä¸‰ä¸ªæ“ä½œå°†insertiï¼Œinsertkï¼Œelemå…¨éƒ¨æŒ‡å‘æ–°çš„æº¢å‡ºæ¡¶çš„ç¬¬ä¸€ä¸ªæ§½</span></span><br><span class="line">      inserti = &amp;newb.tophash[<span class="number">0</span>]   </span><br><span class="line">      insertk = add(unsafe.Pointer(newb), dataOffset)</span><br><span class="line">      elem = add(insertk, bucketCnt*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// store new key/elem at insert position</span></span><br><span class="line">   <span class="comment">// åœ¨æ’å…¥çš„ä½ç½®å­˜å‚¨key/valueé”®å€¼å¯¹</span></span><br><span class="line">   <span class="keyword">if</span> t.indirectkey() &#123;</span><br><span class="line">      kmem := newobject(t.key)</span><br><span class="line">      *(*unsafe.Pointer)(insertk) = kmem</span><br><span class="line">      insertk = kmem</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> t.indirectelem() &#123;</span><br><span class="line">      vmem := newobject(t.elem)</span><br><span class="line">      *(*unsafe.Pointer)(elem) = vmem</span><br><span class="line">   &#125;</span><br><span class="line">   typedmemmove(t.key, insertk, key)</span><br><span class="line">   *inserti = top</span><br><span class="line">   h.count++  <span class="comment">// mapå…ƒç´ æ•°é‡+1</span></span><br><span class="line"></span><br><span class="line">done:   <span class="comment">// æ”¶å°¾å·¥ä½œ</span></span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;hashWriting == <span class="number">0</span> &#123;  <span class="comment">// å†æ¬¡åˆ¤æ–­mapæ˜¯å¦æ­£åœ¨è¢«å†™å…¥ï¼Œè¿™é‡Œåº”è¯¥æ˜¯æ­£åœ¨è¢«å†™å…¥ï¼Œå¦‚æœå¾—åˆ°éï¼Œè¯´æ˜çŠ¶æ€è¢«æ”¹äº†ï¼Œå‘ç”Ÿäº†å¹¶å‘å†™ï¼ŒæŠ¥panicï¼Œç›¸å½“äºä¹è§‚é”</span></span><br><span class="line">      throw(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   h.flags &amp;^= hashWriting  <span class="comment">// æ¸…é™¤mapçš„å†™çŠ¶æ€</span></span><br><span class="line">   <span class="keyword">if</span> t.indirectelem() &#123;</span><br><span class="line">      elem = *((*unsafe.Pointer)(elem))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´æµç¨‹ï¼š</p>
<ol>
<li>mapå†™æ£€æµ‹ï¼Œå¦‚æœæ­£å¤„äºå†™çŠ¶æ€ï¼Œè¡¨ç¤ºæ­¤æ—¶ä¸èƒ½è¿›è¡Œè¯»å–ï¼ŒæŠ¥panic</li>
<li>è®¡ç®—å‡ºhashå€¼ï¼Œå°†mapç½®ä¸ºå†™çŠ¶æ€</li>
<li>åˆ¤æ–­æ¡¶æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºï¼Œåˆå§‹åŒ–æ¡¶æ•°ç»„</li>
<li>ç›®æ ‡æ¡¶æŸ¥æ‰¾
<ol>
<li>æ ¹æ®hashå€¼æ‰¾åˆ°æ¡¶çš„ä½ç½®</li>
<li>åˆ¤æ–­è¯¥å½“å‰æ˜¯å¦å¤„äºæ‰©å®¹ï¼š
<ol>
<li>è‹¥æ­£åœ¨æ‰©å®¹ï¼šè¿ç§»è¿™ä¸ªæ¡¶ï¼Œå¹¶ä¸”è¿˜å¦å¤–å¸®å¿™å¤šè¿ç§»ä¸€ä¸ªæ¡¶ä»¥åŠå®ƒçš„æº¢å‡ºæ¡¶</li>
</ol>
</li>
<li>è·å–ç›®æ ‡æ¡¶çš„æŒ‡é’ˆï¼Œè®¡ç®—å‡ºtophashï¼Œå¼€å§‹åé¢çš„keyæŸ¥æ‰¾è¿‡ç¨‹</li>
</ol>
</li>
<li>keyæŸ¥æ‰¾
<ol>
<li>éå†æ¡¶å’Œå®ƒçš„æº¢å‡ºæ¡¶çš„æ¯ä¸ªæ§½ä½ï¼ŒæŒ‰ä¸‹è¿°æ–¹å¼æŸ¥æ‰¾</li>
<li>åˆ¤æ–­æ§½ä½çš„tophashå’Œç›®æ ‡tophash
<ol>
<li>ä¸ç›¸ç­‰
<ol>
<li>æ§½ä½tophashä¸ºç©ºï¼Œæ ‡è®°è¿™ä¸ªä½ç½®ä¸ºä¾¯é€‰ä½ç½®</li>
<li>æ§½ä½tophashçš„æ ‡å¿—ä½ä¸ºâ€œåç»§ç©ºçŠ¶æ€â€ï¼Œè¯´æ˜è¿™ä¸ªkeyä¹‹å‰æ²¡æœ‰è¢«æ’å…¥è¿‡ï¼Œæ’å…¥key/value</li>
<li>tophashæ ‡å¿—ä½ä¸ä¸ºç©ºï¼Œè¯´æ˜å­˜å‚¨ç€å…¶ä»–keyï¼Œè¯´æ˜å½“å‰æ§½çš„tophashä¸ç¬¦åˆï¼Œç»§ç»­éå†ä¸‹ä¸€ä¸ªæ§½</li>
</ol>
</li>
<li>ç›¸ç­‰
<ol>
<li>åˆ¤æ–­å½“å‰æ§½ä½çš„keyä¸ç›®æ ‡keyæ˜¯å¦ç›¸ç­‰
<ol>
<li>ä¸ç›¸ç­‰ï¼Œç»§ç»­éå†ä¸‹ä¸€ä¸ªæ§½ä½</li>
<li>ç›¸ç­‰ï¼Œæ‰¾åˆ°äº†ç›®æ ‡keyçš„ä½ç½®ï¼ŒåŸæ¥å·²å­˜åœ¨é”®å€¼å¯¹ï¼Œåˆ™ä¿®æ”¹keyå¯¹åº”çš„valueï¼Œç„¶åæ‰§è¡Œæ”¶å°¾ç¨‹</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>keyæ’å…¥
<ol>
<li>è‹¥mapä¸­æ—¢æ²¡æœ‰æ‰¾åˆ°keyï¼Œä¸”æ ¹æ®è¿™ä¸ªkeyæ‰¾åˆ°çš„æ¡¶åŠå…¶è¿™ä¸ªæ¡¶çš„æº¢å‡ºæ¡¶ä¸­æ²¡æœ‰ç©ºçš„æ§½ä½äº†ï¼Œè¦ç”³è¯·ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶ï¼Œåœ¨æ–°ç”³è¯·çš„æ¡¶é‡Œæ’å…¥</li>
<li>å¦åˆ™åœ¨æ‰¾åˆ°çš„ä½ç½®æ’å…¥</li>
</ol>
</li>
<li>æ”¶å°¾ç¨‹åº
<ol>
<li>å†æ¬¡åˆ¤æ–­mapçš„å†™çŠ¶æ€</li>
<li>æ¸…é™¤mapçš„å†™çŠ¶æ€</li>
</ol>
</li>
</ol>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šç”³è¯·ä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶çš„æ—¶å€™å¹¶ä¸ä¼šä¸€å¼€å§‹å°±åˆ›å»ºä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œå› ä¸ºmapåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæå‰åˆ›å»ºå¥½ä¸€äº›æº¢å‡ºæ¡¶å­˜å‚¨åœ¨extra*mapextraå­—æ®µï¼Œæ ·å½“å‡ºç°æº¢å‡ºç°è±¡æ—¶å€™ï¼Œè¿™äº›ä¸‹æº¢å‡ºæ¡¶ä¼šä¼˜å…ˆè¢«ä½¿ç”¨ï¼Œåªæœ‰é¢„åˆ†é…çš„æº¢å‡ºæ¡¶ä½¿ç”¨å®Œäº†ï¼Œæ‰ä¼šæ–°å»ºæº¢å‡ºæ¡¶ã€‚</p>
<p><strong>mapçš„æ‰©å®¹</strong></p>
<p>å¯ä»¥çœ‹åˆ°mapä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹è§¦å‘æ‰©å®¹ï¼š</p>
<ul>
<li>**mapçš„è´Ÿè½½å› å­å·²ç»è¶…è¿‡ 6.5 **  åŒå€æ‰©å®¹</li>
<li><strong>æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤š</strong>   ç­‰é‡æ‰©å®¹(ä¸€èˆ¬è®¤ä¸ºæº¢å‡ºæ¡¶æ•°é‡æ¥è¿‘æ•°ç»„åŒæ•°é‡æ—¶)</li>
</ul>
<p><strong>è´Ÿè½½å› å­ = å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡ / æ¡¶çš„æ•°é‡</strong></p>
<p><strong>ä¸ºä»€ä¹ˆè´Ÿè½½å› å­æ˜¯6.5ï¼Ÿ</strong></p>
<p>æºç é‡Œå¯¹è´Ÿè½½å› å­çš„å®šä¹‰æ˜¯6.5ï¼Œæ˜¯ç»è¿‡æµ‹è¯•åå–å‡ºçš„ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„å€¼ï¼Œ</p>
<p>æ¯ä¸ª bucket æœ‰ 8 ä¸ªç©ºä½ï¼Œå‡è®¾mapé‡Œæ‰€æœ‰çš„æ•°ç»„æ¡¶éƒ½è£…æ»¡å…ƒç´ ï¼Œæ²¡æœ‰ä¸€ä¸ªæ•°ç»„æ¡¶æœ‰æº¢å‡ºæ¡¶ï¼Œé‚£ä¹ˆè¿™æ—¶çš„è´Ÿè½½å› å­åˆšå¥½æ˜¯8ã€‚è€Œè´Ÿè½½å› å­æ˜¯6.5çš„æ—¶å€™ï¼Œè¯´æ˜æ•°ç»„åŒå¿«è¦ç”¨å®Œäº†ï¼Œå­˜åœ¨æº¢å‡ºçš„æƒ…å†µä¸‹ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªkeyå¾ˆå¯èƒ½è¦å»éå†æº¢å‡ºæ¡¶ï¼Œä¼šé€ æˆæŸ¥æ‰¾æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥æœ‰å¿…è¦æ‰©å®¹äº†</p>
<p><strong>æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤šï¼Ÿ</strong></p>
<p>å¯ä»¥æƒ³è±¡ä¸€ä¸‹è¿™ç§æƒ…å†µï¼Œå…ˆå¾€ä¸€ä¸ªmapæ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œç„¶åå†åˆ é™¤å¾ˆå¤šå…ƒç´ ï¼Ÿåœ¨æ’å…¥å¾ˆå¤šå…ƒç´ ã€‚ä¼šé€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p>ç”±äºæ’å…¥äº†å¾ˆå¤šå…ƒç´ ï¼Œåœ¨ä¸æ˜¯å®Œå…¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œè‚¯å®šä¼šåˆ›å»ºä¸€äº›æº¢å‡ºæ¡¶ï¼Œä½†æ˜¯ï¼Œåˆç”±äºæ²¡æœ‰è¾¾åˆ°è´Ÿè½½å› å­çš„ä¸´ç•Œå€¼ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘æ‰©å®¹ï¼Œåœ¨åˆ é™¤å¾ˆå¤šå…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™è´Ÿè½½å› å­åˆä¼šå‡å°ï¼Œå†æ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œä¼šç»§ç»­åˆ›å»ºæ›´å¤šçš„æº¢å‡ºæ¡¶ï¼Œå¯¼è‡´æŸ¥æ‰¾å…ƒç´ çš„æ—¶å€™è¦å»éå†å¾ˆå·®è¿‡çš„æº¢å‡ºæ¡¶é“¾è¡¨ï¼Œæ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹è¦è¿›è¡Œæ‰©å®¹ï¼Œæ–°å»ºä¸€ä¸ªæ¡¶æ•°ç»„ï¼ŒæŠŠåŸæ¥çš„æ•°æ®æ‹·è´åˆ°é‡Œé¢ï¼Œè¿™æ ·æ•°æ®æ’åˆ—æ›´ç´§å¯†ï¼ŒæŸ¥æ‰¾æ€§èƒ½æ›´å¿«ã€‚</p>
<p><strong>æ‰©å®¹è¿‡ç¨‹</strong></p>
<p>æ‰©å®¹è¿‡ç¨‹ä¸­å¤§æ¦‚éœ€è¦ç”¨åˆ°ä¸¤ä¸ªå‡½æ•°ï¼Œ<strong>hashGrow()å’ŒgrowWork()ã€‚</strong></p>
<p>æ‰©å®¹å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashGrow</span><span class="params">(t *maptype, h *hmap)</span></span> &#123;</span><br><span class="line">   <span class="comment">// If we&#x27;ve hit the load factor, get bigger.</span></span><br><span class="line">   <span class="comment">// Otherwise, there are too many overflow buckets,</span></span><br><span class="line">   <span class="comment">// so keep the same number of buckets and &quot;grow&quot; laterally.</span></span><br><span class="line">   bigger := <span class="type">uint8</span>(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">if</span> !overLoadFactor(h.count+<span class="number">1</span>, h.B) &#123;</span><br><span class="line">      bigger = <span class="number">0</span></span><br><span class="line">      h.flags |= sameSizeGrow</span><br><span class="line">   &#125;</span><br><span class="line">   oldbuckets := h.buckets</span><br><span class="line">   newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">   flags := h.flags &amp;^ (iterator | oldIterator)</span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;iterator != <span class="number">0</span> &#123;</span><br><span class="line">      flags |= oldIterator</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// commit the grow (atomic wrt gc)</span></span><br><span class="line">   h.B += bigger</span><br><span class="line">   h.flags = flags</span><br><span class="line">   h.oldbuckets = oldbuckets</span><br><span class="line">   h.buckets = newbuckets</span><br><span class="line">   h.nevacuate = <span class="number">0</span></span><br><span class="line">   h.noverflow = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> h.extra != <span class="literal">nil</span> &amp;&amp; h.extra.overflow != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// Promote current overflow buckets to the old generation.</span></span><br><span class="line">      <span class="keyword">if</span> h.extra.oldoverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">         throw(<span class="string">&quot;oldoverflow is not nil&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      h.extra.oldoverflow = h.extra.overflow</span><br><span class="line">      h.extra.overflow = <span class="literal">nil</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> h.extra == <span class="literal">nil</span> &#123;</span><br><span class="line">         h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">      &#125;</span><br><span class="line">      h.extra.nextOverflow = nextOverflow</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the actual copying of the hash table data is done incrementally</span></span><br><span class="line">   <span class="comment">// by growWork() and evacuate().</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>goè¯­è¨€åœ¨å¯¹mapè¿›è¡Œè¿‡æ‰©å®¹çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§å°†mapçš„æ‰€æœ‰æ•°æ®ä»æ—§çš„æ¡¶æ¬åˆ°æ–°çš„æ¡¶ï¼Œå¦‚æœmapçš„æ•°æ®é‡å¾ˆå¤§ï¼Œä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§â€œæ¸è¿›å¼â€çš„æ•°æ®è½¬ç§»æŠ€æœ¯ï¼Œéµå¾ªå†™æ—¶å¤åˆ¶ï¼ˆcopy on writeï¼‰çš„è§„åˆ™ï¼Œæ¯æ¬¡åªå¯¹ä½¿ç”¨åˆ°çš„æ•°æ®åšè¿ç§»ã€‚</p>
<p>ç®€å•åˆ†æä¸€ä¸‹æ‰©å®¹è¿‡ç¨‹ï¼š</p>
<p>é€šè¿‡ä»£ç åˆ†æï¼Œ<code>hashGrow()</code>å‡½æ•°æ˜¯åœ¨mapassignå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥ï¼Œæ‰©å®¹è¿‡ç¨‹ä¼šå‘ç”Ÿåœ¨mapçš„èµ‹å€¼æ“ä½œï¼Œåœ¨æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ‰©å®¹æ¡ä»¶æ—¶è§¦å‘ã€‚</p>
<p>æ‰©å®¹è¿‡ç¨‹ä¸­å¤§æ¦‚éœ€è¦ç”¨åˆ°ä¸¤ä¸ªå‡½æ•°ï¼Œ**<code>hashGrow()</code><strong><strong>å’Œ</strong></strong><code>growWork()</code>****ã€‚**å…¶ä¸­hashGrow()å‡½æ•°åªæ˜¯åˆ†é…æ–°çš„ bucketsï¼Œå¹¶å°†è€çš„ buckets æŒ‚åˆ°äº† oldbuckets å­—æ®µä¸Šï¼Œå¹¶æœªå‚ä¸çœŸæ­£çš„æ•°æ®è¿ç§»ï¼Œè€Œæ•°æ®è¿ç§»çš„åŠŸèƒ½æ˜¯ç”±growWork()å‡½æ•°å®Œæˆçš„ã€‚</p>
<p><strong>mapçš„åˆ é™¤åŸç†</strong></p>
<p>å¦‚æœåœ¨æ‰¾åˆ°äº†ç›®æ ‡keyï¼Œåˆ™æŠŠå½“å‰æ¡¶è¯¥æ§½ä½å¯¹åº”çš„keyå’Œvalueåˆ é™¤ï¼Œå°†è¯¥æ§½ä½çš„tophashç½®ä¸ºemptyOneï¼Œå¦‚æœå‘ç°å½“å‰æ§½ä½åé¢æ²¡æœ‰å…ƒç´ ï¼Œåˆ™å°†tophashè®¾ç½®ä¸ºemptyResetï¼Œå¹¶å¾ªç¯å‘å‰æ£€æŸ¥å‰ä¸€ä¸ªå…ƒç´ ï¼Œè‹¥å‰ä¸€ä¸ªå…ƒç´ ä¹Ÿä¸ºç©ºï¼Œæ§½ä½çŠ¶æ€ä¸ºemptyOneï¼Œåˆ™å°†å‰ä¸€ä¸ªå…ƒç´ çš„tophashä¹Ÿè®¾ç½®ä¸ºemptyResetã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å°†emptyResetçŠ¶æ€å°½å¯èƒ½åœ°å‘å‰é¢çš„æ§½æ¨è¿›ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†å¢åŠ æ•ˆç‡ï¼Œå› ä¸ºåœ¨æŸ¥æ‰¾çš„æ—¶å€™å‘ç°äº†emptyResetçŠ¶æ€å°±ä¸ç”¨ç»§ç»­å¾€åæ‰¾äº†ï¼Œå› ä¸ºåé¢æ²¡æœ‰å…ƒç´ äº†ã€‚</p>
<p><strong>mapçš„éå†</strong></p>
<p>goè¯­è¨€ä¸­mapçš„éå†å°¤å…¶è¦å¼•èµ·æ³¨æ„ï¼Œ<strong>å› ä¸ºæ¯æ¬¡éå†çš„æ•°æ®é¡ºåºéƒ½æ˜¯ä¸åŒçš„</strong>ã€‚è¿™æ˜¯å› ä¸ºgoåœ¨æ¯æ¬¡å¼€å§‹éå†å‰ï¼Œéƒ½ä¼šéšæœºä¸€ä¸ªæ¡¶ä¸‹æ ‡ï¼Œä¸€ä¸ªæ¡¶å†…éå†çš„èµ·ç‚¹æ§½ä¸‹æ ‡ï¼Œéå†çš„æ—¶å€™ä»è¿™ä¸ªæ¡¶å¼€å§‹ï¼Œåœ¨éå†æ¯ä¸ªæ¡¶çš„æ—¶å€™ï¼Œéƒ½ä»è¿™ä¸ªæ§½ä¸‹æ ‡å¼€å§‹</p>
<p>goè¯­è¨€ä¸ºä»€ä¹ˆè¦ç”¨è¿™ç§éšæœºå¼€å§‹çš„ä½ç½®å¼€å§‹éå†å‘¢ï¼Ÿ</p>
<p>ä¸€æ–¹é¢ï¼šå› ä¸ºgoçš„æ‰©å®¹ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œæ˜¯æ¸è¿›å¼çš„ï¼Œæ‰€ä»¥åœ¨éå†mapçš„æ—¶å€™ï¼Œå¯èƒ½å‘ç”Ÿæ‰©å®¹ï¼Œä¸€æ—¦å‘ç”Ÿæ‰©å®¹ï¼Œkey çš„ä½ç½®å°±å‘ç”Ÿäº†é‡å¤§çš„å˜åŒ–ï¼Œä¸‹æ¬¡éå†mapçš„æ—¶å€™ç»“æœå°±ä¸å¯èƒ½æŒ‰åŸæ¥çš„é¡ºåºäº†ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼šhash è¡¨ä¸­æ•°æ®æ¯æ¬¡æ’å…¥çš„ä½ç½®æ˜¯å˜åŒ–çš„ï¼ŒåŒä¸€ä¸ª map å˜é‡å†…ï¼Œæ•°æ®åˆ é™¤å†æ·»åŠ çš„ä½ç½®ä¹Ÿæœ‰å¯èƒ½å˜åŒ–ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªæ¡¶åŠæº¢å‡ºé“¾è¡¨ä¸­æ•°æ®çš„ä½ç½®ä¸åˆ†å…ˆå</p>
<p>æ‰€ä»¥ç†è®ºä¸Šï¼Œmapçš„éå†ç»“æœå°±æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥Goé˜²æ­¢ç”¨æˆ·é”™è¯¯çš„ä¾èµ–äºæ¯æ¬¡è¿­ä»£çš„é¡ºåºï¼Œç´¢æ€§æ¯æ¬¡éå†æ—¶ï¼Œæœæ˜¯éšæœºé€‰å–çš„ä¸€ä¸ªéå†å¼€å§‹ä½ç½®ã€‚</p>
<p><strong>è¿­ä»£å™¨</strong></p>
<p>è¿è¡Œæ—¶ï¼Œmapçš„éå†æ˜¯ä¾é ä¸€ä¸ªè¿­ä»£å™¨æ¥å®Œæˆçš„ï¼Œè¿­ä»£å™¨çš„ä»£ç å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hiter <span class="keyword">struct</span> &#123;</span><br><span class="line">   key         unsafe.Pointer <span class="comment">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).</span></span><br><span class="line">   elem        unsafe.Pointer <span class="comment">// Must be in second position (see cmd/compile/internal/walk/range.go).</span></span><br><span class="line">   t           *maptype</span><br><span class="line">   h           *hmap</span><br><span class="line">   buckets     unsafe.Pointer <span class="comment">// bucket ptr at hash_iter initialization time</span></span><br><span class="line">   bptr        *bmap          <span class="comment">// current bucket</span></span><br><span class="line">   overflow    *[]*bmap       <span class="comment">// keeps overflow buckets of hmap.buckets alive</span></span><br><span class="line">   oldoverflow *[]*bmap       <span class="comment">// keeps overflow buckets of hmap.oldbuckets alive</span></span><br><span class="line">   startBucket <span class="type">uintptr</span>        <span class="comment">// bucket iteration started at</span></span><br><span class="line">   offset      <span class="type">uint8</span>          <span class="comment">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1)</span></span><br><span class="line">   wrapped     <span class="type">bool</span>           <span class="comment">// already wrapped around from end of bucket array to beginning</span></span><br><span class="line">   B           <span class="type">uint8</span></span><br><span class="line">   i           <span class="type">uint8</span></span><br><span class="line">   bucket      <span class="type">uintptr</span></span><br><span class="line">   checkBucket <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­—æ®µé‡Šä¹‰ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>é‡Šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>é”®å€¼å¯¹çš„é”®ï¼Œé”®å¿…é¡»æ”¾ç½®åœ¨ç¬¬ä¸€ä¸ªå­—æ®µï¼Œkeyä¸ºç©ºæŒ‡é’ˆnilè¯´æ˜éå†ç»“æŸ</td>
</tr>
<tr>
<td>elem</td>
<td>é”®å€¼å¯¹çš„å€¼ï¼Œå€¼æ”¾ç½®åœ¨ç¬¬äºŒä¸ªå­—æ®µ</td>
</tr>
<tr>
<td>buckets</td>
<td>æ¡¶æ•°ç»„æŒ‡é’ˆï¼ŒæŒ‡å‘è¿­ä»£å™¨åˆå§‹åŒ–ä¹‹åè¦éå†çš„æ¡¶æ•°ç»„</td>
</tr>
<tr>
<td>h</td>
<td>mapçš„åœ°å€</td>
</tr>
<tr>
<td>t</td>
<td>mapçš„ç±»å‹ä¿¡æ¯</td>
</tr>
<tr>
<td>bptr</td>
<td>æŒ‡å‘å½“å‰éå†åˆ°çš„æ¡¶çš„æŒ‡é’ˆ</td>
</tr>
<tr>
<td>overflow</td>
<td>hmapä¸­æ­£å¸¸æ¡¶çš„æº¢å‡ºæ¡¶æŒ‡é’ˆ</td>
</tr>
<tr>
<td>oldoverflow</td>
<td>å‘ç”Ÿæ‰©å®¹æ—¶ï¼Œhmapä¸­æ—§æ¡¶çš„æº¢å‡ºæ¡¶æŒ‡é’ˆ</td>
</tr>
<tr>
<td>startBucket</td>
<td>å¼€å§‹éå†æ—¶ï¼Œåˆå§‹åŒ–çš„æ¡¶ä¸‹æ ‡</td>
</tr>
<tr>
<td>offset</td>
<td>å¼€å§‹éå†æ—¶ï¼Œåˆå§‹åŒ–çš„æ§½ä½ä¸‹æ ‡</td>
</tr>
<tr>
<td>wrapped</td>
<td>è¡¨ç¤ºæ˜¯å¦éå†å®Œäº†ï¼Œtrueè¡¨ç¤ºéå†å®Œäº†</td>
</tr>
<tr>
<td>B</td>
<td>åˆå§‹åŒ–è¿­ä»£å™¨æ—¶ï¼Œh.B</td>
</tr>
<tr>
<td>i</td>
<td>å½“å‰æ¡¶å·²ç»éå†çš„é”®å€¼å¯¹æ•°é‡ï¼Œi=0æ—¶ï¼Œå¼€å§‹éå†å½“å‰æ¡¶çš„ç¬¬ä¸€ä¸ªæ§½ä½ï¼Œi=8æ—¶ï¼Œå½“å‰æ¡¶å·²ç»éå†å®Œï¼Œå°† it.bptræŒ‡å‘ä¸‹ä¸€ä¸ªæ¡¶</td>
</tr>
<tr>
<td>bucket</td>
<td>å½“å‰éå†æ¡¶çš„åç§»é‡</td>
</tr>
<tr>
<td>checkBucket</td>
<td>æ¡¶çŠ¶æ¡¶çŠ¶æ€æ ‡è®°ä½ï¼Œå¦‚æœä¸æ˜¯noCheckï¼Œåˆ™è¡¨æ˜å½“å‰æ¡¶è¿˜æ²¡æœ‰è¿ç§»ï¼Œ</td>
</tr>
</tbody>
</table>
<p>æ•´ä¸ªéå†çš„è¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤æ­¥</p>
<ol>
<li>åˆå§‹åŒ–è¿­ä»£å™¨</li>
<li>å¼€å§‹ä¸€è½®éå†</li>
</ol>
<p>åˆå§‹åŒ–è¿­ä»£å™¨çš„å·¥ä½œä¸»è¦åœ¨å‡½æ•°<code>mapiterinit(t </code><em><code>maptype, h </code></em><code>hmap, it *hiter)</code>ä¸­å®Œæˆï¼Œæºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapiterinit initializes the hiter struct used for ranging over maps.</span></span><br><span class="line"><span class="comment">// The hiter struct pointed to by &#x27;it&#x27; is allocated on the stack</span></span><br><span class="line"><span class="comment">// by the compilers order pass or on the heap by reflect_mapiterinit.</span></span><br><span class="line"><span class="comment">// Both need to have zeroed hiter since the struct contains pointers.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapiterinit</span><span class="params">(t *maptype, h *hmap, it *hiter)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> raceenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line">      callerpc := getcallerpc()</span><br><span class="line">      racereadpc(unsafe.Pointer(h), callerpc, abi.FuncPCABIInternal(mapiterinit))</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   it.t = t</span><br><span class="line">   <span class="keyword">if</span> h == <span class="literal">nil</span> || h.count == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> unsafe.Sizeof(hiter&#123;&#125;)/goarch.PtrSize != <span class="number">12</span> &#123;</span><br><span class="line">      throw(<span class="string">&quot;hash_iter size incorrect&quot;</span>) <span class="comment">// see cmd/compile/internal/reflectdata/reflect.go</span></span><br><span class="line">   &#125;</span><br><span class="line">   it.h = h</span><br><span class="line"></span><br><span class="line">   <span class="comment">// grab snapshot of bucket state</span></span><br><span class="line">   it.B = h.B</span><br><span class="line">   it.buckets = h.buckets</span><br><span class="line">   <span class="keyword">if</span> t.bucket.ptrdata == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="comment">// Allocate the current slice and remember pointers to both current and old.</span></span><br><span class="line">      <span class="comment">// This preserves all relevant overflow buckets alive even if</span></span><br><span class="line">      <span class="comment">// the table grows and/or overflow buckets are added to the table</span></span><br><span class="line">      <span class="comment">// while we are iterating.</span></span><br><span class="line">      h.createOverflow()</span><br><span class="line">      it.overflow = h.extra.overflow</span><br><span class="line">      it.oldoverflow = h.extra.oldoverflow</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// decide where to start</span></span><br><span class="line">   r := <span class="type">uintptr</span>(fastrand())</span><br><span class="line">   <span class="keyword">if</span> h.B &gt; <span class="number">31</span>-bucketCntBits &#123;</span><br><span class="line">      r += <span class="type">uintptr</span>(fastrand()) &lt;&lt; <span class="number">31</span></span><br><span class="line">   &#125;</span><br><span class="line">   it.startBucket = r &amp; bucketMask(h.B)</span><br><span class="line">   it.offset = <span class="type">uint8</span>(r &gt;&gt; h.B &amp; (bucketCnt - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// iterator state</span></span><br><span class="line">   it.bucket = it.startBucket</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Remember we have an iterator.</span></span><br><span class="line">   <span class="comment">// Can run concurrently with another mapiterinit().</span></span><br><span class="line">   <span class="keyword">if</span> old := h.flags; old&amp;(iterator|oldIterator) != iterator|oldIterator &#123;</span><br><span class="line">      atomic.Or8(&amp;h.flags, iterator|oldIterator)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   mapiternext(it)  <span class="comment">// è¿›è¡Œå•æ¬¡éå†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦å·¥ä½œåˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol>
<li>åˆ¤æ–­mapæ˜¯å¦ä¸ºç©º</li>
<li>ä¿å­˜mapçš„Bå€¼å’Œå½“å‰æ¡¶æŒ‡é’ˆï¼Œå³ä¿å­˜éå†å¼€å§‹æ—¶mapçš„æ•°æ®å¿«ç…§ï¼Œé¿å…æ‰©å®¹æ—¶mapçš„Bå€¼å’Œæ¡¶æŒ‡é’ˆå‘ç”Ÿæ”¹å˜</li>
<li>éšæœºä¸€ä¸ªå¼€å§‹éå†çš„èµ·å§‹æ¡¶ä¸‹æ ‡</li>
<li>éšæœºä¸€ä¸ªæ§½ä½ä¸‹æ ‡ï¼Œåç»­æ¯ä¸ªæ¡¶å†…çš„éå†éƒ½ä»è¿™ä¸ªæ§½ä½å¼€å§‹</li>
<li>æŠŠmapç½®ä¸ºéå†çŠ¶æ€</li>
<li>å¼€å§‹æ‰§è¡Œä¸€æ¬¡éå†è¿‡ç¨‹</li>
</ol>
<p>å•æ¬¡éå†çš„å·¥ä½œä¸»è¦åœ¨<code>mapiternext(it *hiter)</code>å‡½æ•°ä¸­å®Œæˆï¼Œæºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapiternext</span><span class="params">(it *hiter)</span></span> &#123;</span><br><span class="line">   h := it.h</span><br><span class="line">   <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">      callerpc := getcallerpc()</span><br><span class="line">      racereadpc(unsafe.Pointer(h), callerpc, abi.FuncPCABIInternal(mapiternext))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123; <span class="comment">// mapçš„å¹¶å‘å†™åˆ¤æ–­</span></span><br><span class="line">      throw(<span class="string">&quot;concurrent map iteration and map write&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   t := it.t  <span class="comment">// è·å–ä¸Šæ¬¡è¿­ä»£è¿›åº¦</span></span><br><span class="line">   bucket := it.bucket</span><br><span class="line">   b := it.bptr</span><br><span class="line">   i := it.i</span><br><span class="line">   checkBucket := it.checkBucket</span><br><span class="line"></span><br><span class="line">next:  <span class="comment">// å¼€å§‹ä¸€æ¬¡è¿­ä»£</span></span><br><span class="line">   <span class="keyword">if</span> b == <span class="literal">nil</span> &#123; <span class="comment">// éå†æœªå¼€å§‹æˆ–è€…å½“å‰æ­£å¸¸æ¡¶(æ¡¶æ•°ç»„ä¸­çš„æ¡¶)çš„æº¢å‡ºæ¡¶ï¼ˆåŒæ•°ç»„çš„æº¢å‡ºè¡¨é“¾è¡¨ä¸­çš„æ¡¶ï¼‰ç»éå†å®Œäº†ï¼Œå¼€å§‹éå†ä¸‹ä¸€ä¸ªæ­£å¸¸æ¡¶</span></span><br><span class="line">      <span class="keyword">if</span> bucket == it.startBucket &amp;&amp; it.wrapped &#123; <span class="comment">// éå†ä½ç½®æ˜¯èµ·å§‹æ¡¶ï¼Œå¹¶ä¸”wrappedä¸ºtrueï¼Œè¯´æ˜éå†å®Œäº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">         <span class="comment">// end of iteration</span></span><br><span class="line">         it.key = <span class="literal">nil</span></span><br><span class="line">         it.elem = <span class="literal">nil</span></span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœmapæ­£åœ¨æ‰©å®¹ï¼Œåˆ¤æ–­å½“å‰éå†çš„æ¡¶æ•°æ®æ˜¯å¦å·²ç»è¿ç§»å®Œï¼Œè¿ç§»å®Œäº†åˆ™ä½¿ç”¨æ–°æ¡¶ï¼Œå¦åˆ™ä½¿ç”¨æ—§æ¡¶</span></span><br><span class="line">      <span class="keyword">if</span> h.growing() &amp;&amp; it.B == h.B &#123;</span><br><span class="line">         <span class="comment">// Iterator was started in the middle of a grow, and the grow isn&#x27;t done yet.</span></span><br><span class="line">         <span class="comment">// If the bucket we&#x27;re looking at hasn&#x27;t been filled in yet (i.e. the old</span></span><br><span class="line">         <span class="comment">// bucket hasn&#x27;t been evacuated) then we need to iterate through the old</span></span><br><span class="line">         <span class="comment">// bucket and only return the ones that will be migrated to this bucket.</span></span><br><span class="line">         oldbucket := bucket &amp; it.h.oldbucketmask()</span><br><span class="line">         b = (*bmap)(add(h.oldbuckets, oldbucket*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line">         <span class="keyword">if</span> !evacuated(b) &#123;</span><br><span class="line">            checkBucket = bucket</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            b = (*bmap)(add(it.buckets, bucket*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line">            checkBucket = noCheck</span><br><span class="line">         &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         b = (*bmap)(add(it.buckets, bucket*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line">         checkBucket = noCheck</span><br><span class="line">      &#125;</span><br><span class="line">      bucket++</span><br><span class="line">      <span class="keyword">if</span> bucket == bucketShift(it.B) &#123;  <span class="comment">// éå†åˆ°äº†æ•°ç»„æœ€åï¼Œä»å¤´å¼€å§‹ç»§ç»­éå†</span></span><br><span class="line">         bucket = <span class="number">0</span></span><br><span class="line">         it.wrapped = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      i = <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> ; i &lt; bucketCnt; i++ &#123;  <span class="comment">// éå†å½“å‰æ¡¶å’Œå½“å‰æ¡¶çš„æº¢å‡ºæ¡¶é‡Œçš„æ•°æ®</span></span><br><span class="line">      offi := (i + it.offset) &amp; (bucketCnt - <span class="number">1</span>)  <span class="comment">// é€šè¿‡åˆå§‹åŒ–çš„æ§½ä½ä¸‹è¡¨ç¡®å®šå°†è¦éå†çš„æ§½ä½çš„tophash</span></span><br><span class="line">      <span class="keyword">if</span> isEmpty(b.tophash[offi]) || b.tophash[offi] == evacuatedEmpty &#123;</span><br><span class="line">         <span class="comment">// <span class="doctag">TODO:</span> emptyRest is hard to use here, as we start iterating</span></span><br><span class="line">         <span class="comment">// in the middle of a bucket. It&#x27;s feasible, just tricky.</span></span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      k := add(unsafe.Pointer(b), dataOffset+<span class="type">uintptr</span>(offi)*<span class="type">uintptr</span>(t.keysize)) <span class="comment">// æ ¹æ®åç§»é‡iç¡®å®škeyå’Œvalueçš„åœ°å€</span></span><br><span class="line">      <span class="keyword">if</span> t.indirectkey() &#123;</span><br><span class="line">         k = *((*unsafe.Pointer)(k))</span><br><span class="line">      &#125;</span><br><span class="line">      e := add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+<span class="type">uintptr</span>(offi)*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">      <span class="keyword">if</span> checkBucket != noCheck &amp;&amp; !h.sameSizeGrow() &#123;</span><br><span class="line">         <span class="comment">// Special case: iterator was started during a grow to a larger size</span></span><br><span class="line">         <span class="comment">// and the grow is not done yet. We&#x27;re working on a bucket whose</span></span><br><span class="line">         <span class="comment">// oldbucket has not been evacuated yet. Or at least, it wasn&#x27;t</span></span><br><span class="line">         <span class="comment">// evacuated when we started the bucket. So we&#x27;re iterating</span></span><br><span class="line">         <span class="comment">// through the oldbucket, skipping any keys that will go</span></span><br><span class="line">         <span class="comment">// to the other new bucket (each oldbucket expands to two</span></span><br><span class="line">         <span class="comment">// buckets during a grow).</span></span><br><span class="line">         <span class="comment">// è¿™é‡Œå¤„äºå¢é‡æ‰©å®¹ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­</span></span><br><span class="line">         <span class="comment">// å¦‚æœæ•°æ®è¿˜æ²¡å¶ä»æ—§æ¡¶è¿ç§»åˆ°æ–°æ¡¶ï¼Œéœ€è¦è®¡ç®—è¿™ä¸ªkeyé‡æ–°hashè®¡ç®—åæ˜¯å¦ä¸oldbucketçš„ç´¢å¼•ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™è·³è¿‡</span></span><br><span class="line">         <span class="keyword">if</span> t.reflexivekey() || t.key.equal(k, k) &#123;</span><br><span class="line">            <span class="comment">// If the item in the oldbucket is not destined for</span></span><br><span class="line">            <span class="comment">// the current new bucket in the iteration, skip it.</span></span><br><span class="line">            hash := t.hasher(k, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line">            <span class="keyword">if</span> hash&amp;bucketMask(it.B) != checkBucket &#123;</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Hash isn&#x27;t repeatable if k != k (NaNs).  We need a</span></span><br><span class="line">            <span class="comment">// repeatable and randomish choice of which direction</span></span><br><span class="line">            <span class="comment">// to send NaNs during evacuation. We&#x27;ll use the low</span></span><br><span class="line">            <span class="comment">// bit of tophash to decide which way NaNs go.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> this case is why we need two evacuate tophash</span></span><br><span class="line">            <span class="comment">// values, evacuatedX and evacuatedY, that differ in</span></span><br><span class="line">            <span class="comment">// their low bit.</span></span><br><span class="line">            <span class="keyword">if</span> checkBucket&gt;&gt;(it.B<span class="number">-1</span>) != <span class="type">uintptr</span>(b.tophash[offi]&amp;<span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (b.tophash[offi] != evacuatedX &amp;&amp; b.tophash[offi] != evacuatedY) ||</span><br><span class="line">         !(t.reflexivekey() || t.key.equal(k, k)) &#123;  <span class="comment">// è¿™é‡Œçš„æ•°æ®æ²¡æœ‰å¤„åœ¨æ‰©å®¹ä¸­ï¼Œç›´æ¥ä½¿ç”¨</span></span><br><span class="line">         <span class="comment">// This is the golden data, we can return it.</span></span><br><span class="line">         <span class="comment">// OR</span></span><br><span class="line">         <span class="comment">// key!=key, so the entry can&#x27;t be deleted or updated, so we can just return it.</span></span><br><span class="line">         <span class="comment">// That&#x27;s lucky for us because when key!=key we can&#x27;t look it up successfully.</span></span><br><span class="line">         it.key = k</span><br><span class="line">         <span class="keyword">if</span> t.indirectelem() &#123;</span><br><span class="line">            e = *((*unsafe.Pointer)(e))</span><br><span class="line">         &#125;</span><br><span class="line">         it.elem = e</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// The hash table has grown since the iterator was started.</span></span><br><span class="line">         <span class="comment">// The golden data for this key is now somewhere else.</span></span><br><span class="line">         <span class="comment">// Check the current hash table for the data.</span></span><br><span class="line">         <span class="comment">// This code handles the case where the key</span></span><br><span class="line">         <span class="comment">// has been deleted, updated, or deleted and reinserted.</span></span><br><span class="line">         <span class="comment">// <span class="doctag">NOTE:</span> we need to regrab the key as it has potentially been</span></span><br><span class="line">         <span class="comment">// updated to an equal() but not identical key (e.g. +0.0 vs -0.0).</span></span><br><span class="line">         rk, re := mapaccessK(t, h, k)   <span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œè¡¨æ˜è¿™æ¡æ•°æ®å·²ç»è¢«è¿ç§»æˆ–è€…åˆ é™¤ï¼Œä½¿ç”¨mapaccessKå»æ‰¾å›è¿™éƒ¨åˆ†çš„æ•°æ®</span></span><br><span class="line">         <span class="keyword">if</span> rk == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment">// key has been deleted æ•°æ®æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜å·²ç»åˆ é™¤</span></span><br><span class="line">         &#125;</span><br><span class="line">         it.key = rk</span><br><span class="line">         it.elem = re</span><br><span class="line">      &#125;</span><br><span class="line">      it.bucket = bucket  <span class="comment">// è®°å½•æœ¬æ¬¡éå†è¿›åº¦</span></span><br><span class="line">      <span class="keyword">if</span> it.bptr != b &#123; <span class="comment">// avoid unnecessary write barrier; see issue 14921</span></span><br><span class="line">         it.bptr = b</span><br><span class="line">      &#125;</span><br><span class="line">      it.i = i + <span class="number">1</span></span><br><span class="line">      it.checkBucket = checkBucket</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   b = b.overflow(t)   <span class="comment">// éå†æº¢å‡ºæ¡¶é“¾è¡¨ï¼šç»§ç»­éå†ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶</span></span><br><span class="line">   i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">goto</span> next</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå†çš„æµç¨‹å¤§è‡´æ˜¯ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>mapçš„å¹¶å‘å†™æ£€æµ‹ï¼Œåˆ¤æ–­mapæ˜¯å¦å¤„äºå¹¶å‘å†™çŠ¶æ€ï¼Œæ˜¯åˆ™panic</li>
<li>åˆ¤æ–­æ˜¯å¦å·²ç»éå†å®Œäº†ï¼Œéå†å®Œäº†ç›´æ¥é€€å‡º</li>
<li>å¼€å§‹éå†</li>
<li>é¦–é€‰ç¡®å®šä¸€ä¸ªéšæœºå¼€å§‹éå†çš„èµ·å§‹æ¡¶ä¸‹æ ‡ä½œä¸ºstartBucketï¼Œç„¶åç¡®å®šä¸€ä¸ªéšæœºçš„æ§½ä½ä¸‹æ ‡ä½œä¸ºoffset</li>
<li>æ ¹æ®startBucketå’Œoffsetå¼€å§‹éå†å½“å‰æ¡¶å’Œå½“å‰æ¡¶çš„æº¢å‡ºæ¡¶ï¼Œå¦‚æœå½“å‰æ¡¶æ­£åœ¨æ‰©å®¹ï¼Œåˆ™è¿›è¡Œæ­¥éª¤6ï¼Œå¦åˆ™è¿›è¡Œæ­¥éª¤7</li>
<li>åœ¨éå†å¤„äºæ‰©å®¹çŠ¶æ€çš„bucketçš„æ—¶å€™ï¼Œå› ä¸ºå½“å‰bucketæ­£åœ¨æ‰©å®¹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šéå†è¿™ä¸ªæ¡¶ï¼Œè€Œæ˜¯ä¼šæ‰¾åˆ°è¿™ä¸ªæ¡¶çš„æ—§æ¡¶old_bucketï¼Œéå†æ—§æ¡¶ä¸­çš„ä¸€éƒ¨åˆ†keyï¼Œè¿™äº›keyé‡æ–°hashè®¡ç®—åèƒ½å¤Ÿæ•£åˆ—åˆ°bucketä¸­ï¼Œå¯¹é‚£äº›keyç»è¿‡é‡æ–°hashè®¡ç®—ä¸æ•£åˆ—åˆ°bucketä¸­çš„keyï¼Œåˆ™è·³è¿‡</li>
<li>æ ¹æ®éå†åˆå§‹åŒ–çš„æ—¶å€™é€‰å®šçš„éšæœºæ§½ä½å¼€å§‹éå†æ¡¶å†…çš„å„ä¸ªkey/value</li>
<li>ç»§ç»­éå†bucketæº¢å‡ºæŒ‡é’ˆæŒ‡å‘çš„æº¢å‡ºé“¾è¡¨ä¸­çš„æº¢å‡ºæ¡¶</li>
<li>å‡å¦‚éå†åˆ°äº†èµ·å§‹æ¡¶startBucketï¼Œåˆ™è¯´æ˜éå†å®Œäº†ï¼Œç»“æŸéå†</li>
</ol>
<h3 id="3-4-sync-map">3.4 sync.map</h3>
<p>sync.mapæ˜¯goè¯­è¨€åœ¨syncåŒ…ä¸‹æä¾›çš„ä¸€ä¸ªå¯ä»¥æä¾›å¹¶å‘è®¿é—®çš„mapã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">   mu Mutex             <span class="comment">//  ç”¨äºä¿æŠ¤dirtyå­—æ®µçš„é”</span></span><br><span class="line">   read atomic.Value    <span class="comment">// åªè¯»å­—æ®µï¼Œå…¶å®é™…çš„æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªreadOnlyç»“æ„</span></span><br><span class="line">   dirty <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry  <span class="comment">//éœ€è¦åŠ é”æ‰èƒ½è®¿é—®çš„mapï¼Œå…¶ä¸­åŒ…å«åœ¨readä¸­é™¤äº†è¢«expunged(åˆ é™¤)ä»¥å¤–çš„æ‰€æœ‰å…ƒç´ ä»¥åŠæ–°åŠ å…¥çš„å…ƒç´ </span></span><br><span class="line">   misses <span class="type">int</span> <span class="comment">// è®¡æ•°å™¨ï¼Œè®°å½•åœ¨ä»readä¸­è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œæ²¡æœ‰å‘½ä¸­çš„æ¬¡æ•°ï¼Œå½“misseså€¼ç­‰äºdirtyé•¿åº¦æ—¶ï¼Œdirtyæå‡ä¸ºread</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// readOnly is an immutable struct stored atomically in the Map.read field.</span></span><br><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span> &#123;</span><br><span class="line">   m       <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry   <span class="comment">// keyä¸ºä»»æ„å¯æ¯”è¾ƒç±»å‹ï¼Œvalueä½ä¸ºentryæŒ‡é’ˆçš„ä¸€ä¸ªmap</span></span><br><span class="line">   amended <span class="type">bool</span> <span class="comment">// amendedä½trueï¼Œè¡¨æ˜dirtyä¸­åŒ…å«readä¸­æ²¡æœ‰çš„æ•°æ®ï¼Œä¸ºfalseè¡¨æ˜dirtyä¸­çš„æ•°æ®åœ¨readä¸­éƒ½å­˜åœ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹entryè¿™ä¸ªç»“æ„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    p unsafe.Pointer  <span class="comment">// pæŒ‡å‘çœŸæ­£çš„valueæ‰€åœ¨çš„åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªpæœ‰ä¸‰ç§å–å€¼ï¼š</p>
<ul>
<li>pä¸ºnilï¼Œæ ‡è®°åˆ é™¤çŠ¶æ€ï¼Œä»£è¡¨è¿™ä¸ªkeyè¢«åˆ é™¤äº†ï¼Œæ­¤æ—¶dirtyè¦ä¹ˆä¸ºnilï¼Œè¦ä¹ˆä¹Ÿå­˜åœ¨è¿™ä¸ªkey</li>
<li>pä¸ºexpungedï¼šæ ‡è®°åˆ é™¤çŠ¶æ€ï¼Œæ­¤æ—¶dirtyéç©º(dirtyæœªç©ºçš„æƒ…å†µæ˜¯ï¼ŒåŸå…ˆçš„dirtyè¢«æå‡æœªreadï¼Œæ­¤æ—¶dirtyä¸ºç©ºï¼Œåªæœ‰å½“å†æ¬¡è¿½åŠ æ•°æ®çš„æ—¶å€™æ‰ä¼šé‡å»ºdirty)ï¼Œpå­˜åœ¨äºreadï¼Œä½†ä¸å­˜åœ¨äºdirty</li>
<li>pä¸ºæ­£å¸¸å€¼ï¼šentryè¡¨ç¤ºæ­£å¸¸çš„value</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/6e93f8002c384c32b5b3f8253a000bcd" alt=""></p>
<p><strong>expunged</strong>è¿™ä¸ªå­—æ®µçš„ä½œç”¨æ˜¯ç”¨æ¥æ ‡è¯†mapä¸­çš„æŸä¸ªkeyæ˜¯å¦è¢«åˆ é™¤ï¼Œæ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯æ ‡è®°åˆ é™¤ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„åˆ é™¤ï¼Œæ‰€ä»¥<strong>expunged</strong>æ˜¯mapä¸­ç”¨æ¥å¯¹æŸä¸ªkeyåšå‡åˆ é™¤åŠ¨ä½œçš„ï¼Œå½“ä»sync.Mapåˆ é™¤æŸä¸ªkeyçš„æ—¶å€™ï¼Œå°†è¿™ä¸ªkeyå¯¹åº”çš„valueæ ‡è®°ä¸ºnilæˆ–è€…**expungedï¼Œ**åé¢åœ¨å¯¹è¿™ä¸ªkeyè¿›è¡Œåˆ é™¤ã€‚å•è¯´expungedæ˜¯readç‹¬æœ‰çš„ï¼Œè€Œnilåˆ™æ˜¯readå’Œdirtyå…±æœ‰çš„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/e545cf5a7bb946cf9e1fc2fb74dac147" alt=""></p>
<p>sync.mapè·Ÿmapä¸€æ ·ï¼Œæä¾›äº†æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯¹ç…§mapä»æºä»£ç æ¥åˆ†æä¸€ä¸‹sync.mapå„ä¸ªåŠŸèƒ½çš„å…·ä½“å®ç°</p>
<ul>
<li><code>Store()</code>ï¼šæ›´æ–°/æ’å…¥ä¸€ä¸ªé”®å€¼å¯¹</li>
<li><code>Load()</code>ï¼šè¿”å›ä¸€ä¸ªkeyå¯¹åº”çš„value</li>
<li><code>Delete()</code>ï¼šåˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹</li>
<li><code>Range()</code>ï¼šå¯¹sync.Mapè¿›è¡Œéå†</li>
</ul>
<p><strong><code>Store</code></strong></p>
<p>sync.map.Store()æ–¹æ³•æ—¢å¯ä»¥ç”¨æ¥æ–°å¢é”®å€¼å¯¹ï¼Œä¹Ÿå¯ç”¨ç”¨æ¥æ›´æ–°é”®å€¼å¯¹ã€‚</p>
<ul>
<li>æ›´æ–°é”®å€¼å¯¹ï¼š
<ul>
<li>keyå­˜åœ¨äºreadä¸­ï¼Œé‚£ä¹ˆè¿™æ—¶keyå¯¹åº”çš„pæœ‰ä¸‰ç§æƒ…å†µ
<ul>
<li>p==expungedï¼Œå½“å‰keyå­˜åœ¨äºreadï¼Œä½†æ˜¯keyä¸å­˜åœ¨äºdirtyï¼Œdirtyä¹Ÿä¸ä¸ºç©ºï¼ŒreadåŒ…å«dirtyä¸­ä¸å­˜åœ¨çš„keyï¼Œdirtyä¹ŸåŒ…å«readä¸­ä¸å­˜åœ¨çš„keyï¼Œè¿™ç§æƒ…å†µä¸‹pçš„å€¼ä¸ºexpungedï¼Œå½¢å¼å¦‚ä¸‹å›¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½å•å•åªæ“ä½œreadï¼Œè¿˜è¦åŠ é”åŒæ­¥æ›´æ–°dirtyï¼Œå°†è¿™ä¸ªkeyåŠ å…¥åˆ°dirtyä¸­ï¼Œå°†e.pçš„ä¿å­˜æ–°ä¼ å…¥çš„value</li>
<li>p==nilï¼Œkeyå­˜åœ¨äºreadï¼Œæ­¤æ—¶dirtyçš„pä¹Ÿä¸ºç©ºï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç”¨åŸå­æ“ä½œç›´æ¥æ›´æ–°readé‡Œpçš„å€¼</li>
<li>p==&amp;valueï¼Œkeyå­˜åœ¨äºreadï¼Œä¹Ÿå­˜åœ¨äºdirtyï¼Œä¸”æŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ­£å¸¸å€¼ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯å¯ä»¥ç›´æ¥æ›´æ–°readé‡Œpçš„å€¼ï¼Œ</li>
</ul>
</li>
</ul>
</li>
<li>æ–°å¢é”®å€¼å¯¹ï¼ˆåªæ“ä½œdirtyï¼‰
<ul>
<li>dirtyä¸ºnilï¼Œç”±äºreadçš„missesæ¬¡æ•°è¾¾åˆ°äº†dirtyçš„é•¿åº¦ï¼Œdirtyåˆšåˆšæå‡ä¸ºreadï¼Œè¿˜æ²¡æœ‰è¢«æ’å…¥è¿‡æ–°çš„keyï¼Œæ­¤æ—¶ä¸ºnilã€‚æ­¤æ—¶è¦æ’å…¥æ–°çš„keyï¼Œåˆ™è¦æ ¹æ®readé‡å»ºdirtyï¼Œåœ¨é‡å»ºçš„æ—¶å€™ï¼ŒåŸæ¥è¢«æ ‡è®°åˆ é™¤ä¸ºnilçš„é”®å€¼å¯¹è¿‡æ»¤æ‰ï¼Œä¸å¤åˆ¶åˆ°dirtyï¼Œå‰©ä½™çš„é”®å€¼å¯¹éƒ½copyåˆ°dirtyã€‚å¹¶ä¸”è¿˜è¦æ”¹ä¸€ä¸‹readé‡Œè¢«æ ‡è®°åˆ é™¤çš„keyçš„çŠ¶æ€ï¼Œç”±åŸæ¥çš„nilæ”¹ä¸ºexpungedã€‚</li>
<li>dirtyä¸ä¸ºnilï¼Œç›´æ¥åœ¨dirtyä¸­æ’å…¥æ–°çš„é”®å€¼å¯¹</li>
</ul>
</li>
</ul>
<p>å…¶æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store ç”¨äºä¿å­˜æˆ–è€…äº‹æ›´æ–°ä¸€ä¸ªé”®å€¼å¯¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Store(key, value any) &#123;</span><br><span class="line">   read, _ := m.read.Load().(readOnly)  <span class="comment">// åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨äºreadä¸­</span></span><br><span class="line">   <span class="comment">/*****</span></span><br><span class="line"><span class="comment">   å‡è®¾keyå­˜åœ¨äºreadä¸­ï¼Œæ­¤æ—¶pæœ‰ä¸‰ç§æƒ…å†µï¼Œè¿™é‡Œå…ˆè®°ä½ï¼Œåé¢ä¼šå›¾è§£åˆ†æè¿™ä¸‰ç§æƒ…å†µ</span></span><br><span class="line"><span class="comment">   1. p == nil, keyè¢«æ ‡è®°åˆ é™¤äº†ï¼Œæ­¤æ—¶dirtyä¸ºç©º:dirty==nilï¼Œè¿™ä¸ªdirtyä¸­æ²¡æœ‰ä»»ä½•æ•°æ®å…ƒç´ </span></span><br><span class="line"><span class="comment">   2. p == expunged, keyè¢«æ ‡è®°åˆ é™¤ï¼Œä½†æ­¤æ—¶dirtyä¸ä¸ºç©ºï¼Œä¸”dirtyä¸­å­˜åœ¨ä¸€äº›keyï¼Œè¿™äº›keyä¸å†readä¸­</span></span><br><span class="line"><span class="comment">   3. p == &amp;valueï¼ŒpæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ­£å¸¸çš„valueï¼Œ</span></span><br><span class="line"><span class="comment">   ******/</span></span><br><span class="line">   <span class="comment">// keyå­˜åœ¨ä¸readä¸­ï¼Œä¸”æ­¤æ—¶readä¸­mè¿™ä¸ªmapçš„keyå¯¹åº”çš„entryçš„pæŒ‡é’ˆä¸æ»¡è¶³p == expungedï¼Œè¿™é‡Œèµ°tryStoreé€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨casåŸå­æ“ä½œä¿®æ”¹value</span></span><br><span class="line">   <span class="keyword">if</span> e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123;  </span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   m.mu.Lock()   <span class="comment">// åŠ é”</span></span><br><span class="line">   read, _ = m.read.Load().(readOnly)     <span class="comment">//åŒé‡æ£€æŸ¥ï¼Œæ€•æ‰§è¡Œåç»­é€»è¾‘çš„æ—¶å€™ï¼Œreadå·²è¢«å…¶ä»–goroutineä¿®æ”¹</span></span><br><span class="line">   <span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">      <span class="keyword">if</span> e.unexpungeLocked() &#123;</span><br><span class="line">         <span class="comment">// keyè¢«æ ‡è®°åˆ é™¤ï¼Œpå¤„äºexpungedçŠ¶æ€ï¼Œè¡¨æ˜è¿™ä¸ªkeyåœ¨readä¸­ï¼Œä½†ä¸å†dirtyä¸­</span></span><br><span class="line">         <span class="comment">// å¹¶ä¸”æ­¤æ—¶dirtyéç©ºï¼Œæ‰€ä»¥è¦ä¿è¯dirtyä¸­åŒ…å«mapæ‰€æœ‰çš„keyï¼Œå°±è¦æŠŠè¿™ä¸ªkeyåŠ å…¥åˆ°dirtyä¸­ï¼Œå¹¶ä¸”ä¿®æ”¹e.pæŒ‡å‘æ–°çš„value</span></span><br><span class="line">         m.dirty[key] = e    <span class="comment">// æŠŠè¿™ä¸ªkeyåŠ å…¥åˆ°dirtyä¸­</span></span><br><span class="line">      &#125;</span><br><span class="line">      e.storeLocked(&amp;value)    <span class="comment">// ä¿®æ”¹e.pæŒ‡å‘æ–°çš„value</span></span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> e, ok := m.dirty[key]; ok &#123;  <span class="comment">// keyä¸å†readä¸­ï¼Œä½†å­˜åœ¨äºdirtyä¸­</span></span><br><span class="line">      e.storeLocked(&amp;value)    <span class="comment">// ç›´æ¥ä¿®æ”¹e.pæŒ‡å‘æ–°çš„value</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;                    <span class="comment">// keyæ—¢ä¸åœ¨readä¸­ï¼Œä¹Ÿä¸å†dirtyä¸­ï¼Œæ˜¯ä¸€ä¸ªæ–°çš„keyï¼Œ</span></span><br><span class="line">      <span class="keyword">if</span> !read.amended &#123;  <span class="comment">// amendedä¸ºfalseï¼Œè¡¨æ˜dirtyä¸­çš„keuåœ¨readä¸­éƒ½å­˜åœ¨</span></span><br><span class="line">         <span class="comment">// å…ˆåˆ¤æ–­dirtyæ˜¯å¦ä¸ºç©ºï¼Œå› ä¸ºæœ‰ä¸€ç§æƒ…å†µï¼Œå½“readçš„æœªå‘½ä¸­æ¬¡æ•°å‡ missesè¾¾åˆ°dirtyé•¿åº¦çš„æ—¶å€™ï¼Œä¼šæ‹·è´æ•´ä¸ªdirtyåˆ°readï¼Œå³é‡å¡‘è¿‡ç¨‹</span></span><br><span class="line">         <span class="comment">// å‘ç”Ÿé‡å¡‘çš„æ—¶å€™ï¼Œdirtyä¸­çš„æ‰€æœ‰keyéƒ½ä¼šå­˜åœ¨äºreadä¸­ï¼Œä½†æ˜¯dirtyåœ¨é‡å¡‘å®Œä¹‹åï¼Œä¼šè¢«ç«‹é©¬ç½®ä¸ºnilï¼Œæ‰€ä»¥è¿™é‡Œè¦åšä¸€ä¸ªåˆ¤æ–­</span></span><br><span class="line">         m.dirtyLocked() <span class="comment">// æ ¹æ®readé‡å»ºdirtyå¯¹è±¡ï¼Œå°†readä¸­çš„key/valueå…¨éƒ¨å¤åˆ¶åˆ°dirtyä¸­ï¼Œä¿è¯dirtyä¸­åŒ…å«mapä¸­æ‰€æœ‰çš„key</span></span><br><span class="line">         m.read.Store(readOnly&#123;m: read.m, amended: <span class="literal">true</span>&#125;) <span class="comment">// æ›´æ”¹readçš„amendedä¸ºtrueï¼Œå› ä¸ºæ¥ä¸‹æ¥è¦åœ¨dirtyä¸­æ’å…¥ä¸€ä¸ªæ–°çš„keuï¼Œè¿™ä¸ªkeuå­˜åœ¨ä¸dirtyï¼Œä½†ä¸å­˜åœ¨äºread</span></span><br><span class="line">      &#125;</span><br><span class="line">      m.dirty[key] = newEntry(value)   <span class="comment">// åœ¨dirtyä¸­åŠ å…¥æ–°key/value</span></span><br><span class="line">   &#125;</span><br><span class="line">   m.mu.Unlock() <span class="comment">// è§£é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tryStore()</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†entryä¸­çš„pæŒ‡é’ˆï¼Œe.pæŒ‡å‘valueï¼Œå³å°è¯•å°†valueçš„å€¼å­˜åœ¨eçš„pæŒ‡é’ˆä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> tryStore(i *<span class="keyword">interface</span>&#123;&#125;) <span class="type">bool</span> &#123;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">      <span class="comment">// ä¸Šé¢è§£é‡Šè¿‡ï¼Œå‡ºç°è¿™ç§æƒ…å†µï¼Œè¯´æ˜dirtyä¸ä¸ºç©ºï¼Œä¸”dirtyä¸­å­˜åœ¨ä¸€äº›keyï¼Œè¿™äº›keyä¸å†readä¸­ï¼Œä¸èƒ½ä»…ä»…åªæ›´æ–°readï¼Œè¿˜è¦åŠ é”æ›´æ–°dirtyï¼Œæ‰€ä»¥ç›´æ¥è¿”å›false</span></span><br><span class="line">      <span class="keyword">if</span> p == expunged &#123;   </span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åŸå­æ“ä½œæ›´æ–°valueçš„å€¼</span></span><br><span class="line">      <span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, p, unsafe.Pointer(i)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>unexpungeLocked() </code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> unexpungeLocked() (wasExpunged <span class="type">bool</span>) &#123;</span><br><span class="line">   <span class="comment">// e.pä»expungedä¿®æ”¹ä¸ºnilï¼Œæ“ä½œæˆåŠŸè¿”å›true</span></span><br><span class="line">   <span class="comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¦æ”¹ä¸ºnilï¼Œé€šè¿‡ä¸Šé¢çš„è°ƒç”¨é€»è¾‘å¯ä»¥çŸ¥é“ï¼Œåç»­ä¼šå°†è¿™ä¸ªkeyåŠ å…¥åˆ°dirtyä¸­ï¼Œè¿™æ ·è¿™ä¸ªkeyå°±æ—¢å­˜åœ¨ä¸readï¼Œåˆå­˜åœ¨ä¸dirtyï¼Œæ‰€ä»¥çŠ¶æ€è¦æ”¹ä¸€ä¸‹</span></span><br><span class="line">   <span class="keyword">return</span> atomic.CompareAndSwapPointer(&amp;e.p, expunged, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>storeLocked()</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå­æ“ä½œï¼Œå°†iå­˜å‚¨åˆ°e.pä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> storeLocked(i *<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">   atomic.StorePointer(&amp;e.p, unsafe.Pointer(i))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dirtyLocked()</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> dirtyLocked() &#123;</span><br><span class="line">   <span class="keyword">if</span> m.dirty != <span class="literal">nil</span> &#123; <span class="comment">// å¦‚æœdirtyå¯¹è±¡å·²ç»å­˜åœ¨ï¼Œåˆ™ä¸éœ€è¦å†åˆ›å»ºäº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// æ ¹æ®readé‡æ–°åˆ›å»ºä¸€ä¸ªdirtyå¯¹è±¡</span></span><br><span class="line">   read, _ := m.read.Load().(readOnly) </span><br><span class="line">   m.dirty = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry, <span class="built_in">len</span>(read.m)) <span class="comment">// æ–°å»ºä¸€ä¸ªdirtyå¯¹è±¡</span></span><br><span class="line">   <span class="comment">// éå†readä¸­çš„key/valueï¼Œå¤åˆ¶åˆ°dirtyä¸­</span></span><br><span class="line">   <span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">      <span class="keyword">if</span> !e.tryExpungeLocked() &#123;</span><br><span class="line">         m.dirty[k] = e</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tryExpungeLocked()</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> tryExpungeLocked() (isExpunged <span class="type">bool</span>) &#123;</span><br><span class="line">   p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">   <span class="keyword">for</span> p == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœpè¢«æ ‡è®°åˆ é™¤ä¸ºnilï¼Œåœ¨è¿›è¡Œé‡å¡‘çš„æ—¶å€™ï¼Œå³copy dirtyåˆ°readçš„æ—¶å€™</span></span><br><span class="line">      <span class="comment">// å°†nilçš„å€¼æ”¹ä¸ºexpungedï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†è¡¨æ˜åœ¨å¯¹dirtyé‡æ–°æ„å»ºä¹‹å‰ï¼Œè¿™ä¸ªkeyåªå­˜åœ¨äºreadï¼Œä¸å­˜åœ¨äºdirty</span></span><br><span class="line">      <span class="comment">// åç»­è®¿é—®è¿™ä¸ªkeyçš„æ—¶å€™å°±ä¸ç”¨åŠ é”ï¼ŒåŠ å¿«äº†è®¿é—®é€Ÿåº¦</span></span><br><span class="line">      <span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, <span class="literal">nil</span>, expunged) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      p = atomic.LoadPointer(&amp;e.p)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> p == expunged</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/f34ad0276a05482f95ac61805cdd8917" alt=""></p>
<p><strong><code>Load</code></strong></p>
<p>Load()æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªkeyå¯¹åº”çš„valueï¼Œvalueä¸å­˜åœ¨å°±è¿”å›nilã€‚è¯»å–çš„æ—¶å€™ï¼Œå…ˆä»readä¸­è¯»å–ï¼Œè¯»åˆ°äº†keyï¼Œå°±ç›´æ¥è¿”å›ç»“æœï¼Œæ²¡æœ‰è¯»å–åˆ°ï¼Œå°±åŠ é”ä»dirtyä¸­è¯»å–ï¼Œæ‰€ä»¥è¯»å–ä¸åœ¨readä¸­çš„keyä¼šå› ä¸ºåŠ é”è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
<p>åœ¨è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‘ç”Ÿreadè¢«é‡æ„çš„è¿‡ç¨‹ï¼Œå³å°†dirtyæå‡ä¸ºreadçš„è¿‡ç¨‹ï¼Œæ¯”å¦‚å½“è¯»å–æŸä¸ªkeyçš„æ—¶å€™ï¼Œè¿™ä¸ªkeyå­˜åœ¨ä¸dirtyä¸­ï¼Œä½†ä¸å­˜åœ¨ä¸readä¸­ï¼Œæ‰€ä»¥ï¼Œmissesä¼šåŠ 1ï¼Œå½“missesåˆšå¥½è¾¾åˆ°dirtyçš„é•¿åº¦æ—¶ï¼Œå°±ä¼šé‡å¡‘readï¼Œæ‹·è´dirtyçš„æ•°æ®åˆ°readä¸­ï¼Œå°†dirtyæå‡ä¸ºreadï¼Œå¹¶å°†dirtyåªä¸ºnilã€‚</p>
<p>load()æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loadè¿”å›keuå¯¹åº”çš„valueå€¼ï¼Œokè¡¨ç¤ºkeyæ˜¯å¦å­˜åœ¨ä¸mapä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Load(key <span class="keyword">interface</span>&#123;&#125;) (value <span class="keyword">interface</span>&#123;&#125;, ok <span class="type">bool</span>) &#123;</span><br><span class="line">   read, _ := m.read.Load().(readOnly) </span><br><span class="line">   e, ok := read.m[key]    <span class="comment">// å…ˆä»readä¸­è¯»å–</span></span><br><span class="line">   <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;   <span class="comment">// readä¸­ä¸å­˜åœ¨ï¼Œå¹¶ä¸”dirtyä¸­å­˜åœ¨readä¸­ä¸å­˜åœ¨å¯key</span></span><br><span class="line">      m.mu.Lock()     <span class="comment">// åŠ é”åˆ°dirtyä¸­è¯»å–</span></span><br><span class="line">      <span class="comment">// åŒé‡æ£€æŸ¥ï¼ŒåŸç†è·Ÿstoreçš„æ—¶å€™ç›¸åŒ</span></span><br><span class="line">      <span class="comment">// å¯èƒ½å­˜åœ¨ä¸€ä¸ª goroutine åœ¨æ‰§è¡Œå®Œ if !ok &amp;&amp; read.amended ä½†è¿˜æ²¡æœ‰åŠ é”å®Œæˆæ—¶ï¼Œå¦ä¸€ä¸ª goroutine å°† dirty æå‡æˆäº† read çš„æƒ…å†µï¼Œ</span></span><br><span class="line">      <span class="comment">// ä¿®æ”¹äº†readè¿™ç§çš„keyé›†åˆï¼Œå¯¼è‡´keuå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥åœ¨åŠ é”ä¹‹åè¿˜éœ€è¦å†ä» read ä¸­æ£€æŸ¥ä¸€é</span></span><br><span class="line">      read, _ = m.read.Load().(readOnly)</span><br><span class="line">      e, ok = read.m[key]</span><br><span class="line">      <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123; <span class="comment">// keyä¸å­˜åœ¨ä¸readä¸­ï¼Œä¸”dirtyä¸­å­˜åœ¨readä¸­ä¸å­˜åœ¨å¯key</span></span><br><span class="line">         e, ok = m.dirty[key]  <span class="comment">// ç›´æ¥ä»dirtyè¯»å–</span></span><br><span class="line">         <span class="comment">// ä¸ç®¡keyåœ¨ä¸åœ¨dirtyä¸­ï¼Œå‘½ä¸­è®°å½•æ•°misseséƒ½ä¼šåŠ 1</span></span><br><span class="line">         <span class="comment">// å½“misseså¤§äºç­‰äºdirtyçš„é•¿åº¦æ—¶ï¼Œå‘ç”Ÿé‡å¡‘ï¼Œå°†dirtyæå‡ä¸ºread</span></span><br><span class="line">         <span class="comment">// å°†missesæ¸…0</span></span><br><span class="line">         m.missLocked()        </span><br><span class="line">      &#125;</span><br><span class="line">      m.mu.Unlock()            <span class="comment">// è§£é”</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> !ok &#123;                    <span class="comment">// æ²¡æœ‰è¯»å–åˆ°ï¼Œkeyæ—¢ä¸å­˜åœ¨äºreadï¼Œä¹Ÿä¸å­˜åœ¨ä¸dirty                </span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// è¯»å–åˆ°äº†ï¼Œè¿”å›value</span></span><br><span class="line">   <span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œå› ä¸ºokä¼šåœ¨dirtyä¸­å†åšä¸€æ¬¡èµ‹å€¼ï¼Œæ—¢å¯èƒ½æ˜¯ç›´æ¥ä»readè¯»å–åˆ°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»dirtyè¯»å–åˆ°</span></span><br><span class="line">   <span class="keyword">return</span> e.load()              </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>missLocked()</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> missLocked() &#123;</span><br><span class="line">   m.misses++ <span class="comment">// readæœªå‘½ä¸­æ¬¡æ•°åŠ 1</span></span><br><span class="line">   <span class="keyword">if</span> m.misses &lt; <span class="built_in">len</span>(m.dirty) &#123;   <span class="comment">// missesæœªè¾¾åˆ°dirtyé•¿åº¦ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// missesè¾¾åˆ°dirtyé•¿åº¦</span></span><br><span class="line">   m.read.Store(readOnly&#123;m: m.dirty&#125;)  <span class="comment">// å°†dirtyçš„å†…å®¹å­˜å‚¨åˆ°readä¸­ï¼Œæå‡dirtyæœªread</span></span><br><span class="line">   m.dirty = <span class="literal">nil</span>     <span class="comment">// å°†dirtyç½®ä¸ºnilï¼Œå› æœªdirtyä¸ºä¸€ä¸ªmapç±»å‹ï¼Œç½®ä¸ºnilåï¼Œä¼šè¢«åƒåœ¾å›æ”¶</span></span><br><span class="line">   m.misses = <span class="number">0</span>      <span class="comment">// missesæ¸…0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:%5CUsers%5Chyz%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230412195258520.png" alt="image-20230412195258520"></p>
<p><strong><code>Delete</code></strong></p>
<p><code>Delete</code>æ–¹æ³•æ˜¯ä»sync.Mapä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œdeleteæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¼˜å…ˆæ£€æŸ¥readï¼Œè‹¥keyåœ¨readä¸­å­˜åœ¨ï¼Œåˆ™åªä¼šæ“ä½œreadã€‚è‹¥åœ¨readä¸­ä¸å­˜åœ¨ï¼Œå›å»dirtyä¸­åˆ é™¤è¿™ä¸ªé”®å€¼å¯¹<code>delete(m.dirty, key)</code>ã€‚æ‰€ä»¥åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š</p>
<ol>
<li>keyå­˜åœ¨äºreadä¸­
<ul>
<li>keyåªå­˜åœ¨readï¼Œä¸å­˜åœ¨äºdirtyã€‚ç›´æ¥å°†keyå¯¹åº”çš„eçš„e.pè®¾ç½®ä¸ºnilï¼Œè¿™ç§æƒ…å†µdirtyä¸­æ ¹æœ¬å°±æ²¡æœ‰è¿™ä¸ªkeyï¼Œæ‰€ä»¥ä¸ç”¨ç®¡</li>
<li>keyæ—¢å­˜åœ¨äºreadï¼Œä¹Ÿå­˜åœ¨äºdirtã€‚ä¹Ÿæ˜¯ç›´æ¥å°†keyå¯¹åº”çš„eçš„e.pè®¾ç½®ä¸ºnilï¼Œè¿™ç§æƒ…å†µä¸‹readä¸­mçš„eå’Œdirtyä¸­çš„eæŒ‡å‘åŒä¸€ä¸ªï¼Œå°†readä¸­eçš„e.pè®¾ç½®ä¸ºnilï¼Œå…¶å®dirtyä¸­çš„pä¹ŸæŒ‡å‘äº†nil</li>
</ul>
</li>
</ol>
<p>â€‹	ä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼åˆ é™¤é”®å€¼å¯¹çš„æ—¶å€™å…¶å®éƒ½æ²¡æœ‰åƒä»dirtyä¸­åˆ é™¤é‚£æ ·è°ƒç”¨deleteå‡½æ•°ä»mapä¸­åˆ é™¤è¿™ä¸ªkey/valueï¼Œæ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰çœŸçš„åˆ é™¤ï¼Œåªæ˜¯æ ‡è®°åˆ é™¤äº†ï¼ŒçœŸæ­£åˆ é™¤è¦ç­‰åˆ°readä¸­çš„misseså¤§äºç­‰äºdirtyçš„æ—¶å€™ï¼Œdirtyæå‡ä¸ºreadçš„æ—¶å€™ï¼Œè¿™äº›keyæ‰å›è¢«åƒåœ¾å›æ”¶æ‰ã€‚</p>
<ol start="2">
<li>keyä¸å­˜åœ¨äºread</li>
</ol>
<p>è¿™ç§æƒ…å†µå¾ˆç®€å•ï¼Œç›´æ¥å»dirtyä¸­è¿™ä¸ªmapåˆ é™¤è¿™ä¸ªé”®å€¼å¯¹å°±è¡Œäº†ï¼Œè¿™é‡Œæ˜¯ç›´æ¥åˆ é™¤</p>
<p>æ‰€ä»¥ï¼šä»readä¸­åˆ é™¤æ˜¯å»¶è¿Ÿåˆ é™¤ï¼Œä»dirtyä¸­åˆ é™¤æ˜¯ç›´æ¥åˆ é™¤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/12/9216d805d72d48efba1a98aa16537499" alt=""></p>
<p><strong><code>Range</code></strong></p>
<p>Rangeæ–¹æ³•æ˜¯å¯¹sync.Mapè¿›è¡Œéå†ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ª<code>func(key, value interface&#123;&#125;) bool</code>ç±»å‹çš„å‡½æ•°fï¼Œfçš„ä½œç”¨æ˜¯å¯¹sync.Mapä¸­éå†åˆ°çš„æ¯ä¸€ä¸ªkey/valueé”®å€¼å¯¹è¿›è¡Œå¤„ç†ï¼Œå½“fè¿”å›falseçš„æ—¶å€™ï¼Œéå†åœæ­¢ã€‚</p>
<p>åœ¨sync.Mapä¸­å½“dirtyä¸ä¸ºnilæ—¶ï¼Œdirtyä¼šåŒ…å«mapä¸­æ‰€æœ‰éåˆ é™¤çš„keyã€‚åœ¨éå†çš„æ—¶å€™ä¼šå…ˆçœ‹readçš„amendedå­—æ®µï¼Œå½“amendedä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºdirtyä¸­æœ‰readä¸­æ²¡æœ‰çš„å­—æ®µï¼Œå°†dirtyæå‡ä¸ºreadï¼Œå†éå†readå³å¯ï¼Œè¿™æ ·å°±é¿å…äº†è®¿é—®dirtyä¼šåŠ é”å¯¼è‡´æ€§èƒ½ä½ä¸‹ï¼Œå¦‚æœamendedä¸ºfalseæ—¶ï¼Œè¡¨ç¤ºreadå’Œdirtyä¸­çš„keyä¸€è‡´ï¼Œè¿™æ—¶ç›´æ¥éå†readå³å¯ã€‚</p>
<p>å…¶æºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Range(f <span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">   read, _ := m.read.Load().(readOnly)</span><br><span class="line">   <span class="keyword">if</span> read.amended &#123;</span><br><span class="line">      m.mu.Lock()</span><br><span class="line">      <span class="comment">// è·Ÿå‰é¢æ–¹æ³•çš„åŸç†ä¸€æ ·ï¼ŒåŒæ ·æ˜¯å¯¹readè¿›è¡ŒåŒæ£€æŸ¥</span></span><br><span class="line">      read, _ = m.read.Load().(readOnly)</span><br><span class="line">      <span class="keyword">if</span> read.amended &#123;  <span class="comment">// dirtyä¸­åŒ…å«readä¸­ä¸å­˜åœ¨çš„key</span></span><br><span class="line">         <span class="comment">// å°†dirtyæå‡ä¸ºreadï¼Œå› ä¸ºdirtyä¸­åŒ…å«mapä¸­çš„æ‰€æœ‰keyï¼Œæ‰€ä»¥ç›´æ¥ä¾¿åˆ©dirtyå³å¯ï¼Œ</span></span><br><span class="line">         <span class="comment">// å°†readyæå‡äº†readä¹‹åï¼Œå°±ä¸ç”¨åŠ é”è®¿é—®äº†ï¼Œæå‡äº†æ•ˆç‡</span></span><br><span class="line">         read = readOnly&#123;m: m.dirty&#125; </span><br><span class="line">         m.read.Store(read)</span><br><span class="line">         m.dirty = <span class="literal">nil</span>  <span class="comment">// dirtyç½®ä¸ºnil</span></span><br><span class="line">         m.misses = <span class="number">0</span>   <span class="comment">// readçš„æœªå‘½ä¸­æ•°ç½®ä¸º0</span></span><br><span class="line">      &#125;</span><br><span class="line">      m.mu.Unlock()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">      v, ok := e.load()</span><br><span class="line">      <span class="keyword">if</span> !ok &#123;</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> !f(k, v) &#123;</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-channel">3.5 channel</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">   qcount   uint           <span class="comment">// å¾ªç¯é˜Ÿåˆ—ä¸­çš„æ•°æ®æ€»æ•°</span></span><br><span class="line">   dataqsiz uint           <span class="comment">// å¾ªç¯é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">   buf      unsafe.Pointer <span class="comment">// æŒ‡å‘å¾ªç¯é˜Ÿåˆ—çš„æŒ‡é’ˆ</span></span><br><span class="line">   elemsize uint16         <span class="comment">// å¾ªç¯é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ çš„å¤§å°</span></span><br><span class="line">   closed   uint32         <span class="comment">// æ ‡è®°ä½ï¼Œæ ‡è®°channelæ˜¯å¦å…³é—­</span></span><br><span class="line">   elemtype *_type         <span class="comment">// å¾ªç¯é˜Ÿåˆ—ä¸­çš„å…ƒç´ ç±»å‹</span></span><br><span class="line">   sendx    uint           <span class="comment">// å·²å‘é€å…ƒç´ åœ¨å¾ªç¯é˜Ÿåˆ—ä¸­çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">   recvx    uint           <span class="comment">// å·²æ¥æ”¶å…ƒç´ åœ¨å¾ªç¯é˜Ÿåˆ—ä¸­çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">   recvq    waitq          <span class="comment">// ç­‰å¾…ä»channelæ¥æ”¶æ¶ˆæ¯çš„sudogé˜Ÿåˆ—</span></span><br><span class="line">   sendq    waitq          <span class="comment">// ç­‰å¾…å‘channelå†™å…¥æ¶ˆæ¯çš„sudogé˜Ÿåˆ—</span></span><br><span class="line">   lock mutex              <span class="comment">// äº’æ–¥é”ï¼Œå¯¹channelçš„æ•°æ®è¯»å†™æ“ä½œåŠ é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hchan ä¸­çš„sendq å’Œ recvq å­—æ®µå­˜å‚¨äº†å½“å‰ channel ç”±äºç¼“å†²åŒºç©ºé—´(buf)ä¸è¶³è€Œé˜»å¡çš„è¦è¯»å–æˆ–è€…å†™å…¥å½“å‰channelçš„goroutine åˆ—è¡¨ï¼Œè¿™äº›ç­‰å¾…é˜Ÿåˆ—ä½¿ç”¨åŒå‘é“¾è¡¨ waitq è¡¨ç¤ºï¼Œwaitqæ˜¯å¯¹ä¸€ä¸ªsudogé“¾è¡¨è¿›è¡Œå°è£…ä¹‹åçš„ä¸€ä¸ªç»“æ„ï¼Œå…¶å­—æ®µä¸ºè¿™ä¸ªsudogé˜Ÿåˆ—çš„é¦–ä½æŒ‡é’ˆï¼Œé“¾è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯ sudog ç»“æ„ï¼Œçœ‹ä¸€ä¸‹waitqè¿™ä¸ªæ•°æ®ç±»å‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> waitq <span class="keyword">struct</span> &#123;</span><br><span class="line">    first *sudog              <span class="comment">// sudogé˜Ÿåˆ—çš„é˜Ÿå¤´æŒ‡é’ˆ</span></span><br><span class="line">    last  *sudog              <span class="comment">// sudogé˜Ÿåˆ—çš„é˜Ÿå°¾æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sudo</p>
<p>æˆ‘ä»¬çŸ¥é“channelæ˜¯ç”¨äºä¸¤ä¸ªä¸åŒçš„goroutineä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„ï¼Œä½†æ˜¯è¿™é‡Œçš„recvqå’Œsendqå´æ˜¯sudogåˆ—è¡¨ï¼Œsudogå’Œgoroutineä¹‹é—´æ˜¯ä¸æ˜¯åˆæŸç§å…³ç³»å‘¢ï¼Ÿgoroutineå…¶å®æ˜¯ç»‘å®šæ­£åœ¨sudogè¿™ä¸ªç»“æ„ä¸Šï¼Œæ‰€ä»¥recvqå¯ä»¥ç®€å•ç†è§£ä¸ºè¯»æ“ä½œé˜»å¡åœ¨ channel çš„ goroutine åˆ—è¡¨ï¼Œsendq æ˜¯å†™æ“ä½œé˜»å¡åœ¨ channel çš„ goroutine åˆ—è¡¨</p>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹sudogç»“æ„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sudog <span class="keyword">struct</span> &#123;</span><br><span class="line">   g *g                  <span class="comment">// ç»‘å®šçš„goroutine</span></span><br><span class="line">   next *sudog           <span class="comment">// æŒ‡å‘sudogé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">   prev *sudog           <span class="comment">// æŒ‡å‘sudogé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">   elem unsafe.Pointer   <span class="comment">// æ•°æ®å¯¹è±¡</span></span><br><span class="line">   acquiretime <span class="type">int64</span>     </span><br><span class="line">   releasetime <span class="type">int64</span></span><br><span class="line">   ticket      <span class="type">uint32</span></span><br><span class="line">   isSelect <span class="type">bool</span></span><br><span class="line">   success <span class="type">bool</span></span><br><span class="line">   parent   *sudog <span class="comment">// semaRoot binary tree</span></span><br><span class="line">   waitlink *sudog <span class="comment">// g.waiting list or semaRoot</span></span><br><span class="line">   waittail *sudog <span class="comment">// semaRoot</span></span><br><span class="line">   c        *hchan <span class="comment">// channel</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**ç›´æ¥å‘é€ï¼š**å½“å‰ channel æœ‰æ­£åœ¨é˜»å¡ç­‰å¾…æ¥æ”¶æ•°æ®çš„goroutineï¼Œé‚£ä¹ˆç›´æ¥å‘é€æ•°æ®ï¼Œç›´æ¥ä»ä¸€ä¸ªgoroutineæ“ä½œå¦ä¸€ä¸ªgoroutineçš„æ ˆï¼Œå°†å¾…å‘é€æ•°æ®ç›´æ¥copyåˆ°æ¥æ”¶å¤„</p>
<p>**ç¼“å†²å‘é€ï¼š<strong>ä¼šåˆ¤å®šç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´ï¼Œå¦‚æœæœ‰å‰©ä½™ç©ºé—´ï¼Œåˆ™å°†æ•°æ®æ‹·è´åˆ°channelä¸­</strong>ï¼Œ**sendx ç´¢å¼•è‡ªè¡Œè‡ªå¢ 1(è‹¥sendx ç­‰äº dataqsiz ï¼Œåˆ™å°†sendx ç½®0ï¼ŒåŸå› æ˜¯bufæ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„)ï¼Œè‡ªå¢å®Œæˆä¹‹åï¼Œé˜Ÿåˆ—æ€»æ•°è‡ªå¢ 1</p>
<p>**é˜»å¡å‘é€ï¼š**å½“å‰ channel æ²¡æœ‰æ­£åœ¨é˜»å¡ç­‰å¾…æ¥æ”¶æ•°æ®çš„goroutineå¹¶ä¸”æ˜¯channelçš„ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œå‘é€goroutineå°±å°±ä¼šé˜»å¡ï¼Œé¦–å…ˆè·å–<code>sudog</code> ï¼Œå°†å‘æ¾å¹³çš„goroutineç»‘å®šåˆ°sudogä¸Šï¼ŒåŠ å…¥åˆ°å½“å‰channelçš„å‘é€é˜»å¡é˜Ÿåˆ—ï¼Œè°ƒç”¨ <code>gopark</code> æ–¹æ³•æŒ‚èµ·å½“å‰ goroutineï¼Œç­‰å¾…è¢«å”¤é†’</p>
<p>é’ˆå¯¹ä¸åŒçš„ channel çŠ¶æ€ï¼Œè¿›è¡Œè¯»ã€å†™ã€å…³é—­æ“ä½œæ—¶çš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¹äº <code>nil</code> channelï¼Œä»»ä½•è¯»ã€å†™ã€å…³é—­æ“ä½œéƒ½ä¼šå¯¼è‡´ç¨‹åº panicã€‚</li>
<li>å¯¹äºå·²ç»å…³é—­çš„ channelï¼Œç»§ç»­è¿›è¡Œå†™æ“ä½œä¼šå¯¼è‡´ç¨‹åº panicï¼Œè€Œè¯»æ“ä½œä¼šè¿”å› channel ä¸­è¿˜æœªè¯»å–çš„å…ƒç´ ç›´åˆ° channel ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«è¯»å–å®Œæ¯•ï¼Œæ­¤æ—¶ç»§ç»­è¯»å–æ“ä½œä¼šè¿”å› channel å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚</li>
<li>å¯¹äºæœ‰æ•°æ®çš„ channelï¼Œè¿›è¡Œè¯»æ“ä½œä¼šè¯»å– channel ä¸­çš„æ•°æ®ï¼Œå¦‚æœ channel ä¸­æ²¡æœ‰æ•°æ®åˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ° channel ä¸­æœ‰æ•°æ®å¯è¯»ä¸ºæ­¢ã€‚è¿›è¡Œå†™æ“ä½œä¼šå°†æ•°æ®å†™å…¥ channel ä¸­ï¼Œå¦‚æœ channel å·²æ»¡åˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ° channel æœ‰ç©ºé—´å¯å†™ä¸ºæ­¢ã€‚å¯¹äºå·²ç»å…³é—­çš„ channelï¼Œè¯»æ“ä½œçš„è¡Œä¸ºåŒä¸Šè¿°ç¬¬ 2 ç‚¹ã€‚</li>
</ol>
<h3 id="3-6-context">3.6 context</h3>
<p>contextåœ¨é¡¹ç›®ä¸­ä¸»è¦æ˜¯ç”¨äºä¸Šä¸‹ä¸ä¸‹å±‚goroutineçš„å–æ¶ˆæ§åˆ¶ä»¥åŠæ•°æ®å…±äº«ï¼Œä¹Ÿæ˜¯goè¯­è¨€ä¸­goroutineä¹‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼Œå…¶åº•å±‚æ˜¯å€ŸåŠ©channlä¸snyc.Mutexå®ç°çš„ã€‚</p>
<p>contextåœ¨åº•å±‚å®ç°ä¸Šå…¶å®ç”¨åˆ°äº†2ä¸ªæ¥å£ï¼Œå¯¹è¿™ä¸ªæ¥å£çš„4ç§å®ç°ï¼Œä»¥åŠæä¾›äº†6ä¸ªæ–¹æ³•</p>
<p><strong>æ¥å£ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ¥å£å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Context</td>
<td>contextçš„æ¥å£å®šä¹‰ï¼Œè§„å®šcontextçš„å®ç°å¿…é¡»åŒ…å«çš„å››ä¸ªåŸºæœ¬æ–¹æ³•</td>
</tr>
<tr>
<td>canceler</td>
<td>contextçš„å–æ¶ˆæ¥å£ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•</td>
</tr>
</tbody>
</table>
<p><strong>å®ç°ï¼š</strong></p>
<p>contextæ¥å£çš„å››ç§å®ç°</p>
<table>
<thead>
<tr>
<th>ç»“æ„å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>emptyCtx</td>
<td>ä¸€ä¸ªç©ºçš„contextï¼Œç”¨ä½œæ ¹context</td>
</tr>
<tr>
<td>cancelCtx</td>
<td>å¯ä»¥é€šè¿‡å–æ¶ˆå‡½æ•°æ¥å–æ¶ˆcontext</td>
</tr>
<tr>
<td>timerCtx</td>
<td>å¯ä»¥é€šè¿‡å®šæ—¶å™¨å’Œdeadlineæ¥å®šæ—¶å–æ¶ˆcontextvalueCtx</td>
</tr>
<tr>
<td>valueCtx</td>
<td>ç±»ä¼¼äºmapï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨key/valuezé”®å€¼å¯¹</td>
</tr>
</tbody>
</table>
<p><strong>æ–¹æ³•ï¼š</strong></p>
<table>
<thead>
<tr>
<th>å‡½æ•°å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Background</td>
<td>è¿”å›ä¸€ä¸ªæ ¹contextå³emptyCtx</td>
</tr>
<tr>
<td>TODO</td>
<td>ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ªæ ¹contextå³emptyCtx</td>
</tr>
<tr>
<td>WithCancel</td>
<td>æ´¾ç”Ÿå‡ºä¸€ä¸ªcancelCtx</td>
</tr>
<tr>
<td>WithDeadline</td>
<td>æ´¾ç”Ÿå‡ºä¸€ä¸ªcancelCtx</td>
</tr>
<tr>
<td>WithTimeout</td>
<td>æ´¾ç”Ÿå‡ºä¸€ä¸ªcancelCtx</td>
</tr>
<tr>
<td>WithValue</td>
<td>æ´¾ç”Ÿå‡ºä¸€ä¸ªcancelCtx</td>
</tr>
</tbody>
</table>
<p><strong>contextæ¥å£</strong></p>
<p>é¦–å…ˆè¿˜æ˜¯å›é¡¾ä¸€ä¸‹contextæ¥å£ï¼Œcontextçš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">   Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">   Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">   Err() <span class="type">error</span></span><br><span class="line">   Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥å£æä¾›äº†å››ä¸ªæ–¹æ³•</p>
<ul>
<li><code>Deadline</code>ï¼š è®¾ç½® context.Context è¢«å–æ¶ˆçš„æ—¶é—´ï¼Œå³æˆªæ­¢æ—¶é—´ï¼›</li>
<li><code>Done</code>ï¼š è¿”å›ä¸€ä¸ª Channelï¼Œå½“Contextè¢«å–æ¶ˆæˆ–è€…åˆ°è¾¾æˆªæ­¢æ—¶é—´ï¼Œè¿™ä¸ª Channel å°±ä¼šè¢«å…³é—­ï¼Œè¡¨ç¤ºcontextç»“æŸï¼Œå¤šæ¬¡è°ƒç”¨ Done æ–¹æ³•è¿”å›çš„channelæ˜¯åŒä¸€ä¸ª</li>
<li><code>Err</code>ï¼š è¿”å› context.Context ç»“æŸçš„åŸå› </li>
<li>4.<code>Value</code> ï¼šä» context.Context ä¸­è·å–é”®å¯¹åº”çš„å€¼ï¼Œç±»ä¼¼äºmapçš„getæ–¹æ³•ï¼Œå¯¹äºåŒä¸€ä¸ªcontextï¼Œå¤šæ¬¡è°ƒç”¨ Value å¹¶ä¼ å…¥ç›¸åŒçš„ Key ä¼šè¿”å›ç›¸åŒçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„<code>key</code>,åˆ™è¿”å›<code>nil</code>ï¼Œé”®å€¼å¯¹æ˜¯é€šè¿‡WithValueæ–¹æ³•å†™å…¥</li>
</ul>
<p><strong>canceleræ¥å£</strong></p>
<p><strong>canceleræ¥å£çš„æºç å®šä¹‰å¦‚ä¸‹</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> canceler <span class="keyword">interface</span> &#123;</span><br><span class="line">   cancel(removeFromParent <span class="type">bool</span>, err <span class="type">error</span>)  <span class="comment">// åˆ›å»ºcancelæ¥å£å®ä¾‹çš„goroutine è°ƒç”¨cancelæ–¹æ³•é€šçŸ¥è¢«åˆ›å»ºçš„goroutineé€€å‡º</span></span><br><span class="line">   Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;  <span class="comment">// è¿”å›ä¸€ä¸ªchannelï¼Œåç»­è¢«åˆ›å»ºçš„goroutineé€šè¿‡ç›‘å¬è¿™ä¸ªchannelçš„ä¿¡å·æ¥å®Œæˆé€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>canceleræ¥å£ä¸»è¦ç”¨äºå–æ¶ˆæ–¹æ³•çš„å®ç°ï¼Œå¦‚æœä¸€ä¸ªç¤ºä¾‹æ—¢å®ç°äº†contextæ¥å£åˆå®ç°äº†canceleræ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸ªcontextå°±æ˜¯å¯ä»¥æœ¬å–æ¶ˆçš„ï¼Œæ¯”å¦‚cancelCtx å’ŒtimerCtxã€‚å¦‚æœä»…ä»…åªæ˜¯å®ç°äº†contextæ¥å£ï¼Œè€Œæ²¡æœ‰å®ç°cancelerï¼Œå°±æ˜¯ä¸å¯å–æ¶ˆçš„ï¼Œæ¯”å¦‚emptyCtx å’ŒvalueCtxã€‚</p>
<p><strong>cancelCtx</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">   Context                         <span class="comment">// ç»„åˆäº†ä¸€ä¸ªContext ï¼Œæ‰€ä»¥cancelCtx ä¸€å®šæ˜¯contextæ¥å£çš„ä¸€ä¸ªå®ç°</span></span><br><span class="line">   mu       sync.Mutex             <span class="comment">// äº’æ–¥é”ï¼Œç”¨äºä¿æŠ¤ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µ</span></span><br><span class="line">  <span class="comment">// valueæ˜¯ä¸€ä¸ªchan struct&#123;&#125;ç±»å‹ï¼ŒåŸå­æ“ä½œåšé”ä¼˜åŒ–</span></span><br><span class="line">   done     atomic.Value          </span><br><span class="line">   <span class="comment">// keyæ˜¯ä¸€ä¸ªå–æ¶ˆæ¥å£çš„å®ç°ï¼Œmapå…¶å®å­˜å‚¨çš„æ˜¯å½“å‰canceleræ¥å£çš„å­èŠ‚ç‚¹ï¼Œå½“å‰contextè¢«å–æ¶ˆæ—¶ï¼Œä¼šéå†å­èŠ‚ç‚¹å‘é€å–æ¶ˆä¿¡å·</span></span><br><span class="line">   children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125;  </span><br><span class="line">   err      <span class="type">error</span>                  <span class="comment">// contextè¢«å–æ¶ˆçš„åŸå› </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WithCancelå‡½æ•°åœ¨æ´¾ç”Ÿå¯å–æ¶ˆçš„å­contextçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡propagateCancelå‡½æ•°å…³è”çˆ¶å­contextå¯èƒ½é‡åˆ°çš„å‡ ç§æƒ…å½¢ï¼š</p>
<ol>
<li>çˆ¶contextçš„é€šä¿¡ç®¡é“doneä¸ºç©ºæˆ–è€…å·²ç»è¢«å–æ¶ˆï¼Œå°±ä¸ç”¨å…³è”äº†ï¼Œç›´æ¥å–æ¶ˆå½“å‰å­contextå³å¯</li>
<li>çˆ¶contextå¯ä»¥è¢«å–æ¶ˆï¼Œä½†æ˜¯è¿˜æœªè¢«å–æ¶ˆï¼Œå¹¶ä¸”çˆ¶contextå¯ä»¥æå–å‡ºæ ‡å‡†çš„cancelCtxç»“æ„ï¼Œåˆ™åˆ›å»ºçˆ¶contextçš„children mapï¼Œå°†å½“å‰å­contextåŠ å…¥åˆ°è¿™ä¸ªmapä¸­</li>
<li>çˆ¶contextå¯ä»¥è¢«å–æ¶ˆï¼Œä½†æ˜¯è¿˜æœªè¢«å–æ¶ˆï¼Œçˆ¶contextä¸èƒ½æå–å‡ºæ ‡å‡†çš„cancelCtxç»“æ„ï¼Œæ–°èµ·ä¸€ä¸ªgoroutineç›‘æ§çˆ¶å­contextçš„é€šä¿¡ç®¡é“æœ‰æ²¡æœ‰å–æ¶ˆä¿¡å·</li>
</ol>
<p><strong>timerCtx</strong></p>
<p>çˆ¶contextæœªå–æ¶ˆçš„æƒ…å†µä¸‹ï¼Œåœ¨åˆ›å»ºtimerCtxçš„æ—¶å€™æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<p>è®¾ç½®çš„æˆªæ­¢æ—¶é—´æ™šäºçˆ¶contextçš„æˆªæ­¢æ—¶é—´ï¼Œåˆ™ä¸ä¼šåˆ›å»ºtimerCtxï¼Œä¼šç›´æ¥åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„contextï¼Œå› ä¸ºçˆ¶contextçš„æˆªæ­¢æ—¶é—´æ›´æ—©ï¼Œä¼šå…ˆè¢«å–æ¶ˆï¼Œçˆ¶contextè¢«å–æ¶ˆçš„æ—¶å€™ä¼šçº§è”å–æ¶ˆè¿™ä¸ªå­context</p>
<p>è®¾ç½®çš„æˆªæ­¢æ—¶é—´æ—©äºçˆ¶contextçš„æˆªæ­¢æ—¶é—´ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„timerCtx</p>
<p><strong>valueCtx</strong></p>
<p>ä»–ä¸æ˜¯ç”¨äºçˆ¶å­contextä¹‹é—´çš„å–æ¶ˆçš„ï¼Œè€Œæ˜¯ç”¨äºæ•°æ®å…±äº«ã€‚ä½œç”¨ç±»ä¼¼äºä¸€ä¸ªmapï¼Œä¸è¿‡æ•°æ®çš„å­˜å‚¨å’Œè¯»å–æ˜¯åœ¨ä¸¤ä¸ªcontextï¼Œç”¨äºgoroutineä¹‹é—´çš„æ•°æ®ä¼ é€’ã€‚</p>
<p>valueCtxçš„ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> valueCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    Context</span><br><span class="line">    key, val <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>valueCtxå†…ç½®äº†Contextï¼Œæ‰€ä»¥ä»–ä¹Ÿæ˜¯ä¸€ä¸ªcontextæ¥å£çš„å®ç°ï¼Œä½†æ˜¯å…¶æ²¡æœ‰å®ç°canceleræ¥å£ï¼Œæ‰€ä»¥ä»–ä¸èƒ½ç”¨ä½œcontextçš„å–æ¶ˆï¼ŒvalueCtxå®ç°äº†<code>String()</code>æ–¹æ³•å’Œ<code>Value</code>æ–¹æ³•ï¼Œ<code>String()</code>æ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç»†çœ‹äº†ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹</p>
<p><code>Value</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span></span> Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">   <span class="keyword">if</span> c.key == key &#123;</span><br><span class="line">      <span class="keyword">return</span> c.val</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> c.Context.Value(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯å‘ä¸Šé€’å½’çš„æŸ¥æ‰¾keyæ‰€å¯¹åº”çš„valueï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å› valueï¼Œå¦åˆ™æŸ¥æ‰¾è¯¥contextçš„çˆ¶contextï¼Œä¸€ç›´é¡ºç€ context å‘ä¸Šï¼Œæœ€ç»ˆæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼ˆä¸€èˆ¬æ˜¯ emptyCtxï¼‰ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª nilã€‚</p>
<h3 id="3-7-defer">3.7 defer</h3>
<p>åç¨‹è®°å½•deferä¿¡æ¯ï¼Œå‡½æ•°é€€å‡ºæ—¶è°ƒç”¨<br>
å°†deferä»£ç ç›´æ¥ç¼–è¯‘è¿›å‡½æ•°å°¾</p>
<p>è¿›è¡Œdefer å‡½æ•°è°ƒç”¨çš„æ—¶å€™å…¶å®ä¼šç”Ÿæˆä¸€ä¸ª_deferç»“æ„ï¼Œä¸€ä¸ªå‡½æ•°ä¸­å¯èƒ½æœ‰å¤šæ¬¡deferè°ƒç”¨ï¼Œæ‰€ä»¥ä¼šç”Ÿæˆå¤šä¸ªè¿™æ ·çš„_deferç»“æ„ï¼Œè¿™äº›_deferç»“æ„é“¾å¼å­˜å‚¨æ„æˆä¸€ä¸ª_deferé“¾è¡¨ï¼Œå½“å‰goroutineçš„_deferæŒ‡å‘è¿™ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œ</p>
<p>_defer çš„ç»“æ„å®šä¹‰åœ¨src/src/runtime/runtime2.goä¸­ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> _defer <span class="keyword">struct</span> &#123;</span><br><span class="line">   started <span class="type">bool</span>   <span class="comment">// æ ‡å¿—ä½ï¼Œæ ‡è¯†deferå‡½æ•°æ˜¯å¦å·²ç»å¼€å§‹æ‰§è¡Œ,é»˜è®¤ä¸ºfalse</span></span><br><span class="line">   heap    <span class="type">bool</span>   <span class="comment">// æ ‡è®°ä½ï¼Œæ ‡å¿—å½“å‰deferç»“æ„æ˜¯å¦æ˜¯åˆ†é…åœ¨å †ä¸Š</span></span><br><span class="line">   openDefer <span class="type">bool</span>  <span class="comment">// æ ‡è®°ä½ï¼Œæ ‡è¯†å½“å‰deferæ˜¯å¦ä»¥å¼€æ”¾ç¼–ç çš„æ–¹å¼å®ç°</span></span><br><span class="line">   sp        <span class="type">uintptr</span> <span class="comment">// è°ƒç”¨æ–¹çš„spå¯„å­˜å™¨æŒ‡é’ˆï¼Œå³æ ˆæŒ‡é’ˆ</span></span><br><span class="line">   pc        <span class="type">uintptr</span> <span class="comment">// è°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨æŒ‡é’ˆ</span></span><br><span class="line">   fn        <span class="function"><span class="keyword">func</span><span class="params">()</span></span>  <span class="comment">// deferæ³¨å†Œçš„å»¶è¿Ÿæ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">   _panic    *_panic <span class="comment">// æ ‡è¯†æ˜¯å¦panicæ—¶è§¦å‘ï¼Œépanicè§¦å‘æ—¶ï¼Œä¸ºnil</span></span><br><span class="line">   link      *_defer <span class="comment">// deferé“¾è¡¨</span></span><br><span class="line">   fd   unsafe.Pointer <span class="comment">// deferè°ƒç”¨çš„ç›¸å…³å‚æ•°</span></span><br><span class="line">   varp <span class="type">uintptr</span>        <span class="comment">// value of varp for the stack frame</span></span><br><span class="line">   framepc <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>deferæœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼Œåœ¨åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ä»¥åŠä½¿ç”¨å¼€æ”¾ç¼–ç çš„æ–¹å¼ã€‚ä¼šä¼˜å…ˆä½¿ç”¨å†…è”æ–¹å¼ï¼Œå½“å†…è”ä¸æ»¡è¶³ï¼Œä¸”æ²¡æœ‰å‘ç”Ÿå†…å­˜é€ƒé€¸çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ ˆåˆ†é…çš„æ–¹å¼ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½ä¸ç¬¦åˆçš„æƒ…å†µä¸‹åœ¨ä½¿ç”¨å¯¹åˆ†é…ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯æå‡æ€§èƒ½ã€‚</p>
<p><strong>å †ä¸Šdeferçš„åˆ›å»º</strong>æ€æƒ³å€ŸåŠ©äº†å†…å­˜å¤ç”¨ï¼Œç”¨åˆ°äº†å†…å­˜æ± çš„æ€æƒ³ï¼Œåˆ›å»ºdeferçš„è¿‡ç¨‹æ˜¯ï¼šä¼˜å…ˆåœ¨pçš„æœ¬åœ°å’Œå…¨å±€çš„deferç¼“å­˜æ± é‡Œæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„deferç»“æ„è¿”å›ï¼Œæ‰¾ä¸åˆ°åœ¨å»å †ä¸Šåˆ›å»º</p>
<p>åœ¨g1.14ä¹‹åï¼Œgoä¼šä¼˜å…ˆé‡‡ç”¨å†…è”çš„æ–¹å¼å¤„ç†deferå‡½æ•°è°ƒç”¨ï¼ˆå¼€æ”¾ç¼–ç æ³•ï¼‰ï¼Œä½†æ˜¯éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>buildç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰è®¾ç½®-N</li>
<li>defer å‡½æ•°ä¸ªæ•°æ²¡æœ‰è¶…è¿‡ 8 ä¸ª</li>
<li>deferæ‰€åœ¨å‡½æ•°è¿”å›å€¼ä¸ªæ•°å’Œdeferå‡½æ•°ä¸ªæ•°ä¹˜ç§¯ä¸è¶…è¿‡15</li>
<li>deferæ²¡æœ‰å‡ºç°åœ¨å¾ªç¯è¯­å¥ä¸­æ—¶</li>
</ul>
<p><strong>deferå‡½æ•°æ‰§è¡Œ</strong></p>
<p>æ€»ç»“ï¼š</p>
<ol>
<li>é‡åˆ°deferå…³é”®å­—ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæ³¨å†Œdeferå‡½æ•°çš„æ—¶å€™æ’å…¥<code>deferproc()</code>å‡½æ•°æˆ–è€…<code>deferprocStack</code>å‡½æ•°ï¼Œåœ¨returnä¹‹å‰æ’å…¥deferreturn()å‡½æ•°</li>
<li>deferå‡½æ•°çš„æ‰§è¡Œé¡ºåºæ˜¯LIFOçš„ï¼Œå› ä¸ºæ¯æ¬¡åˆ›å»ºçš„deferç»“æ„éƒ½æ˜¯æ’å…¥åˆ°goroutineçš„deferé“¾è¡¨è¡¨å¤´</li>
<li>deferç»“æ„çš„æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼Œå †ä¸Šåˆ†é…ï¼Œæ ˆä¸Šåˆ†é…è¿˜æœ‰å†…è”å®ç°</li>
</ol>
<h3 id="3-8-interface">3.8 interface</h3>
<h2 id="4-åç¨‹è°ƒåº¦">4. åç¨‹è°ƒåº¦</h2>
<p>ä¼ ç»Ÿå¤šçº¿ç¨‹çš„é—®é¢˜</p>
<p>çº¿ç¨‹éœ€è¦åœ¨å†…æ ¸æ€è¿è¡Œï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¼šé¢‘ç¹çš„é€ æˆå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ï¼Œé€ æˆæ€§èƒ½æµªè´¹ã€‚</p>
<p>GMPæ¨¡å‹</p>
<p>ä¸ºäº†è§£å†³ä¼ ç»Ÿå†…æ ¸çº§çš„çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯å¼€é”€è¾ƒå¤§çš„é—®é¢˜ï¼ŒGo è¯­è¨€å°†çº¿ç¨‹åˆ†ä¸ºäº†ä¸¤ç§ç±»å‹ï¼šå†…æ ¸çº§çº¿ç¨‹ M ï¼ˆMachineï¼‰ï¼Œè½»é‡çº§çš„ç”¨æˆ·æ€çš„åç¨‹ Goroutineï¼š</p>
<p><strong>M</strong>ï¼š Machineçš„ç¼©å†™ï¼Œä»£è¡¨äº†å†…æ ¸çº¿ç¨‹ OS Threadï¼ŒCPUè°ƒåº¦çš„åŸºæœ¬å•å…ƒï¼›</p>
<p><strong>G</strong>ï¼š Goroutineçš„ç¼©å†™ï¼Œç”¨æˆ·æ€ã€è½»é‡çº§çš„åç¨‹ï¼Œä¸€ä¸ª G ä»£è¡¨äº†å¯¹ä¸€æ®µéœ€è¦è¢«æ‰§è¡Œçš„ Go è¯­è¨€ç¨‹åºçš„å°è£…ï¼›æ¯ä¸ª Goroutine éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆå­˜æ”¾è‡ªå·±ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼›åˆ†é…çš„æ ˆå¤§å° 2KBï¼Œå¯ä»¥æŒ‰éœ€æ‰©ç¼©å®¹ï¼›</p>
<p><strong>P</strong>ï¼šProcessorçš„ç¼©å†™ï¼Œä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿçš„å¤„ç†å™¨ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªå±€éƒ¨çš„å¯è¿è¡Œçš„ G é˜Ÿåˆ—ï¼Œå¯ä»¥é€šè¿‡ CAS çš„æ–¹å¼æ— é”è®¿é—®ï¼Œå·¥ä½œçº¿ç¨‹ M ä¼˜å…ˆä½¿ç”¨è‡ªå·±çš„å±€éƒ¨è¿è¡Œé˜Ÿåˆ—ä¸­çš„ Gï¼Œåªæœ‰å¿…è¦æ—¶æ‰ä¼šå»è®¿é—®å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œè¿™å¤§å¤§å‡å°‘äº†é”å†²çªï¼Œæé«˜äº†å¤§é‡ G çš„å¹¶å‘æ€§ã€‚æ¯ä¸ª G è¦æƒ³çœŸæ­£è¿è¡Œèµ·æ¥ï¼Œé¦–å…ˆéœ€è¦è¢«åˆ†é…ä¸€ä¸ª Pã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/13/13fa19fc71534492b2be543b3bbef704" alt=""></p>
<p>ä¸ºä»€ä¹ˆä¸ç›´æ¥å°†æœ¬åœ°é˜Ÿåˆ—æ”¾åœ¨ M ä¸Šã€è€Œæ˜¯è¦æ”¾åœ¨ P ä¸Šå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹ M é˜»å¡ï¼ˆå¯èƒ½æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ– IOè¯·æ±‚ï¼‰çš„æ—¶å€™ï¼Œå¯ä»¥å°†å’Œå®ƒç»‘å®šçš„ P ä¸Šçš„ G è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹ M å»æ‰§è¡Œï¼Œå¦‚æœç›´æ¥æŠŠå¯è¿è¡Œ G ç»„æˆçš„æœ¬åœ°é˜Ÿåˆ—ç»‘å®šåˆ° Mï¼Œåˆ™ä¸‡ä¸€å½“å‰ M é˜»å¡ï¼Œå®ƒæ‹¥æœ‰çš„ G å°±ä¸èƒ½ç»™åˆ°å…¶ä»– M å»æ‰§è¡Œäº†ã€‚</p>
<p>åŸºäº GMP æ¨¡å‹çš„ Go è°ƒåº¦å™¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p>
<ol>
<li><strong>å°½å¯èƒ½å¤ç”¨çº¿ç¨‹ M</strong>ï¼šé¿å…é¢‘ç¹çš„çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯ï¼›</li>
<li><strong>åˆ©ç”¨å¤šæ ¸å¹¶è¡Œèƒ½åŠ›</strong>ï¼šé™åˆ¶åŒæ—¶è¿è¡Œï¼ˆä¸åŒ…å«é˜»å¡ï¼‰çš„ M çº¿ç¨‹æ•°ä¸º Nï¼ŒN ç­‰äº CPU çš„æ ¸å¿ƒæ•°ç›®ï¼Œè¿™é‡Œé€šè¿‡è®¾ç½® P å¤„ç†å™¨çš„ä¸ªæ•°ä¸º GOMAXPROCS æ¥ä¿è¯ï¼ŒGOMAXPROCS ä¸€èˆ¬ä¸º CPU æ ¸æ•°ï¼Œå› ä¸º M å’Œ P æ˜¯ä¸€ä¸€ç»‘å®šçš„ï¼Œæ²¡æœ‰æ‰¾åˆ° P çš„ M ä¼šæ”¾å…¥ç©ºé—² M åˆ—è¡¨ï¼Œæ²¡æœ‰æ‰¾åˆ° M çš„ P ä¹Ÿä¼šæ”¾å…¥ç©ºé—² P åˆ—è¡¨ï¼›</li>
<li><strong>Work Stealing ä»»åŠ¡çªƒå–æœºåˆ¶</strong>ï¼šM ä¼˜å…ˆæ‰§è¡Œå…¶æ‰€ç»‘å®šçš„ P çš„æœ¬åœ°é˜Ÿåˆ—çš„ Gï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå¯ä»¥ä»å…¨å±€é˜Ÿåˆ—è·å– G è¿è¡Œï¼Œä¹Ÿå¯ä»¥ä»å…¶ä»– M å·å– G æ¥è¿è¡Œï¼›ä¸ºäº†æé«˜å¹¶å‘æ‰§è¡Œçš„æ•ˆç‡ï¼ŒM å¯ä»¥ä»å…¶ä»– M ç»‘å®šçš„ P çš„è¿è¡Œé˜Ÿåˆ—å·å– G æ‰§è¡Œï¼Œè¿™ç§ GMP è°ƒåº¦æ¨¡å‹ä¹Ÿå«**ä»»åŠ¡çªƒå–è°ƒåº¦æ¨¡å‹ï¼Œ**è¿™é‡Œï¼Œä»»åŠ¡å°±æ˜¯æŒ‡ Gï¼›</li>
<li><strong>Hand Off äº¤æ¥æœºåˆ¶</strong>ï¼šM é˜»å¡ï¼Œä¼šå°† M ä¸Š P çš„è¿è¡Œé˜Ÿåˆ—äº¤ç»™å…¶ä»– M æ‰§è¡Œï¼Œäº¤æ¥æ•ˆç‡è¦é«˜ï¼Œæ‰èƒ½æé«˜ Go ç¨‹åºæ•´ä½“çš„å¹¶å‘åº¦ï¼›</li>
<li><strong>åŸºäºåä½œçš„æŠ¢å æœºåˆ¶</strong>ï¼šæ¯ä¸ªçœŸæ­£è¿è¡Œçš„Gï¼Œå¦‚æœä¸è¢«æ‰“æ–­ï¼Œå°†ä¼šä¸€ç›´è¿è¡Œä¸‹å»ï¼Œä¸ºäº†ä¿è¯å…¬å¹³ï¼Œé˜²æ­¢æ–°åˆ›å»ºçš„ G ä¸€ç›´è·å–ä¸åˆ° M æ‰§è¡Œé€ æˆé¥¥é¥¿é—®é¢˜ï¼ŒGo ç¨‹åºä¼šä¿è¯æ¯ä¸ª G è¿è¡Œ10ms å°±è¦è®©å‡º Mï¼Œäº¤ç»™å…¶ä»– G å»æ‰§è¡Œï¼›</li>
<li><strong>åŸºäºä¿¡å·çš„çœŸæŠ¢å æœºåˆ¶</strong>ï¼šå°½ç®¡åŸºäºåä½œçš„æŠ¢å æœºåˆ¶èƒ½å¤Ÿç¼“è§£é•¿æ—¶é—´ GC å¯¼è‡´æ•´ä¸ªç¨‹åºæ— æ³•å·¥ä½œå’Œå¤§å¤šæ•° Goroutine é¥¥é¥¿é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒGoè°ƒåº¦å™¨æœ‰æ— æ³•è¢«æŠ¢å çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼Œfor å¾ªç¯æˆ–è€…åƒåœ¾å›æ”¶é•¿æ—¶é—´å ç”¨çº¿ç¨‹ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ Go1.14 å¼•å…¥äº†åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦æœºåˆ¶ï¼Œèƒ½å¤Ÿè§£å†³ GC åƒåœ¾å›æ”¶å’Œæ ˆæ‰«ææ—¶å­˜åœ¨çš„é—®é¢˜ã€‚</li>
</ol>
<p>å…¶ä¸­Gä¸»è¦çš„å…­ç§çŠ¶æ€æ˜¯ï¼š</p>
<p>â€‹        Gidleï¼šG è¢«åˆ›å»ºä½†è¿˜æœªå®Œå…¨è¢«åˆå§‹åŒ–ï¼›</p>
<p>â€‹        Grunnableï¼šå½“å‰ G ä¸ºå¯è¿è¡Œçš„ï¼Œæ­£åœ¨ç­‰å¾…è¢«è¿è¡Œï¼›</p>
<p>â€‹        Grunningï¼šå½“å‰ G æ­£åœ¨è¢«è¿è¡Œï¼›</p>
<p>â€‹        Gsyscallï¼šå½“å‰ G æ­£åœ¨è¢«ç³»ç»Ÿè°ƒç”¨ï¼›</p>
<p>â€‹        Gwaitingï¼šå½“å‰ G æ­£åœ¨å› æŸä¸ªåŸå› è€Œç­‰å¾…ï¼›</p>
<p>â€‹        Gdeadï¼šå½“å‰ G å®Œæˆäº†è¿è¡Œï¼›</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/13/f53c0b007bb8419197f073081ed7d405" alt=""></p>
<p>M å¹¶æ²¡æœ‰åƒ G å’Œ P ä¸€æ ·çš„çŠ¶æ€æ ‡è®°, ä½†å¯ä»¥è®¤ä¸ºä¸€ä¸ª M æœ‰ä»¥ä¸‹çš„çŠ¶æ€:</p>
<p>â€‹        <strong>è‡ªæ—‹ä¸­(spinning)</strong>: M æ­£åœ¨ä»è¿è¡Œé˜Ÿåˆ—è·å– G, è¿™æ—¶å€™ M ä¼šæ‹¥æœ‰ä¸€ä¸ª Pï¼›</p>
<p>â€‹        <strong>æ‰§è¡Œgoä»£ç ä¸­</strong>: M æ­£åœ¨æ‰§è¡Œgoä»£ç , è¿™æ—¶å€™ M ä¼šæ‹¥æœ‰ä¸€ä¸ª Pï¼›</p>
<p>â€‹        <strong>æ‰§è¡ŒåŸç”Ÿä»£ç ä¸­</strong>: M æ­£åœ¨æ‰§è¡ŒåŸç”Ÿä»£ç æˆ–è€…é˜»å¡çš„syscall, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰Pï¼›</p>
<p>â€‹        <strong>ä¼‘çœ ä¸­</strong>: M å‘ç°æ— å¾…è¿è¡Œçš„ G æ—¶ä¼šè¿›å…¥ä¼‘çœ , å¹¶æ·»åŠ åˆ°ç©ºé—² M é“¾è¡¨ä¸­, è¿™æ—¶ M å¹¶ä¸æ‹¥æœ‰ Pã€‚</p>
<p>P ç»“æ„ä½“ä¸­çš„çŠ¶æ€ status å­—æ®µä¼šæ˜¯ä»¥ä¸‹äº”ç§ä¸­çš„ä¸€ç§ï¼š</p>
<p>â€‹        _Pidleï¼šP æ²¡æœ‰è¿è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨ï¼Œè¢«ç©ºé—²é˜Ÿåˆ—æˆ–è€…æ”¹å˜å…¶çŠ¶æ€çš„ç»“æ„æŒæœ‰ï¼Œè¿è¡Œé˜Ÿåˆ—ä¸ºç©ºï¼›</p>
<p>â€‹        _Prunningï¼šè¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå¹¶ä¸”æ­£åœ¨æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨ï¼›</p>
<p>â€‹        _Psyscallï¼šæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå½“å‰çº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼›</p>
<p>â€‹        _Pgcstopï¼šè¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå½“å‰å¤„ç†å™¨ç”±äºåƒåœ¾å›æ”¶è¢«åœæ­¢ï¼›</p>
<p>â€‹        _Pdeadï¼šå½“å‰ P å·²ç»ä¸è¢«ä½¿ç”¨ï¼›</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/13/5b3d6a9698dd4a1fb925585dfa1c5921" alt=""></p>
<p><strong>schedt</strong></p>
<p>è°ƒåº¦å™¨çš„schedtç»“æ„ä½“å­˜å‚¨äº†å…¨å±€çš„ G é˜Ÿåˆ—ï¼Œç©ºé—²çš„ M åˆ—è¡¨å’Œ P åˆ—è¡¨</p>
<h2 id="5-åƒåœ¾å›æ”¶">5. åƒåœ¾å›æ”¶</h2>
<p><strong>gcè§¦å‘</strong></p>
<ul>
<li>åŸºäºæ—¶é—´çš„GCè§¦å‘ï¼šGolangçš„GCä¼šå‘¨æœŸæ€§åœ°è¿›è¡Œè‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œè¿™æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘æ–¹å¼ã€‚åœ¨Golang 1.18ä¸­ï¼ŒGCçš„é»˜è®¤å‘¨æœŸä¸º2åˆ†é’Ÿï¼Œå¯ä»¥é€šè¿‡<code>debug.SetGCPercent()</code>å‡½æ•°ä¿®æ”¹è§¦å‘æ¡ä»¶ã€‚</li>
<li>åŸºäºå†…å­˜åˆ†é…é‡çš„GCè§¦å‘ï¼šGolangçš„GCè¿˜å¯ä»¥åŸºäºå†…å­˜åˆ†é…é‡è¿›è¡Œè§¦å‘ã€‚åœ¨Golang 1.18ä¸­ï¼Œå½“ç¨‹åºåˆ†é…çš„å†…å­˜é‡è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘åƒåœ¾å›æ”¶ã€‚é˜ˆå€¼çš„å¤§å°å¯ä»¥é€šè¿‡<code>debug.SetGCPercent()</code>å‡½æ•°è¿›è¡Œè°ƒæ•´ã€‚</li>
<li>æ‰‹åŠ¨è§¦å‘GCï¼šGolangè¿˜æä¾›äº†æ‰‹åŠ¨è§¦å‘GCçš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡<code>runtime.GC()</code>å‡½æ•°å¼ºåˆ¶è¿›è¡Œåƒåœ¾å›æ”¶ã€‚è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºéœ€è¦ä¸¥æ ¼æ§åˆ¶å†…å­˜ä½¿ç”¨æƒ…å†µçš„åœºæ™¯ã€‚</li>
</ul>
<p><strong>ä¸‰è‰²æ ‡è®°æ³•ä»‹ç»</strong></p>
<p>ç¨‹åºä¸­çš„å¯¹è±¡åˆ†ä¸ºç™½è‰²ã€ç°è‰²å’Œé»‘è‰²ä¸‰ç±»ï¼š</p>
<ul>
<li>ç™½è‰²ï¼šæ½œåœ¨çš„åƒåœ¾ï¼Œæœªè¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œåœ¨å›æ”¶å¼€å§‹é˜¶æ®µï¼Œæ‰€æœ‰å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸ºç™½è‰²ï¼›å›æ”¶ç»“æŸåï¼Œç™½è‰²å¯¹è±¡å‡ä¸å¯è¾¾ï¼Œå†…å­˜ä¼šè¢«é‡Šæ”¾</li>
<li>ç°è‰²ï¼šæ´»è·ƒçš„å¯¹è±¡ï¼Œå·²è¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®åˆ°ï¼Œä½†å­˜åœ¨æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¤–éƒ¨æŒ‡é’ˆï¼Œåƒåœ¾æ”¶é›†å™¨éœ€è¦ç»§ç»­æ‰«æå…¶å­å¯¹è±¡</li>
<li>é»‘è‰²ï¼šæ´»è·ƒçš„å¯¹è±¡ï¼Œå·²è¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®åˆ°ï¼Œå…¶æ‰€æœ‰å­—æ®µéƒ½å·²è¢«æ‰«æ</li>
</ul>
<p>åœ¨ä¸æ‰§è¡ŒSTWæ—¶ï¼Œæ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ä¸‹ä¼šç ´ååƒåœ¾æ”¶é›†å™¨çš„æ­£ç¡®æ€§ï¼š</p>
<ul>
<li>æ¡ä»¶1ï¼šæŸä¸ªé»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡</li>
<li>æ¡ä»¶2ï¼šä»ç°è‰²å¯¹è±¡å‡ºå‘ï¼Œåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„ã€æœªç»è®¿é—®è¿‡çš„è·¯å¾„é­åˆ°ç ´å</li>
</ul>
<p><strong>å¼ºä¸‰è‰²ä¸å˜æ€§å’Œå¼±ä¸‰è‰²ä¸å˜æ€§</strong></p>
<ul>
<li>å¼ºä¸‰è‰²ä¸å˜æ€§ï¼šé»‘è‰²å¯¹è±¡ä¸ä¼šæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåªä¼šæŒ‡å‘ç°è‰²å¯¹è±¡æˆ–é»‘è‰²å¯¹è±¡</li>
<li>å¼±ä¸‰è‰²ä¸å˜æ€§ï¼šé»‘è‰²å¯¹è±¡æŒ‡å‘çš„ç™½è‰²å¯¹è±¡ï¼Œå¿…é¡»åŒ…å«ä¸€æ¡ä»ç°è‰²å¯¹è±¡ç»ç”±å¤šä¸ªç™½è‰²å¯¹è±¡çš„å¯è¾¾è·¯å¾„</li>
</ul>
<p>å¼ºä¸‰è‰²ä¸å˜æ€§å’Œå¼±ä¸‰è‰²ä¸å˜æ€§å°±æ˜¯ä¸ºäº†ç ´åä¸Šé¢çš„æ¡ä»¶1ã€2</p>
<p><strong>å±éšœæŠ€æœ¯</strong></p>
<p><strong>æ’å…¥å†™å±éšœ</strong></p>
<blockquote>
<p>åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨ä¸€ä¸ªç™½è‰²å¯¹è±¡æ—¶ï¼Œå°†ç™½è‰²å¯¹è±¡æ”¹ä¸ºç°è‰²</p>
</blockquote>
<p>åœ¨å¯¹è±¡Aå¼•ç”¨å¯¹è±¡Bæ—¶ï¼Œå¯¹è±¡Bè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œæ»¡è¶³å¼ºä¸‰è‰²ä¸å˜æ€§ã€‚</p>
<p>å¯¹è±¡åœ¨å†…å­˜æ§½ä¸­æœ‰ä¸¤ç§ä½ç½®ï¼šæ ˆå’Œå †ã€‚æ ˆç©ºé—´çš„ç‰¹ç‚¹æ˜¯å®¹é‡å°ï¼Œä½†è¦æ±‚å“åº”é€Ÿåº¦å¿«ï¼Œæ‰€ä»¥Goè¯­è¨€æ²¡æœ‰é€‰æ‹©å¯ç”¨æ ˆä¸Šçš„å†™å±éšœæœºåˆ¶ã€‚</p>
<p>ä¸ºäº†é¿å…æ€§èƒ½å¼€é”€ï¼Œæ ˆæ²¡æœ‰å¯ç”¨æ’å…¥å†™å±éšœæœºåˆ¶ï¼Œæ­¤æ—¶å¯èƒ½å­˜åœ¨ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚ä¸ºäº†é¿å…å¯¹è±¡è¢«â€œè¯¯åˆ â€ï¼Œéœ€è¦å¯¹æ ˆé‡æ–°æ‰«æã€‚è€ƒè™‘åˆ°é‡æ–°æ‰«ææ—¶ï¼Œå¯èƒ½ä¼šä¸€ç›´äº§ç”Ÿæ–°çš„ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨ï¼Œæ‰€ä»¥å¯åŠ¨STWç›´åˆ°æ ˆç©ºé—´çš„ä¸‰è‰²æ ‡è®°ç»“æŸï¼Œä¸”é‡æ–°æ‰«ææ—¶ä¼šæŠŠæ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨ç½®ç™½ã€‚</p>
<p><strong>åˆ é™¤å†™å±éšœ</strong></p>
<blockquote>
<p>åœ¨ç°è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡æ—¶ï¼Œç”¨æˆ·å°†è¿™ä¸ªå¼•ç”¨å…³ç³»åˆ é™¤ï¼Œè§¦å‘å†™å±éšœä»ç„¶æ ‡è®°è¢«åˆ é™¤çš„å¯¹è±¡ä¸ºç°è‰²</p>
</blockquote>
<p>è¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç°è‰²æˆ–ç™½è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œæ»¡è¶³å¼±ä¸‰è‰²ä¸å˜æ€§ã€‚</p>
<p>åˆ é™¤å†™å±éšœçš„ä¼˜åŠ¿åœ¨äºæ ‡è®°é˜¶æ®µç»“æŸåèƒ½å¤Ÿå‡†ç¡®å›æ”¶ä¸éœ€è¦çš„å†…å­˜ï¼Œä¸éœ€è¦é‡æ–°æ‰«æã€‚ä½†æ˜¯å®ƒçš„å›æ”¶ç²¾åº¦ä½ï¼Œä¸€ä¸ªå¯¹è±¡çš„æœ€åä¸€ä¸ªå¼•ç”¨æŒ‡é’ˆå³ä½¿è¢«åˆ é™¤äº†ï¼Œè¯¥å¯¹è±¡ä»èƒ½å¤Ÿåœ¨æœ¬è½®åƒåœ¾å›æ”¶å­˜åœ¨ï¼Œéœ€è¦ç­‰åˆ°ä¸‹ä¸€è½®GCæ‰èƒ½è¢«æ¸…é™¤ã€‚</p>
<p><strong>æ··åˆå†™å±éšœ</strong></p>
<blockquote>
<p>go v1.8é‡‡ç”¨çš„å°±æ˜¯ä¸‰è‰²æ ‡è®°+æ··åˆå†™å±éšœ</p>
</blockquote>
<p>1ã€GCå¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æï¼Œå¯è¾¾å¯¹è±¡å…¨éƒ¨å¹¶æ ‡è®°ä¸ºé»‘è‰²ï¼ˆä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€STW)<br>
2ã€GCæœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²<br>
3ã€è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²<br>
4ã€è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</p>
<p>æ··åˆå†™å±éšœå°±æ˜¯å»¶è¿Ÿåˆ°ç¬¬äºŒæ¬¡GCåˆ é™¤</p>
<p>æ—¢ç„¶Goè¯­è¨€å…·æœ‰åƒåœ¾æ”¶é›†å™¨ï¼Œæ˜¯ä¸æ˜¯å°±ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²äº†ï¼Ÿ</p>
<p>å…¶å®ï¼Œåœ¨å…·æœ‰GCçš„è¯­è¨€ä¸­ï¼Œå†…å­˜æ³„éœ²ï¼Œç”¨æ›´ä¸¥è°¨çš„è¯æ¥è¯´åº”è¯¥æ˜¯ï¼šé¢„æœŸèƒ½å¤Ÿå¾ˆå¿«è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œç”±äºé™„ç€åœ¨é•¿æœŸå­˜æ´»çš„å†…å­˜ã€æˆ–ç”Ÿå‘½æœŸè¢«æ„å¤–å»¶é•¿ï¼Œå¯¼è‡´é•¿æ—¶é—´å¾—ä¸åˆ°å›æ”¶ã€‚æ¯”å¦‚ï¼š</p>
<p>ï¼ˆ1ï¼‰é¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿçš„é‡Šæ”¾</p>
<p>å½“æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡æ—¶ï¼Œå¯èƒ½ä¸ç»æ„é—´å°†æŸä¸ªå˜é‡é™„ç€åœ¨å…¶ä¸Šï¼Œä¸”å¿½ç•¥é‡Šæ”¾è¯¥å˜é‡ï¼Œåˆ™å…¶å†…å­˜æ°¸è¿œä¸ä¼šå¾—åˆ°é‡Šæ”¾ã€‚</p>
<p>ï¼ˆ2ï¼‰Goroutineæ³„éœ²</p>
<p>Goroutineä½œä¸ºä¸€ç§é€»è¾‘ä¸Šç†è§£çš„è½»é‡çº§çº¿ç¨‹ï¼Œéœ€è¦ç»´æŠ¤æ‰§è¡Œç”¨æˆ·ä»£ç çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…å­˜æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œè€Œè¿™äº›å†…å­˜åœ¨ç›®å‰ç‰ˆæœ¬çš„Goè¯­è¨€æ˜¯ä¸ä¼šè¢«é‡Šæ”¾çš„ã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ªç¨‹åºæŒç»­ä¸æ–­åœ°äº§ç”Ÿæ–°çš„Goroutineã€ä¸”ä¸ç»“æŸå·²åˆ›å»ºçš„Goroutineå¹¶å¤ç”¨è¿™éƒ¨åˆ†å†…å­˜ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„éœ²çš„ç°è±¡ã€‚</p>
<h2 id="6-å†…å­˜ç®¡ç†">6. å†…å­˜ç®¡ç†</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/14/bfd397f2bdd648edb4db7558aa3dafb4" alt=""></p>
<p>golangå†…å­˜ä¸­çš„å¯¹è±¡åˆ†ä¸ºTinyã€smallã€largeï¼ŒTinyå¯¹è±¡æŒ‡å¤§å°åœ¨1Byteåˆ°16Byteä¹‹é—´å¹¶ä¸”ä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ã€‚å°å¯¹è±¡å’Œå¤§å¯¹è±¡åªç”¨å¤§å°åˆ’å®šï¼Œæ— å…¶ä»–åŒºåˆ†ï¼Œå…¶ä¸­å°å¯¹è±¡å¤§å°åœ¨16Byteåˆ°32KBä¹‹é—´ï¼Œå¤§å¯¹è±¡å¤§å°å¤§äº32KBã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.vika.cn/space/2023/04/14/fd99c4e3d2664967b9ee439203942e66" alt=""></p>
<p><strong>ä¸ºå¯¹è±¡å¯»æ‰¾span</strong> å¯»æ‰¾spançš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¡ç®—å¯¹è±¡æ‰€éœ€å†…å­˜å¤§å°size</li>
<li>æ ¹æ®sizeåˆ°size classæ˜ å°„ï¼Œè®¡ç®—å‡ºæ‰€éœ€çš„size class</li>
<li>æ ¹æ®size classå’Œå¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆè®¡ç®—å‡ºspan class</li>
<li>è·å–è¯¥span classæŒ‡å‘çš„span</li>
</ol>
<p>ä»¥åˆ†é…ä¸€ä¸ªåŒ…å«æŒ‡é’ˆå¤§å°ä¸º20Byteçš„å¯¹è±¡ä¸ºä¾‹ï¼Œæ ¹æ®æ˜ å°„è¡¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class  bytes/obj  bytes/span  objects  tail waste  max waste</span></span><br><span class="line"><span class="comment">//     1          8        8192     1024           0     87.50%</span></span><br><span class="line"><span class="comment">//     2         16        8192      512           0     43.75%</span></span><br><span class="line"><span class="comment">//     3         32        8192      256           0     46.88%</span></span><br></pre></td></tr></table></figure>
<p>size class 3ï¼Œå®ƒçš„å¯¹è±¡å¤§å°èŒƒå›´æ˜¯(16,32]Byteï¼Œ20Byteåˆšå¥½åœ¨æ­¤åŒºé—´ï¼Œæ‰€ä»¥æ­¤å¯¹è±¡çš„size classä¸º3ï¼ŒSize classåˆ°span classçš„è®¡ç®—å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// noscanä¸ºfalseä»£è¡¨å¯¹è±¡åŒ…å«æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSpanClass</span><span class="params">(sizeclass <span class="type">uint8</span>, noscan <span class="type">bool</span>)</span></span> spanClass &#123;</span><br><span class="line">    <span class="keyword">return</span> spanClass(sizeclass&lt;&lt;<span class="number">1</span>) | spanClass(bool2int(noscan))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œå¯¹åº”çš„span classä¸ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">span class = <span class="number">3</span> &lt;&lt; <span class="number">1</span> | <span class="number">0</span> = <span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¯¥å¯¹è±¡éœ€è¦çš„æ˜¯span class 7æŒ‡å‘çš„spanï¼Œè‡ªæ­¤ï¼Œå°å¯¹è±¡å†…å­˜åˆ†é…å®Œæˆã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//from runtime.gomalloc.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sizeclass <span class="type">uint8</span></span><br><span class="line"><span class="comment">//step1: ç¡®å®šè§„æ ¼sizeClass</span></span><br><span class="line"><span class="keyword">if</span> size &lt;= smallSizeMax<span class="number">-8</span> &#123;</span><br><span class="line">    sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]</span><br><span class="line">&#125;</span><br><span class="line">size = <span class="type">uintptr</span>(class_to_size[sizeclass])</span><br><span class="line"><span class="comment">// size classåˆ°span class</span></span><br><span class="line">spc := makeSpanClass(sizeclass, noscan)</span><br><span class="line"><span class="comment">//step2: åˆ†é…å¯¹åº”spanClass çš„ span</span></span><br><span class="line">span = c.alloc[spc]</span><br><span class="line">v := nextFreeFast(span)</span><br><span class="line"><span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">    v, span, shouldhelpgc = c.nextFree(spc)</span><br><span class="line">&#125;</span><br><span class="line">x = unsafe.Pointer(v)</span><br><span class="line"><span class="keyword">if</span> needzero &amp;amp;&amp;amp; span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">    memclrNoHeapPointers(unsafe.Pointer(v), size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§å¯¹è±¡(&gt;32KB)çš„åˆ†é…åˆ™ç®€å•å¤šäº†ï¼Œç›´æ¥åœ¨ mheap ä¸Šè¿›è¡Œåˆ†é…ï¼Œé¦–å…ˆè®¡ç®—å‡ºéœ€è¦çš„å†…å­˜é¡µæ•°å’Œspan classçº§åˆ«ï¼Œç„¶åä¼˜å…ˆä» <code>free</code> ä¸­æœç´¢å¯ç”¨çš„spanï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šä» <code>scav</code> ä¸­æœç´¢å¯ç”¨çš„spanï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å‘OSç”³è¯·å†…å­˜ï¼Œå†é‡æ–°æœç´¢2æ£µæ ‘ï¼Œå¿…ç„¶èƒ½æ‰¾åˆ°spanã€‚å¦‚æœæ‰¾åˆ°çš„spanæ¯”éœ€æ±‚çš„spanå¤§ï¼Œåˆ™æŠŠspanè¿›è¡Œåˆ†å‰²æˆ2ä¸ªspanï¼Œå…¶ä¸­1ä¸ªåˆšå¥½æ˜¯éœ€æ±‚å¤§å°ï¼ŒæŠŠå‰©ä¸‹çš„spanå†åŠ å…¥åˆ° <code>free</code> ä¸­å»ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>golangå­¦ä¹ ç¬”è®°</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://yanhool.github.io/posts/20230411d.html">https://yanhool.github.io/posts/20230411d.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>YanhoolğŸ¥</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2023-04-11</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-04-14</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/golang/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>golang</a></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/20230410d.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">rediså­¦ä¹ ç¬”è®°</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">golangå­¦ä¹ ç¬”è®°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-golang%E5%B9%B6%E5%8F%91"><span class="toc-text">1. golangå¹¶å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1.1 æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Goroutine"><span class="toc-text">1.2 Goroutine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Channel"><span class="toc-text">1.3 Channel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Sync"><span class="toc-text">1.4 Sync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Select"><span class="toc-text">1.5 Select</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-text">1.5.1 IOå¤šè·¯å¤ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-select%E7%94%A8%E6%B3%95"><span class="toc-text">1.5.2 selectç”¨æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-Context"><span class="toc-text">1.6 Context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-text">1.7 å®šæ—¶å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-%E5%8D%8F%E7%A8%8B%E6%B1%A0"><span class="toc-text">1.8 åç¨‹æ± </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-text">2. åŸç†åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%A8%8B%E5%BA%8F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">2.1 ç¨‹åºåˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90"><span class="toc-text">2.2 é€ƒé€¸åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-golang%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">3. golangæ•°æ®ç»“æ„å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-string"><span class="toc-text">3.1 string</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-slice"><span class="toc-text">3.2 slice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-map"><span class="toc-text">3.3 map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-sync-map"><span class="toc-text">3.4 sync.map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-channel"><span class="toc-text">3.5 channel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-context"><span class="toc-text">3.6 context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-defer"><span class="toc-text">3.7 defer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-interface"><span class="toc-text">3.8 interface</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="toc-text">4. åç¨‹è°ƒåº¦</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="toc-text">5. åƒåœ¾å›æ”¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-text">6. å†…å­˜ç®¡ç†</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a href="https://yanhool.github.io/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div id="workboard"></div><p id="ghbdages"></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ§  ç®—æ³•å­¦ä¹ ç¬”è®° (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/c/æºç åˆ†æ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“ æºç åˆ†æç¬”è®°ã€ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/c/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸš€ c++åŸºç¡€ç¬”è®° (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/golang/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¹ golangåŸºç¡€ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/æ•°æ®åº“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’¾ æ•°æ®åº“ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yanhool.github.io/categories/æ‚é¡¹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ æ‚é¡¹ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://yanhool.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230320d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230320d.html&quot;);" href="javascript:void(0);" alt="">çº¢é»‘æ ‘è¯¦è§£</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°çº¢é»‘æ ‘çš„åŸç†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230320d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230410d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230410d.html&quot;);" href="javascript:void(0);" alt="">rediså­¦ä¹ ç¬”è®°</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°redisåŸºç¡€çŸ¥è¯†ç‚¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230410d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230326d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-26</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230326d.html&quot;);" href="javascript:void(0);" alt="">mysqlå­¦ä¹ ç¬”è®°</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°mysqlåŸºç¡€çŸ¥è¯†ç‚¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230326d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20221023d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20221023d.html&quot;);" href="javascript:void(0);" alt="">åŠ¨æ€è§„åˆ’</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»åŠ¨æ€è§„åˆ’çš„å¸¸è§é¢˜å‹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20221023d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230411d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230411d.html&quot;);" href="javascript:void(0);" alt="">golangå­¦ä¹ ç¬”è®°</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°golangåŸºç¡€çŸ¥è¯†ç‚¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230411d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230322d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-22</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230322d.html&quot;);" href="javascript:void(0);" alt="">nignxå†…å­˜æ± æºç åˆ¨æ</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°nignxå†…å­˜ç®¡ç†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230322d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20131023d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20131023d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20131023d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/20230321d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/20230321d.html&quot;);" href="javascript:void(0);" alt="">SGI STLäºŒçº§ç©ºé—´é…ç½®å™¨å­¦ä¹ ç¬”è®°</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡è®²è¿°SGI STLäºŒçº§ç©ºé—´é…ç½®å™¨å­¦ä¹ ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/20230321d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?yanhool",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'yanhool')
    }
  </script><!-- hexo injector body_end end --></body></html>